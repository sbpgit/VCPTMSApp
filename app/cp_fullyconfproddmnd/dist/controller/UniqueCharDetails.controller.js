sap.ui.define(["sap/ui/core/mvc/Controller","cpapp/cpfullyconfproddmnd/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/ui/export/library","sap/ui/export/Spreadsheet"],function(e,t,a,r,i,l,n,s,o){"use strict";var d=s.EdmType;var u,C;return t.extend("cpapp.cpfullyconfproddmnd.controller.UniqueCharDetails",{onInit:function(){C=this;var e;l.show("Unique Characteristics Details");u=C.getOwnerComponent().getModel("oGModel");C.allCharsModel=new a;C.allCharsModel.setSizeLimit(2e3);C.locProdCharModel=new a;C.locProdCharModel.setSizeLimit(2e3);C.weeklyCIRModel=new a;C.weeklyCIRModel.setSizeLimit(2e3);C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");e=sap.ui.core.UIComponent.getRouterFor(this);e.getRoute("RouteUniqChar").attachMatched(this._onRouteMatched,this)},onAfterRendering:function(e){C.handleVisibleRowCountU(0)},onUniqueIdLinkPress:function(e){sap.ui.core.BusyIndicator.show();u=C.getOwnerComponent().getModel("oGModel");C.getModel("CIRModel").callFunction("/getUniqueChars",{method:"GET",urlParameters:{UNIQUE_ID:u.getProperty("/SelectedUniqueId"),PRODUCT_ID:u.getProperty("/SelectedProd"),LOCATION_ID:u.getProperty("/SelectedLoc")},success:function(e){sap.ui.core.BusyIndicator.hide();C.formatUniqueCharsData(e.results)},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error While fetching data")}})},formatUniqueCharsData:function(e){u=C.getOwnerComponent().getModel("oGModel");var t=e;var a={},r={},i=[],l=[];var n=[];var s=[];var o=0,d=0,h=0;var g;var c=true;var I="";var f;var U,v,b,E;var p=u.getProperty("/CIRQtys");var m=[];var D=C.SEL_DATE;C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");if(t.length>0){for(var A=0;A<t.length;A++){a={};if(A===0){n=t[A].CONFIG;a.UNIQUE_CHAR="Characteristic";a.TOTAL=t[A].TOTAL;a.CIRQTY="";i.push(a);a={}}m=[];m=p.filter(function(e){return e["Unique ID"]===t[A].UNIQUE_ID.toString()});if(m.length>0){a.CIRQTY=m[0][D]}else{a.CIRQTY=0}a.UNIQUE_CHAR=t[A].UNIQUE_ID;a.UNIQUE_DESC=t[A].UNIQUE_DESC;a.TOTAL=t[A].TOTAL;i.push(a)}for(var _=0;_<n.length;_++){r={};r["Characteristic"]=[{CHAR_NAME:n[_].CHAR_NAME,CHAR_DESC:n[_].CHAR_DESC}];for(var w=1;w<i.length;w++){s=[];s=t.filter(function(e){return e.UNIQUE_ID===i[w].UNIQUE_CHAR});s=s[0].CONFIG;for(var q=0;q<s.length;q++){I="";if(n[_].CHAR_NAME===s[q].CHAR_NAME&&n[_].CHAR_DESC===s[q].CHAR_DESC&&n[_].CHAR_NUM===s[q].CHAR_NUM){if(n[_].CHARVAL_NUM!==s[q].CHARVAL_NUM){I="sap-icon://sys-cancel-2"}r[i[w].UNIQUE_CHAR]=[{CHAR_VALUE:s[q].CHAR_VALUE,CHARVAL_DESC:s[q].CHARVAL_DESC,CHAR_NUM:s[q].CHAR_NUM,CHARVAL_NUM:s[q].CHARVAL_NUM,CELL_COLOR:I}];break}}}l.push(r);r={}}var y=new sap.ui.model.json.JSONModel;y.setData({rows:l,columns:i});C.oUniqueCharTable.setModel(y);C.oUniqueCharTable.bindColumns("/columns",function(e,t){d=0;o=o+1;g=t.getObject().UNIQUE_CHAR;d=t.getObject().TOTAL;h=t.getObject().CIRQTY;U=g.toString();v=t.getObject().UNIQUE_DESC+" ("+d+")"+" - ("+h+")";if(g==="Characteristic"){b=g+"/0/CHAR_NAME";E=g+"/0/CHAR_DESC";return new sap.ui.table.Column({label:U,template:new sap.m.ObjectIdentifier({title:"{"+E+"}",text:"{"+b+"}"})})}else{if(o>7){c=false}b=g+"/0/CHAR_VALUE";E=g+"/0/CHARVAL_DESC";f=g+"/0/CELL_COLOR";return new sap.ui.table.Column({name:U,label:v,visible:c,template:new sap.m.HBox({alignItems:"Center",justifyContent:"SpaceBetween",items:[new sap.m.ObjectIdentifier({title:"{"+E+"}",text:"{"+b+"}"}),new sap.ui.core.Icon({src:"{"+f+"}",color:"Critical"})]})})}});C.oUniqueCharTable.bindRows("/rows")}},onFilterSelectionChange:function(e){var t;var a=[];var r;t=e.getParameter("selectedItem").getKey();r=C.getView().byId("idUniqueCharDetailsU");a=r.getSelectedItems();switch(t){case"NE":C.getUniqueIdsNESelChars(a);break;case"EQ":C.getUniqueIdsEQSelChars(a);break;default:break}},onCharacteristicSelFinish:function(e){var t=[];var a=[];var r=[];var i="";var l="";var n="";var s=0;var o=[];var d=[];var u=[];var h="";C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");u=C.oUniqueCharTable.getColumns();t=C.allCharsModel.getData().charDetails;r=e.getParameter("selectedItems");if(r.length>0){h=C.getView().byId("_IDGenUSelect").getSelectedKey();switch(h){case"NE":C.getUniqueIdsNESelChars(r);break;case"EQ":C.getUniqueIdsEQSelChars(r);break;default:break}}else{for(var g=0;g<u.length;g++){if(g<7){if(!u[g].getProperty("visible")){u[g].setVisible(true)}}else{u[g].setVisible(false)}}}},getUniqueIdsNESelChars:function(e){var t=[];var a=[];var r="";var i="";var l="";var n=0;var s=[];var o=[];var d=[];var u="";var h="";var g=0;C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");d=C.oUniqueCharTable.getColumns();t=C.allCharsModel.getData().charDetails;var c=t;for(var I=0;I<e.length;I++){i=e[I].getKey().split(":")[0];r=e[I].getKey().split(":")[1];if(s.length>0){const e=s.map(e=>e.UNIQUE_ID);c=t.filter(t=>e.indexOf(t.UNIQUE_ID)!==-1)}s=[];for(var f=0;f<c.length;f++){if(c[f].CHAR_NUM===i&&c[f].CHARVAL_NUM!==r){l=c[f].UNIQUE_ID;if(s.includes(l)===false){s.push({UNIQUE_ID:l})}}}}if(s.length>0){return s}},getUniqueIdsEQSelChars:function(e){var t=[];var a=[];var r="";var i="";var l="";var n=0;var s=[];var o=[];var d=[];var u="";var h=0;var g="";C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");d=C.oUniqueCharTable.getColumns();t=C.allCharsModel.getData().charDetails;var c=t;for(var I=0;I<e.length;I++){i=e[I].getKey().split(":")[0];r=e[I].getKey().split(":")[1];if(s.length>0){const e=s.map(e=>e.UNIQUE_ID);c=t.filter(t=>e.indexOf(t.UNIQUE_ID)!==-1)}s=[];for(var f=0;f<c.length;f++){if(c[f].CHAR_NUM===i&&c[f].CHARVAL_NUM===r){l=c[f].UNIQUE_ID;if(s.includes(l)===false){s.push({UNIQUE_ID:l})}}}}if(s.length>0){return s}},onUniqueIdsFilter:function(){var e=C.oUniqueCharTable.getColumns();var t=C.oUniqueCharTable.getBinding().aIndices;var a=C.oUniqueCharTable.getBinding().oList;var r=[];var i=" ";var l=0;var n="";r=a.filter((e,a)=>t.some(e=>a===e));for(var s=2;s<e.length;s++){i=e[s].getLabel().getText().split(" ");l=0;for(var o=0;o<r.length;o++){l=l+r[o][i[0]]}n=i[0]+" ("+l+")";e[s].setLabel(n)}},onSelectRBCharFilter:function(e){var t=[];var a=e.getSource().getSelectedButton().getText();var l=C.byId("idUniqueIdChars");var n=l.getColumns();var s=[];var o="";var d="";switch(a){case"All":l.getBinding().filter(t);break;case"Matched":for(var u=2;u<7;u++){o=n[u].getName();d=o+"/0/CELL_COLOR";s.push(new r(d,i.EQ,""))}t=new r(s,true);l.getBinding().filter(t);break;case"UnMatched":for(var u=0;u<7;u++){o=n[u].getName();d=o+"/0/CELL_COLOR";s.push(new r(d,i.EQ,"sap-icon://sys-cancel-2"))}t=new r(s,false);l.getBinding().filter(t);break;default:l.getBinding().filter(t);break}},onEQSelectionChange:function(e){var t=[];var a;var r=[];var i="";a=C.getView().byId("idUniqueCharDetailsEQ");t=a.getSelectedItems();for(var n=0;n<t.length;n++){i=t[n].getKey().split(":")[0];if(r.length>0){if(r.includes(i)===true){l.show("Cannot select multiple values for each characteristic!",{width:"25rem"});a.removeSelectedItem(t[n]);break}else{r.push(i)}}else{r.push(i)}}},onNEQSelectionChange:function(e){var t=[];var a;var r=[];var i="";a=C.getView().byId("idUniqueCharDetailsNEQ");t=a.getSelectedItems();for(var n=0;n<t.length;n++){i=t[n].getKey().split(":")[0];if(r.length>0){if(r.includes(i)===true){l.show("Cannot select multiple values for each characteristic!",{width:"25rem"});a.removeSelectedItem(t[n]);break}else{r.push(i)}}else{r.push(i)}}},onFilterData:function(e){var t=[],a=[];var r,i;var l=[],n=[],s=[],o=[],d=[];var u="";var h=0;C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");d=C.oUniqueCharTable.getColumns();r=C.getView().byId("idUniqueCharDetailsEQ");i=C.getView().byId("idUniqueCharDetailsNEQ");t=r.getSelectedItems();a=i.getSelectedItems();if(t.length>0){l=C.getUniqueIdsEQSelChars(t);if(l===undefined){l=[]}}if(a.length>0){n=C.getUniqueIdsNESelChars(a);if(n===undefined){n=[]}}if(l.length>0&&n.length>0){for(var g=2;g<d.length;g++){u=d[g].getName();s=l.filter(function(e){return e.UNIQUE_ID===parseInt(u)});o=n.filter(function(e){return e.UNIQUE_ID===parseInt(u)});if(s.length>0&&o.length>0){h=h+1;if(h>5){d[g].setVisible(false)}else{d[g].setVisible(true)}}else{d[g].setVisible(false)}}}else if(l.length>0&&n.length===0){for(var g=2;g<d.length;g++){u=d[g].getName();s=l.filter(function(e){return e.UNIQUE_ID===parseInt(u)});if(s.length>0){h=h+1;if(h>5){d[g].setVisible(false)}else{d[g].setVisible(true)}}else{d[g].setVisible(false)}}}else if(l.length===0&&n.length>0){for(var g=2;g<d.length;g++){u=d[g].getName();s=n.filter(function(e){return e.UNIQUE_ID===parseInt(u)});if(s.length>0){h=h+1;if(h>5){d[g].setVisible(false)}else{d[g].setVisible(true)}}else{d[g].setVisible(false)}}}else{for(var g=2;g<d.length;g++){u=d[g].getName();h=h+1;if(h>5){d[g].setVisible(false)}else{d[g].setVisible(true)}}}},onChangeHeaderPinStatusU:function(e){if(e.getSource()._bHeaderExpanded===true){C.handleVisibleRowCountU(5)}else{C.handleVisibleRowCountU(0)}},handleVisibleRowCountU:function(e){var t=window.innerHeight;if(t>750&&t<800){C.byId("idUniqueIdChars").setVisibleRowCount(9+e)}else if(t>800&&t<900){C.byId("idUniqueIdChars").setVisibleRowCount(10+e)}else if(t>900&&t<1e3){C.byId("idUniqueIdChars").setVisibleRowCount(12+e)}else if(t>1e3&&t<1100){C.byId("idUniqueIdChars").setVisibleRowCount(14+e)}else{C.byId("idUniqueIdChars").setVisibleRowCount(7+e)}},onResetFilters:function(){var e=[];var t="";var a=0;C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");e=C.oUniqueCharTable.getColumns();C.getView().byId("idUniqueCharDetailsEQ").removeAllSelectedItems();C.getView().byId("idUniqueCharDetailsNEQ").removeAllSelectedItems();for(var r=2;r<e.length;r++){t=e[r].getName();a=a+1;if(a>5){e[r].setVisible(false)}else{e[r].setVisible(true)}}},setWeekDates:function(e){u=C.getOwnerComponent().getModel("oGModel");var t=u.getProperty("/TDates");var a=u.getProperty("/dFrozenHorizonDate");var r={},i=[];var l=false;var n;var s;for(var o=0;o<t.length;o++){r={};n=new Date(t[o].WEEK_DATE);if(t[o].WEEK_DATE.includes("-")===true){r.WEEK_DATE=t[o].WEEK_DATE;if(n>=a){if(l===false){C.SEL_DATE=t[o].WEEK_DATE;l=true}}s=C.getWeekNumber(t[o].WEEK_DATE);r.WEEK_INDEX="W"+s;i.push(r)}}if(i.length>0){C.weeklyCIRModel.setData({weeks:i});C.getView().byId("_IDWeekDtSel").setModel(C.weeklyCIRModel);C.getView().byId("_IDWeekDtSel").setSelectedKey(C.SEL_DATE)}},onChangeWeekDate:function(e){C.SEL_DATE=e.getParameter("selectedItem").getKey();var t=[];var a="";var r="";var i=0;var l=u.getProperty("/CIRQtys");var n=[];var s="";C.oUniqueCharTable=C.getView().byId("idUniqueIdChars");t=C.oUniqueCharTable.getColumns();for(var o=1;o<t.length;o++){a=t[o].getName();r=t[o].getLabel().getText().split(" ");i=0;n=[];n=l.filter(function(e){return e["Unique ID"]===a.toString()});if(n.length>0){i=n[0][C.SEL_DATE]}else{i=0}s=r[0]+" "+r[1]+" - ("+i+")";t[o].setLabel(s)}},_onRouteMatched:function(e){u=C.getOwnerComponent().getModel("oGModel");C.LocationId=u.getProperty("/SelectedLoc");C.ProductId=u.getProperty("/SelectedProd");C.UniqueId=u.getProperty("/SelectedUniqueId");C.aFilteredChars=u.getProperty("/aFilteredChar");C.aAllUniqueChars=u.getProperty("/AllUniqueChars");C.getView().byId("idlocU").setValue(C.LocationId);C.getView().byId("idprodListU").setValue(C.ProductId);C.getView().byId("idUniqueId").setValue(C.UniqueId);C.getView().byId("idUniqueCharDetailsEQ").removeAllSelectedItems();C.getView().byId("idUniqueCharDetailsNEQ").removeAllSelectedItems();C.allCharsModel.setData({charDetails:C.aAllUniqueChars});C.locProdCharModel.setData({charDetails:C.aFilteredChars});C.getView().byId("idUniqueCharDetailsEQ").setModel(C.locProdCharModel);C.getView().byId("idUniqueCharDetailsNEQ").setModel(C.locProdCharModel);C.setWeekDates();C.onUniqueIdLinkPress()}})});