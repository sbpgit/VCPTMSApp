sap.ui.define(["cpappf/cpnodesdetails/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,s,o,i,r,a,d){"use strict";var u,n;return e.extend("cpappf.cpnodesdetails.controller.ItemDetail",{onInit:function(){u=this;this.bus=sap.ui.getCore().getEventBus();u.oStruModel=new o;u.oViewlistModel=new o;u.oViewModel=new o;n=u.getOwnerComponent().getModel("oGModel")},onAfterRendering:function(){n=u.getOwnerComponent().getModel("oGModel");this.byId("sturList").removeSelections();u.byId("detailNode").setSelectedKey("struNode");var e=n.getProperty("/SelectedAccessNode");var t=n.getProperty("/struNodeData");var s=n.getProperty("/ViewNodeData");var o=n.getProperty("/StruViewNodeData");u.struNodeData=[];u.viewNodeData=[];u.struviewNodeData=[];for(var i=0;i<t.length;i++){if(t[i].PARENT_NODE===e){u.struNodeData.push(t[i])}}for(var i=0;i<s.length;i++){if(s[i].PARENT_NODE===e){u.viewNodeData.push(s[i])}}for(var r=0;r<u.viewNodeData.length;r++){var a=0;for(var i=0;i<o.length;i++){if(o[i].PARENT_NODE===u.viewNodeData[r].CHILD_NODE&&o[i].ACCESS_NODES===e){u.struviewNodeData.push(o[i]);a=1}}if(a===0){var d={AUTH_GROUP:null,CHILD_NODE:"No Structure Node assigned",NODE_DESC:"",NODE_TYPE:"",PARENT_NODE:u.viewNodeData[r].CHILD_NODE,createdAt:null,createdBy:null,modifiedAt:null,modifiedBy:null,Flag:"X"};u.struviewNodeData.push(d)}}n.setProperty("/tableData",u.struviewNodeData);u.oStruModel.setData({Struresults:u.struNodeData});u.byId("sturList").setModel(u.oStruModel);u.aReqTabData();var l=n.getProperty("/reqData");u.oViewlistModel.setData({ViewListresults:l.Requests});u.byId("nodeTable").setModel(u.oViewlistModel)},aReqTabData:function(e){var t=u.viewNodeData,s=e?e.results:n.getProperty("/tableData"),o={Requests:[]},i=[],r,a,d,l=function(e,t,s){var o=JSON.parse(JSON.stringify(e)),i=JSON.parse(JSON.stringify(t)),r=JSON.parse(JSON.stringify(e));i._isParent=false;if(o.children.length===0){r._isParent=false;o.children.push(r)}o.children.push(i);return o};if(s.length){for(var c=0;c<s.length;c++){r=i.indexOf(s[c].PARENT_NODE);if(r===-1){i.push(s[c].PARENT_NODE);s[c].children=[];s[c]._isParent=true;o.Requests.push(s[c])}else{a=o.Requests[r];d=l(a,s[c],"Reqs");o.Requests[r]=d}}}n.setProperty("/reqData",o)},onDetailSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=[];t=t?t.trim():"";if(t!==""){s.push(new i({filters:[new i("CHILD_NODE",r.Contains,t),new i("NODE_DESC",r.Contains,t)],and:false}))}u.byId("sturList").getBinding("items").filter(s)},onViewNodeSearch(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=n.getProperty("/tableData"),o=[];if(t&&t.trim()!==""){t=t.trim().toLocaleUpperCase();for(var i=0;i<s.length;i++){if(s[i].PARENT_NODE.includes(t)||s[i].CHILD_NODE.includes(t)){o.push(s[i])}}}else{o=s}u.aReqTabData({results:o});var r=n.getProperty("/reqData");u.oViewlistModel.setData({ViewListresults:r.Requests})},onTabChange:function(e){var t=u.byId("detailNode").getSelectedKey();if(t==="struNode"){u.byId("idAssign").setVisible(true);u.byId("idAstru").setVisible(true);u.byId("idEstru").setVisible(true);u.byId("idView").setVisible(false)}else if(t==="viewNode"){u.byId("idAssign").setVisible(false);u.byId("idAstru").setVisible(false);u.byId("idEstru").setVisible(false);u.byId("idView").setVisible(true)}},onAssign:function(e){if(!u._oViewNode){u._oViewNode=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.ViewNodes",u);u.getView().addDependent(u._oViewNode)}if(this.byId("sturList").getSelectedItems().length){var s=n.getProperty("/ViewNodeData");u.viewAssignData=[];var o=n.getProperty("/SelectedAccessNode");n.setProperty("/selstrNode",this.byId("sturList").getSelectedItem().getCells()[0].getText());n.setProperty("/selstrNodeDesc",this.byId("sturList").getSelectedItem().getCells()[1].getText());for(var i=0;i<s.length;i++){if(s[i].PARENT_NODE===o){u.viewAssignData.push(s[i])}}u.oViewModel.setData({ViewNodesresults:u.viewAssignData});sap.ui.getCore().byId("ViewList").setModel(u.oViewModel);if(u.viewAssignData.length!==0){u._oViewNode.open()}else{t.show("There is no View Nodes for the selected Access Node")}}else{t.show("Select structure node to assign")}},onViewNodeClose:function(){sap.ui.getCore().byId("ViewList")._searchField.setValue("");if(u._oViewNode.getBinding("items")){u._oViewNode.getBinding("items").filter([])}},handleViewSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=e.getParameter("id"),o=[];t=t?t.trim():"";if(t!==""){o.push(new i({filters:[new i("CHILD_NODE",r.Contains,t),new i("NODE_DESC",r.Contains,t)],and:false}))}u._oViewNode.getBinding("items").filter(o)},onStruNode:function(e){if(!u._oStruNode){u._oStruNode=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.StructureNodes",u);u.getView().addDependent(u._oStruNode)}n=this.getModel("oGModel");n.setProperty("/sFlag","");if(e.getSource().getTooltip().includes("Add")){u._oStruNode.setTitle("Structure Node Creation");sap.ui.getCore().byId("idStruNode").setValue("");sap.ui.getCore().byId("idStruDesc").setValue("");sap.ui.getCore().byId("idLower").setValue("");sap.ui.getCore().byId("idUpper").setValue("");n.setProperty("/sFlag","C");u._oStruNode.open()}else{if(this.byId("sturList").getSelectedItems().length){var s=this.byId("sturList").getSelectedItem().getCells();u._oStruNode.setTitle("Update Structure Node");sap.ui.getCore().byId("idStruNode").setValue(s[0].getText());sap.ui.getCore().byId("idStruDesc").setValue(s[1].getText());sap.ui.getCore().byId("idStruNode").setEditable(false);n.setProperty("/sFlag","E");u._oStruNode.open()}else{t.show("Select structure node to update")}}},onStruNodeClose:function(){this.byId("sturList").removeSelections();u._oStruNode.close();u._oStruNode.destroy(true);u._oStruNode=""},onStruNodeDel:function(e){var s=e.getSource().getParent().getCells()[0].getText(),o=n.getProperty("/SelectedAccessNode");var i="Do you want to delete all the assignments of this Node. "+" - "+s+"-"+"Please confirm";sap.m.MessageBox.show(i,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.core.BusyIndicator.show();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:o,ACCESS_NODES:o,NODE_TYPE:"SN",NODE_DESC:"",LOWERLIMIT:0,UPPERLIMIT:0,FLAG:"D"},success:function(e){if(e.results.length>0){t.show("Structure node deleted successfully")}else{t.show("Deletion failed")}u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(){t.show("Failed to delete Structure node");sap.ui.core.BusyIndicator.hide()}})}}})},onStruNodeSave:function(e){var s=sap.ui.getCore().byId("idAccNode").getValue(),o=sap.ui.getCore().byId("idStruNode").getValue(),i=sap.ui.getCore().byId("idStruDesc").getValue(),r=n.getProperty("/sFlag"),a,d;if(sap.ui.getCore().byId("idLower").getValue()===""){a=sap.ui.getCore().byId("idLower").getPlaceholder()}else{a=sap.ui.getCore().byId("idLower").getValue()}if(sap.ui.getCore().byId("idUpper").getValue()===""){d=sap.ui.getCore().byId("idUpper").getPlaceholder()}else{d=sap.ui.getCore().byId("idUpper").getValue()}u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:o,PARENT_NODE:s,ACCESS_NODES:s,NODE_TYPE:"SN",NODE_DESC:i,LOWERLIMIT:a,UPPERLIMIT:d,FLAG:r},success:function(e){if(r==="C"){t.show("Successfully created the structure node")}else{t.show("Successfully updated the structure node")}u.onStruNodeClose();u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})},onAssignViewNode:function(e){var s=n.getProperty("/selstrNode");var o=n.getProperty("/selstrNodeDesc");var i=e.getParameter("selectedItems")[0].getTitle();var r=e.getParameter("selectedItems")[0].getDescription(),a=n.getProperty("/SelectedAccessNode");var d=r+" "+"-"+" "+o;u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:i,ACCESS_NODES:a,NODE_TYPE:"VS",NODE_DESC:d,LOWERLIMIT:0,UPPERLIMIT:0,FLAG:"C"},success:function(e){if(e.results.length>0){t.show("View Node assigned successfully");u.onViewNodeClose();u.bus.publish("data","refreshMaster")}else{t.show("View Node is already assigned")}sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})},onStruViewDelete:function(e){var s=e.getSource().getParent().getBindingContext(),o=s.getObject().PARENT_NODE,i=s.getObject().CHILD_NODE,r=s.getObject().ACCESS_NODES;var a="Do you want to delete all the assignments of this Node. "+" - "+i+"-"+"Please confirm";sap.m.MessageBox.show(a,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.core.BusyIndicator.show();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:i,PARENT_NODE:o,ACCESS_NODES:r,NODE_TYPE:"VS",NODE_DESC:"",LOWERLIMIT:0,UPPERLIMIT:0,FLAG:"D"},success:function(e){if(e.results.length>0){t.show("Deleted successfully")}else{t.show("Deletion failed")}u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to unassign structure node");sap.ui.core.BusyIndicator.hide()}})}}})},onViewNode:function(){if(!u._oViewNodeCreate){u._oViewNodeCreate=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.ViewNodesCreation",u);u.getView().addDependent(u._oViewNodeCreate)}sap.ui.getCore().byId("idViewNode").setValue("");sap.ui.getCore().byId("idViewDesc").setValue("");u._oViewNodeCreate.open()},onViewClose:function(){u._oViewNodeCreate.close();u._oViewNodeCreate.destroy(true);u._oViewNodeCreate=""},onViewNodeCreate:function(){var e=n.getProperty("/SelectedAccessNode"),s=sap.ui.getCore().byId("idViewNode").getValue(),o=sap.ui.getCore().byId("idViewDesc").getValue();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:e,ACCESS_NODES:e,NODE_TYPE:"VN",NODE_DESC:o,LOWERLIMIT:0,UPPERLIMIT:0,FLAG:"C"},success:function(e){t.show("Successfully created view node");u.onViewClose();u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})},onViewNOdeDelete:function(e){var s=e.getSource().getParent().getBindingContext(),o=s.getObject().PARENT_NODE,i=n.getProperty("/SelectedAccessNode");var r="Do you want to delete all the assignments of this Node. "+" - "+o+"-"+"Please confirm";sap.m.MessageBox.show(r,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.core.BusyIndicator.show();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:o,PARENT_NODE:i,ACCESS_NODES:i,NODE_TYPE:"VN",NODE_DESC:"",LOWERLIMIT:0,UPPERLIMIT:0,FLAG:"D"},success:function(e){if(e.results.length>0){t.show("Deleted successfully")}else{t.show("Deletion failed")}u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to unassign structure node");sap.ui.core.BusyIndicator.hide()}})}}})}})});