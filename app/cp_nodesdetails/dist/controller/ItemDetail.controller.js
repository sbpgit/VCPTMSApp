sap.ui.define(["cpappf/cpnodesdetails/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,s,o,r,i,a,d){"use strict";var u,l;return e.extend("cpappf.cpnodesdetails.controller.ItemDetail",{onInit:function(){u=this;this.bus=sap.ui.getCore().getEventBus();u.oStruModel=new o;u.oViewlistModel=new o;u.oViewModel=new o;l=u.getOwnerComponent().getModel("oGModel")},onAfterRendering:function(){l=u.getOwnerComponent().getModel("oGModel");this.byId("sturList").removeSelections();var e=l.getProperty("/SelectedAccessNode");var t=l.getProperty("/struNodeData");var s=l.getProperty("/ViewNodeData");var o=l.getProperty("/StruViewNodeData");u.struNodeData=[];u.viewNodeData=[];u.struviewNodeData=[];this.byId("struTitle").setText("Structure Node - View Node");for(var r=0;r<t.length;r++){if(t[r].PARENT_NODE===e){u.struNodeData.push(t[r])}}for(var r=0;r<s.length;r++){if(s[r].PARENT_NODE===e){u.viewNodeData.push(s[r])}}for(var i=0;i<u.viewNodeData.length;i++){var a=0;for(var r=0;r<o.length;r++){if(o[r].PARENT_NODE===u.viewNodeData[i].CHILD_NODE&&o[r].ACCESS_NODES===e){u.struviewNodeData.push(o[r]);a=1}}if(a===0){var d={AUTH_GROUP:null,CHILD_NODE:"No Structure Node assigned",NODE_DESC:"",NODE_TYPE:"",PARENT_NODE:s[i].CHILD_NODE,createdAt:null,createdBy:null,modifiedAt:null,modifiedBy:null};u.struviewNodeData.push(d)}}l.setProperty("/tableData",u.struviewNodeData);u.oStruModel.setData({Struresults:u.struNodeData});u.byId("sturList").setModel(u.oStruModel);u.aReqTabData();var n=l.getProperty("/reqData");u.oViewlistModel.setData({ViewListresults:n.Requests});u.byId("nodeTable").setModel(u.oViewlistModel)},aReqTabData:function(e){var t=u.viewNodeData,s=e?e.results:l.getProperty("/tableData"),o={Requests:[]},r=[],i,a,d,n=function(e,t,s){var o=JSON.parse(JSON.stringify(e)),r=JSON.parse(JSON.stringify(t)),i=JSON.parse(JSON.stringify(e));r._isParent=false;if(o.children.length===0){i._isParent=false;o.children.push(i)}o.children.push(r);return o};if(s.length){for(var c=0;c<s.length;c++){i=r.indexOf(s[c].PARENT_NODE);if(i===-1){r.push(s[c].PARENT_NODE);s[c].children=[];s[c]._isParent=true;o.Requests.push(s[c])}else{a=o.Requests[i];d=n(a,s[c],"Reqs");o.Requests[i]=d}}}l.setProperty("/reqData",o)},onDetailSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=[];if(t!==""){s.push(new r({filters:[new r("CHILD_NODE",i.Contains,t),new r("NODE_DESC",i.Contains,t)],and:false}))}u.byId("sturList").getBinding("items").filter(s)},onViewNodeSearch(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=l.getProperty("/tableData"),o=[];if(t&&t.trim()!==""){t=t.trim().toLocaleUpperCase();for(var r=0;r<s.length;r++){if(s[r].PARENT_NODE.includes(t)||s[r].CHILD_NODE.includes(t)){o.push(s[r])}}}else{o=s}u.aReqTabData({results:o});var i=l.getProperty("/reqData");u.oViewlistModel.setData({ViewListresults:i.Requests})},onTabChange:function(e){var t=u.byId("detailNode").getSelectedKey();if(t==="struNode"){u.byId("idAssign").setVisible(true);u.byId("idAstru").setVisible(true);u.byId("idEstru").setVisible(true);u.byId("idView").setVisible(false)}else if(t==="viewNode"){u.byId("idAssign").setVisible(false);u.byId("idAstru").setVisible(false);u.byId("idEstru").setVisible(false);u.byId("idView").setVisible(true)}},onAssign:function(e){if(!u._oViewNode){u._oViewNode=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.ViewNodes",u);u.getView().addDependent(u._oViewNode)}if(this.byId("sturList").getSelectedItems().length){var s=l.getProperty("/ViewNodeData");u.viewAssignData=[];var o=l.getProperty("/SelectedAccessNode");l.setProperty("/selstrNode",this.byId("sturList").getSelectedItem().getCells()[0].getText());l.setProperty("/selstrNodeDesc",this.byId("sturList").getSelectedItem().getCells()[1].getText());for(var r=0;r<s.length;r++){if(s[r].PARENT_NODE===o){u.viewAssignData.push(s[r])}}u.oViewModel.setData({ViewNodesresults:u.viewAssignData});sap.ui.getCore().byId("ViewList").setModel(u.oViewModel);if(u.viewAssignData.length!==0){u._oViewNode.open()}else{t.show("There is no View Nodes for the selected Access Node")}}else{t.show("Select structure node to assign")}},onViewNodeClose:function(){u._oViewNode.close();u._oViewNode.destroy(true);u._oViewNode=""},onStruNode:function(e){if(!u._oStruNode){u._oStruNode=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.StructureNodes",u);u.getView().addDependent(u._oStruNode)}l=this.getModel("oGModel");l.setProperty("/sFlag","");if(e.getSource().getTooltip().includes("Add")){u._oStruNode.setTitle("Structure Node Creation");sap.ui.getCore().byId("idStruNode").setValue("");sap.ui.getCore().byId("idStruDesc").setValue("");l.setProperty("/sFlag","C");u._oStruNode.open()}else{if(this.byId("sturList").getSelectedItems().length){var s=this.byId("sturList").getSelectedItem().getCells();u._oStruNode.setTitle("Update Structure Node");sap.ui.getCore().byId("idStruNode").setValue(s[0].getText());sap.ui.getCore().byId("idStruDesc").setValue(s[1].getText());sap.ui.getCore().byId("idStruNode").setEditable(false);l.setProperty("/sFlag","E");u._oStruNode.open()}else{t.show("Select structure node to update")}}},onStruNodeClose:function(){this.byId("sturList").removeSelections();u._oStruNode.close();u._oStruNode.destroy(true);u._oStruNode=""},onStruNodeDel:function(e){var s=e.getSource().getParent().getCells()[0].getText(),o=l.getProperty("/SelectedAccessNode");var r="Please confirm to remove structure node"+" - "+s;sap.m.MessageBox.show(r,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.core.BusyIndicator.show();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:o,ACCESS_NODES:o,NODE_TYPE:"SN",NODE_DESC:"",FLAG:"D"},success:function(e){t.show("Structure node deleted successfully");u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(){t.show("Failed to delete Structure node");sap.ui.core.BusyIndicator.hide()}})}}})},onStruNodeSave:function(e){var s=sap.ui.getCore().byId("idAccNode").getValue(),o=sap.ui.getCore().byId("idStruNode").getValue(),r=sap.ui.getCore().byId("idStruDesc").getValue(),i=l.getProperty("/sFlag");u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:o,PARENT_NODE:s,ACCESS_NODES:s,NODE_TYPE:"SN",NODE_DESC:r,FLAG:i},success:function(e){if(i==="C"){t.show("Successfully created the structure node")}else{t.show("Successfully updated the structure node")}u.onStruNodeClose();u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})},onAssignViewNode:function(e){var s=l.getProperty("/selstrNode");var o=l.getProperty("/selstrNodeDesc");var r=sap.ui.getCore().byId("ViewList").getSelectedItem().getCells()[0].getTitle();var i=sap.ui.getCore().byId("ViewList").getSelectedItem().getCells()[0].getText(),a=l.getProperty("/SelectedAccessNode");var d=i+" "+"-"+" "+o;u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:r,ACCESS_NODES:a,NODE_TYPE:"VS",NODE_DESC:d,FLAG:"C"},success:function(e){t.show("Successfully assigned structure node to view node");u.onViewNodeClose();u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})},onViewNode:function(){if(!u._oViewNodeCreate){u._oViewNodeCreate=sap.ui.xmlfragment("cpappf.cpnodesdetails.view.ViewNodesCreation",u);u.getView().addDependent(u._oViewNodeCreate)}sap.ui.getCore().byId("idViewNode").setValue("");sap.ui.getCore().byId("idViewDesc").setValue("");u._oViewNodeCreate.open()},onViewClose:function(){u._oViewNodeCreate.close();u._oViewNodeCreate.destroy(true);u._oViewNodeCreate=""},onViewNodeCreate:function(){var e=l.getProperty("/SelectedAccessNode"),s=sap.ui.getCore().byId("idViewNode").getValue(),o=sap.ui.getCore().byId("idViewDesc").getValue();u.getModel("BModel").callFunction("/genpvs",{method:"GET",urlParameters:{CHILD_NODE:s,PARENT_NODE:e,ACCESS_NODES:e,NODE_TYPE:"VN",NODE_DESC:o,FLAG:"C"},success:function(e){t.show("Successfully created view node");u.onViewClose();u.bus.publish("data","refreshMaster");sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("Failed to updated the structure node");sap.ui.core.BusyIndicator.hide()}})}})});