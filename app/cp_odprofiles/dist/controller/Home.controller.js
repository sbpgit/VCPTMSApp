sap.ui.define(["cp/odp/cpodprofiles/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,o,t,i,l,s,r,a){"use strict";var n,d;return e.extend("cp.odp.cpodprofiles.controller.Home",{onInit:function(){n=this;n.oListModel=new i;n.oProfileModel=new i;n.locModel=new i;n.prodModel=new i;n.CompModel=new i;n.StruNodeModel=new i;this.oListModel.setSizeLimit(5e3);n.locModel.setSizeLimit(1e3);n.prodModel.setSizeLimit(1e3);n.CompModel.setSizeLimit(1e3);n.StruNodeModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogComp){this._valueHelpDialogComp=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ComponentDialog",this);this.getView().addDependent(this._valueHelpDialogComp)}if(!this._valueHelpDialogStruNode){this._valueHelpDialogStruNode=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.StructureNodes",this);this.getView().addDependent(this._valueHelpDialogStruNode)}this.getRouter().getRoute("Home").attachPatternMatched(this._onPatternMatched.bind(this))},_onPatternMatched:function(){n=this;n.oList=this.byId("idTab");this.oLoc=this.byId("idloc");this.oProd=this.byId("prodInput");this.oComp=this.byId("compInput");this.oStruNode=this.byId("struInput");n._valueHelpDialogProd.setTitleAlignment("Center");n._valueHelpDialogLoc.setTitleAlignment("Center");n._valueHelpDialogComp.setTitleAlignment("Center");n._valueHelpDialogStruNode.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oCompList=this._oCore.byId(this._valueHelpDialogComp.getId()+"-list");this.oStruNodeList=this._oCore.byId(this._valueHelpDialogStruNode.getId()+"-list");n.oList.removeSelections();this.getData()},getData:function(){sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocation",{success:function(e){n.locModel.setData(e);n.oLocList.setModel(n.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){o.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(n.byId("idloc").getValue()){n._valueHelpDialogProd.open()}else{o.show("Select Location")}}else if(t.includes("comp")){if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){n._valueHelpDialogComp.open()}else{o.show("No Product Location selected")}}else if(t.includes("stru")){if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){n._valueHelpDialogStruNode.open()}else{o.show("No Product Location selected")}}},handleClose:function(e){var o=e.getParameter("id");if(o.includes("loc")){n._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(n.oLocList.getBinding("items")){n.oLocList.getBinding("items").filter([])}}else if(o.includes("prod")){n._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(n.oProdList.getBinding("items")){n.oProdList.getBinding("items").filter([])}}else if(o.includes("Comp")){n._oCore.byId(this._valueHelpDialogComp.getId()+"-searchField").setValue("");if(n.oCompList.getBinding("items")){n.oCompList.getBinding("items").filter([])}}else if(o.includes("stru")){n._oCore.byId(this._valueHelpDialogStruNode.getId()+"-searchField").setValue("");if(n.oStruNodeList.getBinding("items")){n.oStruNodeList.getBinding("items").filter([])}}},handleSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=e.getParameter("id"),i=[];o=o?o.trim():"";if(t.includes("Loc")){if(o!==""){i.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("LOCATION_DESC",s.Contains,o)],and:false}))}n.oLocList.getBinding("items").filter(i)}else if(t.includes("prod")){if(o!==""){i.push(new l({filters:[new l("PRODUCT_ID",s.Contains,o),new l("PROD_DESC",s.Contains,o)],and:false}))}n.oProdList.getBinding("items").filter(i)}else if(t.includes("Comp")){if(o!==""){i.push(new l({filters:[new l("COMPONENT",s.Contains,o),new l("ITEM_NUM",s.Contains,o)],and:false}))}n.oCompList.getBinding("items").filter(i)}},handleSelection:function(e){var t=e.getParameter("id"),i=e.getParameter("selectedItems"),r,a=[];if(t.includes("Loc")){this.oLoc=n.byId("idloc");var d=e.getParameter("selectedItems");n.oLoc.setValue(d[0].getTitle());n.oProd.removeAllTokens();n.oComp.removeAllTokens();n.oStruNode.setValue();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new l("LOCATION_ID",s.EQ,d[0].getTitle())],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel)},error:function(e,t){o.show("error")}})}else if(t.includes("prod")){this.oProd=n.byId("prodInput");var u=e.getParameter("selectedItems");n.oComp.removeAllTokens();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();if(u&&u.length>0){n.oProd.removeAllTokens();u.forEach(function(e){n.oProd.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var u=n.oProdList.getSelectedItems();var p=[];var g=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});p.push(g);for(var c=0;c<u.length;c++){g=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:u[c].getTitle()});p.push(g)}this.getModel("BModel").read("/getBomOdCond",{filters:p,success:function(e){n.odCondData=e.results;n.CompModel.setData(e);n.oCompList.setModel(n.CompModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{n.oProd.removeAllTokens()}}else if(t.includes("Comp")){this.oComp=n.byId("compInput");var h=e.getParameter("selectedItems");if(h&&h.length>0){n.oComp.removeAllTokens();h.forEach(function(e){n.oComp.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var u=n.oProdList.getSelectedItems();var h=n.oCompList.getSelectedItems();var p=[];var g=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});p.push(g);for(var c=0;c<u.length;c++){g=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:u[c].getTitle()});p.push(g)}for(var c=0;c<h.length;c++){g=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:h[c].getTitle()});p.push(g)}this.getModel("BModel").read("/genCompStrcNode",{filters:p,success:function(e){n.StruNodeModel.setData(e);n.oStruNodeList.setModel(n.StruNodeModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{n.oComp.removeAllTokens()}}else if(t.includes("Stru")){this.oStruNode=n.byId("struInput");var d=e.getParameter("selectedItems");n.oStruNode.setValue(d[0].getTitle())}n.handleClose(e)},onGetData:function(){n.oList.removeSelections();if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var e=n.oProdList.getSelectedItems();var t=n.oCompList.getSelectedItems();var i=[];var l=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});i.push(l);for(var s=0;s<e.length;s++){l=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:e[s].getTitle()});i.push(l)}for(var s=0;s<t.length;s++){l=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:t[s].getTitle()});i.push(l)}if(n.oStruNode.getValue()){var l=new sap.ui.model.Filter({path:"STRUC_NODE",operator:sap.ui.model.FilterOperator.EQ,value1:n.oStruNode.getValue()});i.push(l)}this.getModel("BModel").read("/getODProfiles",{filters:i,success:function(e){n.oListModel.setData({results:e.results});n.oList.setModel(n.oListModel)},error:function(e,t){o.show("error")}})}else{o.show("Please select Location and Product")}},onAssign:function(){n.oGModel=n.getModel("oGModel");var e=n.byId("idTab").getSelectedItems();if(e.length){if(!n._onProfiles){n._onProfiles=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.Profiles",n);n.getView().addDependent(n._onProfiles)}n.oProfileList=sap.ui.getCore().byId("idListTab");n._onProfiles.setTitleAlignment("Center");this.getModel("BModel").read("/getProfiles",{success:function(o){n.oProfileModel.setData({results:o.results});n.oProfileList.setModel(n.oProfileModel);n.oProfileList.removeSelections(true);n._onProfiles.open();n.oGModel.setProperty("/selItem",e)},error:function(){o.show("Failed to get profiles")}})}else{o.show("Please select atleast one item to assign profile")}},handleProfileClose:function(){n.byId("idTab").removeSelections();n._onProfiles.close()},handleprofileSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("PROFILE",s.Contains,o),new l("PRF_DESC",s.Contains,o)],and:false}))}n.oProfileList.getBinding("items").filter(t)},onTableSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("PRODUCT_ID",s.Contains,o),new l("COMPONENT",s.Contains,o),new l("STRUC_NODE",s.Contains,o),new l("PROFILE",s.Contains,o)],and:false}))}n.oList.getBinding("items").filter(t)},onProfileSel:function(e){var o=n.oGModel.getProperty("/selItem"),t={PROFILEOD:[]},i,l=sap.ui.getCore().byId("idListTab").getSelectedItems()[0].getTitle();var s;for(var r=0;r<o.length;r++){s=o[r].getBindingContext().getProperty();sap.ui.core.BusyIndicator.show();n.getModel("BModel").callFunction("/assignProfilesOD",{method:"GET",urlParameters:{FLAG:"I",LOCATION_ID:s.LOCATION_ID,PRODUCT_ID:s.PRODUCT_ID,COMPONENT:s.COMPONENT,STRUC_NODE:s.STRUC_NODE,PROFILE:l},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile assigned successfully");n.handleProfileClose();n.onGetData()},error:function(e){sap.m.MessageToast.show("Error in assigning Profiles");sap.ui.core.BusyIndicator.hide();n.handleProfileClose()}})}},onUnAssign:function(){var e;var o=n.byId("idTab").getSelectedItems();for(var t=0;t<o.length;t++){e=o[t].getBindingContext().getProperty();sap.ui.core.BusyIndicator.show();n.getModel("BModel").callFunction("/assignProfilesOD",{method:"GET",urlParameters:{FLAG:"D",LOCATION_ID:e.LOCATION_ID,PRODUCT_ID:e.PRODUCT_ID,COMPONENT:e.COMPONENT,STRUC_NODE:"",PROFILE:e.PROFILE},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile unassigned successfully");n.onGetData()},error:function(e){sap.m.MessageToast.show("Error while unassigning Profiles");sap.ui.core.BusyIndicator.hide()}})}},onNavPress:function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var e=sap.ushell.Container.getService("CrossApplicationNavigation");var o=e&&e.hrefForExternal({target:{semanticObject:"vcpdocdisplay",action:"Display"}})||"";var t=window.location.href.split("#")[0]+o;sap.m.URLHelper.redirect(t,true)}}})});