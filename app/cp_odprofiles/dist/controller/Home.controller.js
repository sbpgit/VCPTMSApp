sap.ui.define(["cp/odp/cpodprofiles/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,o,t,i,l,s,a,r){"use strict";var n,d;return e.extend("cp.odp.cpodprofiles.controller.Home",{onInit:function(){n=this;n.oListModel=new i;n.oProfileModel=new i;n.locModel=new i;n.prodModel=new i;n.CompModel=new i;n.ObjDepModel=new i;this.oListModel.setSizeLimit(5e3);n.locModel.setSizeLimit(1e3);n.prodModel.setSizeLimit(1e3);n.CompModel.setSizeLimit(1e3);n.ObjDepModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogComp){this._valueHelpDialogComp=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ComponentDialog",this);this.getView().addDependent(this._valueHelpDialogComp)}if(!this._valueHelpDialogObjDep){this._valueHelpDialogObjDep=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ObjDepDialog",this);this.getView().addDependent(this._valueHelpDialogObjDep)}this.getRouter().getRoute("Home").attachPatternMatched(this._onPatternMatched.bind(this))},_onPatternMatched:function(){n=this;n.oList=this.byId("idTab");this.oLoc=this.byId("locInput");this.oProd=this.byId("prodInput");this.oComp=this.byId("compInput");this.oObjDep=this.byId("objDepInput");n._valueHelpDialogProd.setTitleAlignment("Center");n._valueHelpDialogLoc.setTitleAlignment("Center");n._valueHelpDialogComp.setTitleAlignment("Center");n._valueHelpDialogObjDep.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oCompList=this._oCore.byId(this._valueHelpDialogComp.getId()+"-list");this.oObjDepList=this._oCore.byId(this._valueHelpDialogObjDep.getId()+"-list");n.oList.removeSelections();this.getData()},getData:function(){sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocation",{success:function(e){n.locModel.setData(e);n.oLocList.setModel(n.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){o.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(n.byId("idloc").getValue()){n._valueHelpDialogProd.open()}else{o.show("Select Location")}}else if(t.includes("comp")){if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){n._valueHelpDialogComp.open()}else{o.show("No Product Location selected")}}else if(t.includes("objDep")){if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){n._valueHelpDialogObjDep.open()}else{o.show("No Product Location selected")}}},handleClose:function(e){var o=e.getParameter("id");if(o.includes("loc")){n._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(n.oLocList.getBinding("items")){n.oLocList.getBinding("items").filter([])}}else if(o.includes("prod")){n._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(n.oProdList.getBinding("items")){n.oProdList.getBinding("items").filter([])}}else if(o.includes("Comp")){n._oCore.byId(this._valueHelpDialogComp.getId()+"-searchField").setValue("");if(n.oCompList.getBinding("items")){n.oCompList.getBinding("items").filter([])}}else if(o.includes("ObjDep")){n._oCore.byId(this._valueHelpDialogObjDep.getId()+"-searchField").setValue("");if(n.oObjDepList.getBinding("items")){n.oObjDepList.getBinding("items").filter([])}}},handleSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=e.getParameter("id"),i=[];o=o?o.trim():"";if(t.includes("Loc")){if(o!==""){i.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("LOCATION_DESC",s.Contains,o)],and:false}))}n.oLocList.getBinding("items").filter(i)}else if(t.includes("prod")){if(o!==""){i.push(new l({filters:[new l("PRODUCT_ID",s.Contains,o),new l("PROD_DESC",s.Contains,o)],and:false}))}n.oProdList.getBinding("items").filter(i)}else if(t.includes("Comp")){if(o!==""){i.push(new l({filters:[new l("COMPONENT",s.Contains,o),new l("ITEM_NUM",s.Contains,o)],and:false}))}n.oCompList.getBinding("items").filter(i)}else if(t.includes("ObjDep")){if(o!==""){i.push(new l({filters:[new l("OBJ_DEP",s.Contains,o),new l("OBJDEP_DESC",s.Contains,o)],and:false}))}n.oObjDepList.getBinding("items").filter(i)}},handleSelection:function(e){var t=e.getParameter("id"),i=e.getParameter("selectedItems"),a,r=[];if(t.includes("Loc")){this.oLoc=n.byId("idloc");var d=e.getParameter("selectedItems");n.oLoc.setValue(d[0].getTitle());n.oProd.removeAllTokens();n.oComp.removeAllTokens();n.oObjDep.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogObjDep.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new l("LOCATION_ID",s.EQ,d[0].getTitle())],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel)},error:function(e,t){o.show("error")}})}else if(t.includes("prod")){this.oProd=n.byId("prodInput");var p=e.getParameter("selectedItems");n.oComp.removeAllTokens();n.oObjDep.removeAllTokens();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogObjDep.getAggregation("_dialog").getContent()[1].removeSelections();if(p&&p.length>0){n.oProd.removeAllTokens();p.forEach(function(e){n.oProd.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var p=n.oProdList.getSelectedItems();var g=[];var u=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});g.push(u);for(var c=0;c<p.length;c++){u=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:p[c].getTitle()});g.push(u)}this.getModel("BModel").read("/getBomOdCond",{filters:g,success:function(e){n.odCondData=e.results;n.CompModel.setData(e);n.oCompList.setModel(n.CompModel);n.ObjDepModel.setData(e);n.oObjDepList.setModel(n.ObjDepModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{n.oProd.removeAllTokens()}}else if(t.includes("Comp")){this.oComp=n.byId("compInput");var h=e.getParameter("selectedItems");if(h&&h.length>0){n.oComp.removeAllTokens();h.forEach(function(e){n.oComp.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var p=n.oProdList.getSelectedItems();var h=n.oCompList.getSelectedItems();var g=[];var u=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});g.push(u);for(var c=0;c<p.length;c++){u=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:p[c].getTitle()});g.push(u)}for(var c=0;c<h.length;c++){u=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:h[c].getTitle()});g.push(u)}this.getModel("BModel").read("/getBomOdCond",{filters:g,success:function(e){n.ObjDepModel.setData(e);n.oObjDepList.setModel(n.ObjDepModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{n.oComp.removeAllTokens()}}else if(t.includes("ObjDep")){this.oObjDep=n.byId("objDepInput");var m=e.getParameter("selectedItems");if(m&&m.length>0){n.oObjDep.removeAllTokens();m.forEach(function(e){n.oObjDep.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))})}else{n.oObjDep.removeAllTokens()}}n.handleClose(e)},onGetData:function(){n.oList.removeSelections();if(n.byId("idloc").getValue()&&n.byId("prodInput").getTokens().length!==0){var e=n.oProdList.getSelectedItems();var t=n.oCompList.getSelectedItems();var i=n.oObjDepList.getSelectedItems();var l=[];var s=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});l.push(s);for(var a=0;a<e.length;a++){s=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:e[a].getTitle()});l.push(s)}for(var a=0;a<t.length;a++){s=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:t[a].getTitle()});l.push(s)}for(var a=0;a<i.length;a++){s=new sap.ui.model.Filter({path:"OBJ_DEP",operator:sap.ui.model.FilterOperator.EQ,value1:i[a].getTitle()});l.push(s)}this.getModel("BModel").read("/getODProfiles",{filters:l,success:function(e){n.oListModel.setData({results:e.results});n.oList.setModel(n.oListModel)},error:function(e,t){o.show("error")}})}else{o.show("Please select Location and Product")}},onAssign:function(){n.oGModel=n.getModel("oGModel");var e=n.byId("idTab").getSelectedItems();if(e.length){if(!n._onProfiles){n._onProfiles=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.Profiles",n);n.getView().addDependent(n._onProfiles)}n.oProfileList=sap.ui.getCore().byId("idListTab");n._onProfiles.setTitleAlignment("Center");this.getModel("BModel").read("/getProfiles",{success:function(o){n.oProfileModel.setData({results:o.results});n.oProfileList.setModel(n.oProfileModel);n.oProfileList.removeSelections(true);n._onProfiles.open();n.oGModel.setProperty("/selItem",e)},error:function(){o.show("Failed to get profiles")}})}else{o.show("Please select atleast one item to assign profile")}},handleProfileClose:function(){n.byId("idTab").removeSelections();n._onProfiles.close()},handleprofileSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("PROFILE",s.Contains,o),new l("PRF_DESC",s.Contains,o)],and:false}))}n.oProfileList.getBinding("items").filter(t)},onTableSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("PRODUCT_ID",s.Contains,o),new l("COMPONENT",s.Contains,o),new l("OBJ_DEP",s.Contains,o),new l("STRUC_NODE",s.Contains,o),new l("PROFILE",s.Contains,o)],and:false}))}n.oList.getBinding("items").filter(t)},onProfileSel:function(e){var o=n.oGModel.getProperty("/selItem"),t={PROFILEOD:[]},i,l=sap.ui.getCore().byId("idListTab").getSelectedItems()[0].getTitle();var s;for(var a=0;a<o.length;a++){s=o[a].getBindingContext().getProperty();sap.ui.core.BusyIndicator.show();n.getModel("BModel").callFunction("/asssignProfilesOD",{method:"GET",urlParameters:{FLAG:"I",LOCATION_ID:s.LOCATION_ID,PRODUCT_ID:s.PRODUCT_ID,COMPONENT:s.COMPONENT,OBJ_DEP:s.OBJ_DEP,STRUC_NODE:s.STRUC_NODE,PROFILE:l},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile assigned successfully");n.handleProfileClose();n.onGetData()},error:function(e){sap.m.MessageToast.show("Error in assigning Profiles");sap.ui.core.BusyIndicator.hide();n.handleProfileClose()}})}},onUnAssign:function(){var e={PROFILEOD:[]},o;var t;var i=n.byId("idTab").getSelectedItems();for(var l=0;l<i.length;l++){t=i[l].getBindingContext().getProperty();sap.ui.core.BusyIndicator.show();n.getModel("BModel").callFunction("/asssignProfilesOD",{method:"GET",urlParameters:{FLAG:"D",LOCATION_ID:t.LOCATION_ID,PRODUCT_ID:t.PRODUCT_ID,COMPONENT:t.COMPONENT,OBJ_DEP:t.OBJ_DEP,STRUC_NODE:"",PROFILE:t.PROFILE},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile unassigned successfully");n.onGetData()},error:function(e){sap.m.MessageToast.show("Error while unassigning Profiles");sap.ui.core.BusyIndicator.hide()}})}}})});