sap.ui.define(["cp/odp/cpodprofiles/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,o,t,i,l,s,a,n){"use strict";var r,d;return e.extend("cp.odp.cpodprofiles.controller.Home",{onInit:function(){r=this;r.oListModel=new i;r.oProfileModel=new i;r.locModel=new i;r.prodModel=new i;r.CompModel=new i;r.ObjDepModel=new i;this.oListModel.setSizeLimit(5e3);r.locModel.setSizeLimit(1e3);r.prodModel.setSizeLimit(1e3);r.CompModel.setSizeLimit(1e3);r.ObjDepModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogComp){this._valueHelpDialogComp=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ComponentDialog",this);this.getView().addDependent(this._valueHelpDialogComp)}if(!this._valueHelpDialogObjDep){this._valueHelpDialogObjDep=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.ObjDepDialog",this);this.getView().addDependent(this._valueHelpDialogObjDep)}this.getRouter().getRoute("Home").attachPatternMatched(this._onPatternMatched.bind(this))},_onPatternMatched:function(){r=this;r.oList=this.byId("idTab");this.oLoc=this.byId("locInput");this.oProd=this.byId("prodInput");this.oComp=this.byId("compInput");this.oObjDep=this.byId("objDepInput");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oCompList=this._oCore.byId(this._valueHelpDialogComp.getId()+"-list");this.oObjDepList=this._oCore.byId(this._valueHelpDialogObjDep.getId()+"-list");r.oList.removeSelections();this.getData()},getData:function(){sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocation",{success:function(e){r.locModel.setData(e);r.oLocList.setModel(r.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){o.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){r._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(r.byId("idloc").getValue()){r._valueHelpDialogProd.open()}else{o.show("Select Location")}}else if(t.includes("comp")){if(r.byId("idloc").getValue()&&r.byId("prodInput").getTokens().length!==0){r._valueHelpDialogComp.open()}else{o.show("No Product Location selected")}}else if(t.includes("objDep")){if(r.byId("idloc").getValue()&&r.byId("prodInput").getTokens().length!==0){r._valueHelpDialogObjDep.open()}else{o.show("No Product Location selected")}}},handleClose:function(e){var o=e.getParameter("id");if(o.includes("loc")){r._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(r.oLocList.getBinding("items")){r.oLocList.getBinding("items").filter([])}}else if(o.includes("prod")){r._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(r.oProdList.getBinding("items")){r.oProdList.getBinding("items").filter([])}}else if(o.includes("comp")){r._oCore.byId(this._valueHelpDialogComp.getId()+"-searchField").setValue("");if(r.oCompList.getBinding("items")){r.oCompList.getBinding("items").filter([])}}else if(o.includes("prod")){r._oCore.byId(this._valueHelpDialogObjDep.getId()+"-searchField").setValue("");if(r.oObjDepList.getBinding("items")){r.oObjDepList.getBinding("items").filter([])}}},handleSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=e.getParameter("id"),i=[];o=o?o.trim():"";if(t.includes("Loc")){if(o!==""){i.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("LOCATION_DESC",s.Contains,o)],and:false}))}r.oLocList.getBinding("items").filter(i)}else if(t.includes("prod")){if(o!==""){i.push(new l({filters:[new l("PRODUCT_ID",s.Contains,o),new l("PROD_DESC",s.Contains,o)],and:false}))}r.oProdList.getBinding("items").filter(i)}else if(t.includes("Comp")){if(o!==""){i.push(new l({filters:[new l("COMPONENT",s.Contains,o),new l("ITEM_NUM",s.Contains,o)],and:false}))}r.oCompList.getBinding("items").filter(i)}else if(t.includes("ObjDep")){if(o!==""){i.push(new l({filters:[new l("OBJ_DEP",s.Contains,o),new l("OBJDEP_DESC",s.Contains,o)],and:false}))}r.oObjDepList.getBinding("items").filter(i)}},handleSelection:function(e){var t=e.getParameter("id"),i=e.getParameter("selectedItems"),a,n=[];if(t.includes("Loc")){this.oLoc=r.byId("idloc");a=e.getParameter("selectedItems");r.oLoc.setValue(a[0].getTitle());r.oProd.removeAllTokens();r.oComp.removeAllTokens();r.oObjDep.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogObjDep.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new l("LOCATION_ID",s.EQ,a[0].getTitle())],success:function(e){r.prodModel.setData(e);r.oProdList.setModel(r.prodModel)},error:function(e,t){o.show("error")}})}else if(t.includes("prod")){this.oProd=r.byId("prodInput");a=e.getParameter("selectedItems");r.oComp.removeAllTokens();r.oObjDep.removeAllTokens();this._valueHelpDialogComp.getAggregation("_dialog").getContent()[1].removeSelections();this._valueHelpDialogObjDep.getAggregation("_dialog").getContent()[1].removeSelections();if(a&&a.length>0){r.oProd.removeAllTokens();a.forEach(function(e){r.oProd.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(r.byId("idloc").getValue()&&r.byId("prodInput").getTokens().length!==0){var d=r.oProdList.getSelectedItems();var p=[];var g=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:r.oLoc.getValue()});p.push(g);for(var u=0;u<d.length;u++){g=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:d[u].getTitle()});p.push(g)}this.getModel("BModel").read("/getBomOdCond",{filters:p,success:function(e){r.odCondData=e.results;r.CompModel.setData(e);r.oCompList.setModel(r.CompModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{r.oProd.removeAllTokens()}}else if(t.includes("Comp")){this.oComp=r.byId("compInput");a=e.getParameter("selectedItems");if(a&&a.length>0){r.oComp.removeAllTokens();a.forEach(function(e){r.oComp.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))});if(r.byId("idloc").getValue()&&r.byId("prodInput").getTokens().length!==0){var d=r.oProdList.getSelectedItems();var c=r.oCompList.getSelectedItems();var p=[];var g=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:r.oLoc.getValue()});p.push(g);for(var u=0;u<d.length;u++){g=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:d[u].getTitle()});p.push(g)}for(var u=0;u<c.length;u++){g=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:c[u].getTitle()});p.push(g)}this.getModel("BModel").read("/getBomOdCond",{filters:p,success:function(e){r.ObjDepModel.setData(e);r.oObjDepList.setModel(r.ObjDepModel)},error:function(e,t){o.show("error")}})}else{o.show("No Product Location selected")}}else{r.oComp.removeAllTokens()}}else if(t.includes("ObjDep")){this.oObjDep=r.byId("objDepInput");a=e.getParameter("selectedItems");if(a&&a.length>0){r.oObjDep.removeAllTokens();a.forEach(function(e){r.oObjDep.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))})}else{r.oObjDep.removeAllTokens()}}r.handleClose(e)},onGetData:function(){if(r.byId("idloc").getValue()&&r.byId("prodInput").getTokens().length!==0&&r.byId("compInput").getTokens().length!==0&&r.byId("objDepInput").getTokens().length!==0){var e=r.oProdList.getSelectedItems();var t=r.oCompList.getSelectedItems();var i=r.oObjDepList.getSelectedItems();var l=[];var s=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:r.oLoc.getValue()});l.push(s);for(var a=0;a<e.length;a++){s=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:e[a].getTitle()});l.push(s)}for(var a=0;a<t.length;a++){s=new sap.ui.model.Filter({path:"COMPONENT",operator:sap.ui.model.FilterOperator.EQ,value1:t[a].getTitle()});l.push(s)}for(var a=0;a<i.length;a++){s=new sap.ui.model.Filter({path:"OBJ_DEP",operator:sap.ui.model.FilterOperator.EQ,value1:i[a].getTitle()});l.push(s)}this.getModel("BModel").read("/getODProfiles",{filters:l,success:function(e){r.oListModel.setData({results:e.results});r.oList.setModel(r.oListModel)},error:function(e,t){o.show("error")}})}else{o.show("Select all filter to get data")}},onAssign:function(){r.oGModel=r.getModel("oGModel");var e=r.byId("idTab").getSelectedItems();if(e.length){if(!r._onProfiles){r._onProfiles=sap.ui.xmlfragment("cp.odp.cpodprofiles.view.Profiles",r);r.getView().addDependent(r._onProfiles)}r.oProfileList=sap.ui.getCore().byId("idListTab");r._onProfiles.setTitleAlignment("Center");this.getModel("BModel").read("/getProfiles",{success:function(o){r.oProfileModel.setData({results:o.results});r.oProfileList.setModel(r.oProfileModel);r._onProfiles.open();r.oGModel.setProperty("/selItem",e)},error:function(){o.show("Failed to get profiles")}})}else{o.show("Please select atleast one item to assign profile")}},handleProfileClose:function(){r.byId("idTab").removeSelections();r._onProfiles.close()},handleprofileSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("PROFILE",s.Contains,o),new l("PRF_DESC",s.Contains,o)],and:false}))}r.oProfileList.getBinding("items").filter(t)},onTableSearch:function(e){var o=e.getParameter("value")||e.getParameter("newValue"),t=[];if(o!==""){t.push(new l({filters:[new l("LOCATION_ID",s.Contains,o),new l("PRODUCT_ID",s.Contains,o),new l("COMPONENT",s.Contains,o),new l("OBJ_DEP",s.Contains,o),new l("PROFILE",s.Contains,o)],and:false}))}r.oList.getBinding("items").filter(t)},onProfileSel:function(e){var o=r.oGModel.getProperty("/selItem"),t={PROFILEOD:[]},i,l=sap.ui.getCore().byId("idListTab").getSelectedItems()[0].getTitle();var s;for(var a=0;a<o.length;a++){s=o[a].getBindingContext().getProperty();i={LOCATION_ID:s.LOCATION_ID,PRODUCT_ID:s.PRODUCT_ID,COMPONENT:s.COMPONENT,OBJ_DEP:s.OBJ_DEP,PROFILE:l};t.PROFILEOD.push(i);i={}}var n="v2/catalog/genProfileOD";$.ajax({url:n,type:"POST",contentType:"application/json",data:JSON.stringify({FLAG:"I",PROFILEOD:t.PROFILEOD}),dataType:"json",async:false,timeout:0,error:function(e){sap.m.MessageToast.show("Error in assigning Profiles");sap.ui.core.BusyIndicator.hide();r.handleClose()},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile assigned successfully");r.handleClose();r.onGetData()}})},onUnAssign:function(){var e={PROFILEOD:[]},o;var t;var i=r.byId("idTab").getSelectedItems();for(var l=0;l<i.length;l++){t=i[l].getBindingContext().getProperty();o={LOCATION_ID:t.LOCATION_ID,PRODUCT_ID:t.PRODUCT_ID,COMPONENT:t.COMPONENT,OBJ_DEP:t.OBJ_DEP,PROFILE:t.PROFILE};e.PROFILEOD.push(o);o={}}var s="v2/catalog/genProfileOD";$.ajax({url:s,type:"POST",contentType:"application/json",data:JSON.stringify({FLAG:"D",PROFILEOD:e.PROFILEOD}),dataType:"json",async:false,timeout:0,error:function(e){sap.m.MessageToast.show("Error in unassigning Profiles");sap.ui.core.BusyIndicator.hide()},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Profile unassigned successfully");r.onGetData()}})}})});