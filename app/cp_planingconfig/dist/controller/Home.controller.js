sap.ui.define(["cpapp/cpplaningconfig/controller/BaseController","sap/m/GroupHeaderListItem","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device"],function(e,t,o,a,r,n,s){"use strict";var l=this,i;return e.extend("cpapp.cpplaningconfig.controller.Home",{onInit:function(){var e;l=this;this.bus=sap.ui.getCore().getEventBus();i=l.getOwnerComponent().getModel("oGModel");l.i18n=l.getResourceBundle();l.oParameterModel=new a;l.oMethodModel=new a;var t=this.getView().byId("idDetailView"),o=t.getShowFooter();t.setShowFooter(o);if(!l.oMethodDialog){l.oMethodDialog=sap.ui.xmlfragment("cpapp.cpplaningconfig.view.MethodTyp",l);l.getView().addDependent(l.oMethodDialog)}},onAfterRendering:function(){var e=l.getOwnerComponent().getModel("PCModel");i=l.getOwnerComponent().getModel("oGModel");var t=i.getProperty("/location");l.getParameters();l.getMethods(e)},grouper:function(e){return{key:e.oModel.oData.Steps[e.sPath.split("/")[2]].GROUP_DESCRIPTION}},getGroupHeader:function(e){var o=e.key.slice(1);return new t({title:o,upperCase:false})},onPressSave:function(){var e=l.getOwnerComponent().getModel("PCModel");var t={PARAMVALS:[]},a;var r="";var n=i.getProperty("/location");var s=l.getView().byId("idParameterTable").getItems();for(var d=0;d<s.length;d++){var g=s[d];if(g._bGroupHeader===false){if(g.getCells()[2].getValue()!==""&&g.getCells()[2].getValueState()==="None"){if(g.getCells()[2].getName()!==""&&g.getCells()[2].getName()!==undefined){r=g.getCells()[2].getName()}else{r=g.getCells()[2].getValue()}a={LOCATION_ID:n,PARAMETER_ID:g.getCells()[0].getText(),VALUE:r};t.PARAMVALS.push(a)}else{o.show(l.i18n.getText("getMandtMsg"),{width:"15%"});return}}}e.callFunction("/postParameterValues",{method:"GET",urlParameters:{FLAG:"C",PARAMVALS:JSON.stringify(t.PARAMVALS)},success:function(e,t){sap.m.MessageToast.show(l.i18n.getText("postSuccess"))},error:function(e){sap.m.MessageToast.show("Error")}})},getPlannedParameters:function(e){var t=[];l.getModel("PCModel").read("/V_Parameters",{filters:[new r("LOCATION_ID",n.EQ,e)],success:function(e){t=e.results;if(t.length>0){t=t.sort((e,t)=>e.SEQUENCE-t.SEQUENCE);l.oParameterModel.setData({parameters:t});l.byId("idParameterTable").setModel(l.oParameterModel)}else{l.getParameters()}},error:function(e){o.show("Failed to fetch Parameters!")}})},getParameters:function(){var e=[];l.getModel("PCModel").read("/V_Parameters",{success:function(t){e=t.results;if(e.length>0){l.getFilteredData(e)}},error:function(e){o.show("Failed to fetch Parameters!")}})},getFilteredData:function(e){var t=i.getProperty("/location");var o=0;e=e.sort((e,t)=>e.SEQUENCE-t.SEQUENCE);const a=e.map(e=>e.PARAMETER_ID);const r=e.filter(({PARAMETER_ID:e},t)=>!a.includes(e,t+1));const n=r.map(e=>({...e,VALUE:""}));var s=e.filter(function(e){return e.LOCATION_ID===t});if(s.length>0){if(n.length>0){for(var d=0;d<n.length;d++){o=0;s.indexOf(n[d]);o=s.findIndex(e=>e.PARAMETER_ID===n[d].PARAMETER_ID);if(o===-1){s.push(n[d])}}}s=s.sort((e,t)=>e.SEQUENCE-t.SEQUENCE);l.oParameterModel.setData({parameters:s})}else{l.oParameterModel.setData({parameters:n})}l.byId("idParameterTable").setModel(l.oParameterModel)},getMethods:function(e){e.read("/Method_Types",{success:function(e){l.oMethodModel.setData({methods:e.results})},error:function(e){o.show("Failed to fetch Method Types!")}})},handleValueHelpRequest:function(e){var t=l.getView().byId("idParameterTable").getModel();var o=e.getSource().getBindingContext();var a=t.getProperty("VALUE_HELP_TAB",o);switch(a){case"Method_Types":l.oSelectedInputExe=e.getSource();if(l.oMethodDialog){l.oMethodDialog.setModel(l.oMethodModel);l.oMethodDialog.open()}}},onListItemPress:function(e){var t=e.getParameter("listItem").getTitle();l.sSelMethodTyp=e.getParameter("listItem").getInfo();if(l.oSelectedInputExe){l.oSelectedInputExe.setValue(t);l.oSelectedInputExe.setName(l.sSelMethodTyp)}l.oMethodDialog.close()},onCloseDialog:function(){if(l.oMethodDialog){l.oMethodDialog.close()}},onParamValueChange:function(e){var t;l.oSelectedInput=e.getSource();var o=l.getView().byId("idParameterTable").getModel();var a=e.getSource().getBindingContext();var r=o.getProperty("MIN_VALUE",a);var n=o.getProperty("MAX_VALUE",a);var s=e.getParameter("newValue");if(a.getObject().PARAMETER_ID===9){var i=o.getData().parameters[0];r=i.VALUE}if(parseInt(n)>0){if(parseInt(s)<parseInt(r)||parseInt(s)>parseInt(n)){l.oSelectedInput.setValueState("Error");t="Please enter value between "+r+" and "+n;l.oSelectedInput.setValueStateText(t)}else{l.oSelectedInput.setValueState("None");t="";l.oSelectedInput.setValueStateText(t)}}},_onPatternMatched:function(e){var t=l.getOwnerComponent().getModel("PCModel");var o=e.getParameter("arguments");l.location=o.location;l.i18n=l.getOwnerComponent().getModel("i18n").getResourceBundle();l.getMethods(t)}})});