e:null,sap.ui.define(["cp/appf/cpsaleshconfig/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,o,r,i,a,s,l){"use strict";var n,d;return e.extend("cp.appf.cpsaleshconfig.controller.Home",{onInit:function(){var e=this;n=this;n.oGModel=n.getOwnerComponent().getModel("oGModel");n.oListModel=new r;this.locModel=new r;this.prodModel=new r;this.variantModel=new r;this.oListModel.setSizeLimit(5e3);n.locModel.setSizeLimit(1e3);n.prodModel.setSizeLimit(1e3);n.variantModel.setSizeLimit(5e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cp.appf.cpsaleshconfig.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cp.appf.cpsaleshconfig.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._nameFragment){this._nameFragment=sap.ui.xmlfragment("cp.appf.cpsaleshconfig.view.NameVariant",this);this.getView().addDependent(this._nameFragment)}if(!this._popOver){this._popOver=sap.ui.xmlfragment("cp.appf.cpsaleshconfig.view.VariantNames",this);this.getView().addDependent(this._popOver)}},onAfterRendering:function(){n=this;n.oList=this.byId("idTab");this.oProd=this.byId("prodInput");n._valueHelpDialogLoc.setTitleAlignment("Center");n._valueHelpDialogProd.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");n.oList.removeSelections();if(n.oList.getBinding("items")){n.oList.getBinding("items").filter([])}this.getData()},getData:function(){var e=[];var o=[];var r={};var i=[];this.getModel("BModel").callFunction("/getUserInfo",{success:function(e){n.oGModel.setProperty("/UserId",e.getUserInfo)},error:function(e){t.show("Failed to get User Details")}});this.getModel("BModel").read("/getLocation",{success:function(e){n.locModel.setData(e);n.oLocList.setModel(n.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,o){t.show("error")}});this.getModel("BModel").read("/getVariant",{success:function(t){var o=t.results.length;if(o===0){n.oGModel.setProperty("/Id",0);n.oGModel.setProperty("/variantDetails","")}else{for(var a=0;a<t.results.length;a++){if(n.oGModel.getProperty("/UserId")===t.results[a].USER){e.push({VARIANTNAME:t.results[a].VARIANTNAME,VARIANTID:t.results[a].VARIANTID,DEFAULT:t.results[a].DEFAULT,USER:n.oGModel.getProperty("/UserId")})}}var s=e.filter((e,t,o)=>o.map(e=>e.VARIANTNAME).indexOf(e.VARIANTNAME)==t);n.variantModel.setData({items:s});n.byId("Variants").setModel(n.variantModel);n.oGModel.setProperty("/Id",t.results[o-1].VARIANTID);n.oGModel.setProperty("/variantDetails",t.results);for(var l=0;l<s.length;l++){if(s[l].DEFAULT==="Y"){var d=s[l].VARIANTNAME;r={VARIANTNAME:s[l].VARIANTNAME,VARIANTID:s[l].VARIANTID,USER:s[l].USER,DEFAULT:"N"};i.push(r);r={}}}n.oGModel.setProperty("/defaultDetails",i);if(d){n.byId("Variants").setInitialSelectionKey(d)}n.oGModel.setProperty("/fromFunction","X");n.handleSelectPress(d)}},error:function(e,o){t.show("error while loading variant details")}});this.getModel("BModel").read("/getVariantHeader",{success:function(e){for(var t=0;t<e.results.length;t++){if(n.oGModel.getProperty("/UserId")===e.results[t].USER){o.push(e.results[t])}}n.oGModel.setProperty("/variantHeader",o)},error:function(e,o){t.show("error while loading variant details")}})},handleValueHelp:function(e){var o=e.getParameter("id");if(o.includes("loc")){n._valueHelpDialogLoc.open()}else if(o.includes("prod")){if(n.byId("idloc").getValue()!==""){n._valueHelpDialogProd.open()}else{t.show("Select Location")}}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(n.oLocList.getBinding("items")){n.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){n._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(n.oProdList.getBinding("items")){n.oProdList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),o=e.getParameter("id"),r=[];t=t?t.trim():"";if(o.includes("loc")){if(t!==""){r.push(new i({filters:[new i("LOCATION_ID",a.Contains,t),new i("LOCATION_DESC",a.Contains,t)],and:false}))}n.oLocList.getBinding("items").filter(r)}else if(o.includes("prod")){if(t!==""){r.push(new i({filters:[new i("PRODUCT_ID",a.Contains,t),new i("PROD_DESC",a.Contains,t)],and:false}))}n.oProdList.getBinding("items").filter(r)}else if(o.includes("var")){if(t!==""){r.push(new i({filters:[new i("VARIANTNAME",a.Contains,t),new i("APPLICATION_NAME",a.Contains,t)],and:false}))}sap.ui.getCore().byId("varSlctList").getBinding("items").filter(r)}},handleSelection:function(e){var o=e.getParameter("id"),r=e.getParameter("selectedItems"),s,l=[];if(o.includes("Loc")){this.oLoc=n.byId("idloc");s=e.getParameter("selectedItems");n.oLoc.setValue(s[0].getTitle());n.oProd.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new i("LOCATION_ID",a.EQ,s[0].getTitle())],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel)},error:function(e,o){t.show("error")}})}else if(o.includes("prod")){this.oProd=n.byId("prodInput");s=e.getParameter("selectedItems");if(s&&s.length>0){n.oProd.removeAllTokens();s.forEach(function(e){n.oProd.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))})}else{n.oProd.removeAllTokens()}}n.handleClose(e)},onGetData:function(e){var o=new Date(n.byId("idDate").getValue()),r,i;if(n.byId("idloc").getValue()!==""&&n.oProdList.getSelectedItems().length!==0){var a=n.oProdList.getSelectedItems();var s=[];if(n.byId("idDate").getValue()!==""){r=o.getMonth()+1;if(r<10){r="0"+r}else{r=r}if(o.getDate<10){i="0"+o.getDate()}else{i=o.getDate()}var l=o.getFullYear()+"-"+r+"-"+i;var d=new sap.ui.model.Filter({path:"DOC_CREATEDDATE",operator:sap.ui.model.FilterOperator.EQ,value1:l});s.push(d)}var d=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:n.oLoc.getValue()});s.push(d);for(var c=0;c<a.length;c++){if(a[c].getTitle()!=="All"){d=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:a[c].getTitle()});s.push(d)}}sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getSalesh",{filters:s,success:function(e){n.oListModel.setData({results:e.results});n.oList.setModel(n.oListModel);sap.ui.core.BusyIndicator.hide()},error:function(e){t.show("error");sap.ui.core.BusyIndicator.hide()}})}else{t.show("Please fill all required inputs")}},onhandlePress:function(e){n.oGModel=n.getModel("oGModel");var t=n.byId("idTab").getSelectedItem().getBindingContext().getObject();n.oGModel.setProperty("/selItem",t);n.oGModel.setProperty("/sSalOrd",t.SALES_DOC);n.oGModel.setProperty("/sSalOrdItem",t.SALESDOC_ITEM);n.oGModel.setProperty("/sPrdid",t.PRODUCT_ID);n.oGModel.setProperty("/sLocid",t.LOCATION_ID);n.oGModel.setProperty("/date",e.getSource().getSelectedItem().getCells()[2].getText());var o=sap.ui.core.UIComponent.getRouterFor(n);o.navTo("Detail",{},true)},onTableSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),o=[];if(t!==""){o.push(new i({filters:[new i("SALES_DOC",a.Contains,t),new i("PRODUCT_ID",a.Contains,t),new i("LOCATION_ID",a.Contains,t)],and:false}))}n.oList.getBinding("items").filter(o)},onNavPress:function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var e=sap.ushell.Container.getService("CrossApplicationNavigation");var t=e&&e.hrefForExternal({target:{semanticObject:"vcpdocdisplay",action:"Display"}})||"";var o=window.location.href.split("#")[0]+t;sap.m.URLHelper.redirect(o,true)}},onSaveAs:function(){},onClose:function(){this._nameFragment.close()},onCreate:function(e){var o={RTRCHAR:[]};var r=[];var i={};var a=n.byId("idloc").getValue();var s=n.byId("idloc").getParent().getItems()[0].getText();var l=n.byId("prodInput").getTokens();var d=n.byId("prodInput").getParent().getItems()[0].getText();var c=e.getParameters().name;var g=document.getElementById("container-cp.appf.cpsaleshconfig---Home--Variants-share-CB");if(g.checked){var u="Public"}else{var u="Private"}var p=document.getElementById("container-cp.appf.cpsaleshconfig---Home--Variants-default-CB");if(p.checked){var f="Y";n.getModel("BModel").callFunction("/updateVariant",{method:"GET",urlParameters:{VARDATA:JSON.stringify(n.oGModel.getProperty("/defaultDetails"))},success:function(e){t.show(e)},error:function(e){t.show("Failed to create variant")}})}else{var f="N"}i={Field:s,FieldCenter:1..toString(),Value:a,Scope:u,Default:f};r.push(i);for(var h=0;h<l.length;h++){i={Field:d,FieldCenter:(h+1).toString(),Value:l[h].getText(),Scope:u,Default:f};r.push(i)}for(var v=0;v<r.length;v++){var I=n.oGModel.getProperty("/Id");if(I===undefined){I=0}I=I+1;r[v].ID=I;r[v].IDNAME=c;r[v].App_Name="Sales History Configuration"}n.getModel("BModel").callFunction("/createVariant",{method:"GET",urlParameters:{Flag:"X",VARDATA:JSON.stringify(r)},success:function(e){t.show(e.createVariant);n.onAfterRendering()},error:function(e){t.show("Failed to create variant")}})},handleSelectPress:function(e){var o,r={},s=[];var l=n.oGModel.getProperty("/variantDetails");if(n.oGModel.getProperty("/fromFunction")==="X"){n.oGModel.setProperty("/fromFunction","");var d=e}else{var c=e.getSource().getSelectionKey();if(c.includes("SV")){var d=l[l.length-1].VARIANTNAME}else{var d=c}}for(var g=0;g<l.length;g++){if(d===l[g].VARIANTNAME){if(l[g].FIELD.includes("Loc")){o=l[g].VALUE}else if(l[g].FIELD.includes("Prod")){var u=new sap.m.Token({key:g,text:l[g].VALUE});s.push(u);u={}}}}n.byId("idloc").setValue(o);this.getModel("BModel").read("/getLocProdDet",{filters:[new i("LOCATION_ID",a.EQ,o)],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel);n.oProdList.removeSelections();for(var t=0;t<s.length;t++){for(var o=0;o<n.oProdList.getItems().length;o++){if(n.oProdList.getItems()[o].getTitle()===s[t].getText()){n.oProdList.getItems()[o].setSelected(true)}}}},error:function(e,o){t.show("error")}});n.byId("prodInput").setTokens(s)},onManage:function(e){var o={};var r=[];var i=e.getParameters().deleted;var a=n.oGModel.getProperty("/variantHeader");var s=n.oGModel.getProperty("/variantDetails");for(var l=0;l<i.length;l++){for(var d=0;d<s.length;d++){if(i[l]===s[d].VARIANTNAME){o={ID:s[d].VARIANTID,NAME:s[d].VARIANTNAME};r.push(o);o={}}}}var c=r.filter((e,t,o)=>o.map(e=>e.ID).indexOf(e.ID)==t);n.getModel("BModel").callFunction("/createVariant",{method:"GET",urlParameters:{Flag:"D",VARDATA:JSON.stringify(c)},success:function(e){t.show(e.createVariant);n.getData()},error:function(e){t.show("Failed to create variant")}})}})});