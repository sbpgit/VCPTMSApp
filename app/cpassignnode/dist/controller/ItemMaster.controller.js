sap.ui.define(["cpapp/cpassignnode/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,s,o,i,a,c){"use strict";var n,d;return e.extend("cpapp.cpassignnode.controller.ItemMaster",{onInit:function(){n=this;n.oModel=new s;this.locModel=new s;this.prodModel=new s;this.accModel=new s;this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpassignnode.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpassignnode.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._oAccesNode){this._oAccesNode=sap.ui.xmlfragment("cpapp.cpassignnode.view.AccesNodes",n);n.getView().addDependent(this._oAccesNode)}if(!this._oAccesNodeList){this._oAccesNodeList=sap.ui.xmlfragment("cpapp.cpassignnode.view.AccessNodesList",n);n.getView().addDependent(this._oAccesNodeList)}this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")})},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){n=this;d=this.getModel("oGModel");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oAccList=this._oCore.byId(this._oAccesNodeList.getId()+"-list");this.getModel("BModel").read("/genProdAccessNode",{success:function(e){n.oModel.setData({results:e.results});n.byId("accessList").setModel(n.oModel)},error:function(){t.show("Failed to get data")}});this.getModel("BModel").read("/getLocation",{success:function(e){n.locModel.setData(e);n.oLocList.setModel(n.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,s){t.show("error")}});this.getModel("BModel").read("/getNodes",{success:function(e){n.AccessNodes=[];for(var t=0;t<e.results.length;t++){if(e.results[t].NODE_TYPE==="AN"){n.AccessNodes.push(e.results[t])}}n.accModel.setData({results:n.AccessNodes});n.oAccList.setModel(n.accModel);sap.ui.core.BusyIndicator.hide()},error:function(){t.show("Failed to get data")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._valueHelpDialogLoc.open()}else if(t.includes("prod")){n._valueHelpDialogProd.open()}else if(t.includes("accn")){n._oAccesNodeList.open()}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(n.oLocList.getBinding("items")){n.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){n._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(n.oProdList.getBinding("items")){n.oProdList.getBinding("items").filter([])}}else if(t.includes("acc")){n._oCore.byId(this._oAccesNodeList.getId()+"-searchField").setValue("");if(n.oAccList.getBinding("items")){n.oAccList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=e.getParameter("id"),a=[];t=t?t.trim():"";if(s.includes("loc")){if(t!==""){a.push(new o({filters:[new o("LOCATION_ID",i.Contains,t),new o("LOCATION_DESC",i.Contains,t)],and:false}))}n.oLocList.getBinding("items").filter(a)}else if(s.includes("prod")){if(t!==""){a.push(new o({filters:[new o("PRODUCT_ID",i.Contains,t),new o("PROD_DESC",i.Contains,t)],and:false}))}n.oProdList.getBinding("items").filter(a)}else if(s.includes("acc")){if(t!==""){a.push(new o({filters:[new o("CHILD_NODE",i.Contains,t),new o("NODE_DESC",i.Contains,t)],and:false}))}n.oAccList.getBinding("items").filter(a)}},handleSelection:function(e){var s=e.getParameter("id"),a=e.getParameter("selectedItems"),c,d=[];if(s.includes("Loc")){this.oLoc=sap.ui.getCore().byId(sap.ui.getCore().byId("SimpleFormToolbar").getContent()[1].getId());c=e.getParameter("selectedItems");n.oLoc.setValue(c[0].getTitle());this.getModel("BModel").read("/getLocProdDet",{filters:[new o("LOCATION_ID",i.EQ,c[0].getTitle())],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel)},error:function(e,s){t.show("error")}})}else if(s.includes("prod")){this.oProd=sap.ui.getCore().byId(sap.ui.getCore().byId("SimpleFormToolbar").getContent()[3].getId());c=e.getParameter("selectedItems");n.oProd.setValue(c[0].getTitle())}else if(s.includes("acc")){this.oAccn=sap.ui.getCore().byId(sap.ui.getCore().byId("SimpleFormToolbar").getContent()[5].getId());c=e.getParameter("selectedItems");n.oAccn.setValue(c[0].getTitle())}n.handleClose(e)},onhandlePress:function(e){d=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getTitle(),s=e.getSource().getSelectedItem().getDescription(),o=e.getSource().getSelectedItem().getInfo();d.setProperty("/SelectedProd",t);d.setProperty("/SelectedLoc",s);d.setProperty("/SelectedNode",o)}else{}n.getOwnerComponent().runAsOwner(function(){if(!n.oDetailView){try{n.oDetailView=sap.ui.view({viewName:"cpapp.cpassignnode.view.ItemDetail",type:"XML"});n.bus.publish("flexible","addDetailPage",n.oDetailView);n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}catch(e){n.oDetailView.onAfterRendering()}}else{n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}})},onSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=[];if(t!==""){s.push(new o({filters:[new o("PRODUCT_ID",i.Contains,t),new o("LOCATION_ID",i.Contains,t)],and:false}))}n.byId("accessList").getBinding("items").filter(s)},onAccNode:function(e){if(!n._oAccesNode){n._oAccesNode=sap.ui.xmlfragment("cpapp.cpassignnode.view.AccesNodes",n);n.getView().addDependent(n._oAccesNode)}d=this.getModel("oGModel");d.setProperty("/Flag","");if(e.getSource().getTooltip().includes("Add")){n._oAccesNode.setTitle("Assign Access Node");d.setProperty("/Flag","C");n._oAccesNode.open()}else{if(this.byId("accessList").getSelectedItems().length){var s=this.byId("accessList").getSelectedItem().getCells()[0];n._oAccesNode.setTitle("Update Access Node");sap.ui.getCore().byId("idAccesNode").setValue(s.getTitle());sap.ui.getCore().byId("idDesc").setValue(s.getText());sap.ui.getCore().byId("idAccesNode").setEditable(false);d.setProperty("/Flag","E");n._oAccesNode.open()}else{t.show("Select access node to update")}}},onAccNodeClose:function(){n._oAccesNode.close();n._oAccesNode.destroy(true);n._oAccesNode=""},onAccNodeDel:function(e){var t=d.getProperty("/SelectedLoc"),s=d.getProperty("/SelectedProd");var o="Please confirm to remove access node"+" - "+t+" "+"-"+" "+s;sap.m.MessageBox.show(o,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.core.BusyIndicator.show();var o="/v2/catalog/genProdAccessNode";$.ajax({url:o,type:"post",contentType:"application/json",data:JSON.stringify({LOCATION_ID:t,PRODUCT_ID:s,ACCESS_NODE:"D"}),dataType:"json",async:false,timeout:0,success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Access Node deleted successfully");n.onAfterRendering()},error:function(e){sap.m.MessageToast.show(JSON.stringify(e))}})}}})},onAccessNodeSave:function(){var e=sap.ui.getCore().byId("idloc").getValue();var t=sap.ui.getCore().byId("idprod").getValue();var s=sap.ui.getCore().byId("idaccn").getValue();var o="/v2/catalog/genProdAccessNode";$.ajax({url:o,type:"post",contentType:"application/json",data:JSON.stringify({LOCATION_ID:e,PRODUCT_ID:t,ACCESS_NODE:s}),dataType:"json",async:false,timeout:0,success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.d.results[0].value);n.onAccNodeClose();n.onAfterRendering()},error:function(e){sap.m.MessageToast.show(JSON.stringify(e))}})}})});