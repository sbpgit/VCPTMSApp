sap.ui.define(["cpapp/cpbompvs/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,s,r,o,a,i,n){"use strict";var l,d;return e.extend("cpapp.cpbompvs.controller.ItemDetail",{onInit:function(){l=this;this.bus=sap.ui.getCore().getEventBus();l.oAssignModel=new r;l.oStruModelDetail=new r;l.oAssinModel=new r;l.oAssignModel.setSizeLimit(1e3);l.oStruModelDetail.setSizeLimit(1e3);d=l.getOwnerComponent().getModel("oGModel");d.setProperty("/resetFlag","")},onAfterRendering:function(){sap.ui.core.BusyIndicator.show();d=l.getOwnerComponent().getModel("oGModel");l.byId("detailNode").setSelectedKey("assignNode");l.byId("idTextfrom").setVisible(true);l.byId("fromDate").setVisible(true);l.byId("idTextto").setVisible(true);l.byId("toDate").setVisible(true);l.byId("idButton").setVisible(true);l.byId("fromDate").setValue("");l.byId("toDate").setValue("");l.byId("sturList").removeSelections();var e=d.getProperty("/SelectedLoc");var s=d.getProperty("/SelectedProd");this.getModel("BModel").read("/getPVSBOM",{filters:[new o("PRODUCT_ID",a.EQ,s),new o("LOCATION_ID",a.EQ,e)],success:function(e){sap.ui.core.BusyIndicator.hide();l.oAssignModel.setData({results:e.results});l.byId("sturList").setModel(l.oAssignModel)},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}});if(d.getProperty("/resetFlag")===""){this.getModel("BModel").read("/genCompStrcNode",{filters:[new o("PRODUCT_ID",a.EQ,s),new o("LOCATION_ID",a.EQ,e)],success:function(e){d.setProperty("/tableData",e.results);l.aReqTabData();var t=d.getProperty("/reqData");l.oStruModelDetail.setData({struDetailresults:t.Requests});l.byId("StrunodeTable").setModel(l.oStruModelDetail);sap.ui.core.BusyIndicator.hide()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})}},aReqTabData:function(e){var t=e?e.results:d.getProperty("/tableData"),s={Requests:[]},r=[],o,a,i,n=function(e,t,s){var r=JSON.parse(JSON.stringify(e)),o=JSON.parse(JSON.stringify(t)),a=JSON.parse(JSON.stringify(e));o._isParent=false;if(r.children.length===0){a._isParent=false;r.children.push(a)}r.children.push(o);return r};for(var l=0;l<t.length;l++){o=r.indexOf(t[l].STRUC_NODE);if(o===-1){r.push(t[l].STRUC_NODE);t[l].children=[];t[l]._isParent=true;s.Requests.push(t[l])}else{a=s.Requests[o];i=n(a,t[l],"Reqs");s.Requests[o]=i}}d.setProperty("/reqData",s)},onStruNodeSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=d.getProperty("/tableData"),r=[];if(t&&t.trim()!==""){t=t.trim().toLocaleUpperCase();for(var o=0;o<s.length;o++){if(s[o].STRUC_NODE.includes(t)||s[o].COMPONENT.includes(t)){r.push(s[o])}}}else{r=s}l.aReqTabData({results:r});var a=d.getProperty("/reqData");l.oStruModelDetail.setData({struDetailresults:a.Requests})},onTabChange:function(e){var t=l.byId("detailNode").getSelectedKey();if(t==="assignNode"){l.byId("idTextfrom").setVisible(true);l.byId("fromDate").setVisible(true);l.byId("idTextto").setVisible(true);l.byId("toDate").setVisible(true);l.byId("idButton").setVisible(true)}else if(t==="StruNodeDetail"){l.byId("idTextfrom").setVisible(false);l.byId("fromDate").setVisible(false);l.byId("idTextto").setVisible(false);l.byId("toDate").setVisible(false);l.byId("idButton").setVisible(false)}},onGetData:function(e){sap.ui.core.BusyIndicator.show();d=l.getOwnerComponent().getModel("oGModel");l.byId("sturList").removeSelections();var s=d.getProperty("/SelectedLoc");var r=d.getProperty("/SelectedProd");var i=new Date(l.byId("fromDate").getDateValue()),n=new Date(l.byId("toDate").getDateValue());var u,c,g,p;var f=i.getMonth()+1,D=n.getMonth()+1;if(f<10){u="0"+f}else{u=f}if(i.getDate()<10){c="0"+i.getDate()}else{c=i.getDate()}if(D<10){g="0"+D}else{g=D}if(n.getDate()<10){p="0"+n.getDate()}else{p=n.getDate()}i=i.getFullYear()+"-"+u+"-"+c;n=n.getFullYear()+"-"+g+"-"+p;this.getModel("BModel").read("/getPVSBOM",{filters:[new o("PRODUCT_ID",a.EQ,r),new o("LOCATION_ID",a.EQ,s),new o("VALID_FROM",a.EQ,i),new o("VALID_TO",a.EQ,n)],success:function(e){sap.ui.core.BusyIndicator.hide();l.oAssignModel.setData({results:e.results});l.byId("sturList").setModel(l.oAssignModel)},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})},onResetDate:function(){l.byId("fromDate").setValue("");l.byId("toDate").setValue("");d.setProperty("/resetFlag","X");l.onAfterRendering()},onDetailSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=[];t=t?t.trim():"";if(t!==""){s.push(new o({filters:[new o("COMPONENT",a.Contains,t),new o("STRUC_NODE",a.Contains,t)],and:false}))}l.byId("sturList").getBinding("items").filter(s)},onAssign:function(e){if(!l._oStruNode){l._oStruNode=sap.ui.xmlfragment("cpapp.cpbompvs.view.StructureNodes",l);l.getView().addDependent(l._oStruNode)}if(l.byId("sturList").getSelectedItems().length===1){var s=d.getProperty("/SelectedNode");var r=l.byId("sturList").getSelectedItem().getCells()[1].getText();var i=l.byId("sturList").getSelectedItem().getCells()[0].getText();d.setProperty("/SelecteComponent",r);d.setProperty("/SelecteItem",i);this.getModel("BModel").read("/getPVSNodes",{filters:[new o("PARENT_NODE",a.EQ,s),new o("NODE_TYPE",a.EQ,"SN")],success:function(e){l.oAssinModel.setData({results:e.results});sap.ui.getCore().byId("sturList").setModel(l.oAssinModel);l._oStruNode.open()},error:function(){t.show("Failed to get data")}})}else{t.show("Please select compponent to assign structure node")}},handleStruSelection:function(e){l=this;var t=d.getProperty("/SelectedLoc"),s=d.getProperty("/SelectedProd"),r=d.getProperty("/SelecteComponent"),o=d.getProperty("/SelecteItem"),a=e.getParameter("selectedItems")[0].getTitle();l.getModel("BModel").callFunction("/genCompSN",{method:"GET",urlParameters:{LOCATION_ID:t,PRODUCT_ID:s,COMPONENT:r,ITEM_NUM:o,STRUC_NODE:a},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Structure Node assigned successfully");d.setProperty("/resetFlag","");l.onAfterRendering()},error:function(e){sap.m.MessageToast.show(JSON.stringify(e))}})},handleStruSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=[];t=t?t.trim():"";if(t!==""){s.push(new o({filters:[new o("CHILD_NODE",a.Contains,t),new o("NODE_DESC",a.Contains,t)],and:false}))}l._oStruNode.getBinding("items").filter(s)},onStructureNodeDel:function(e){var t=d.getProperty("/SelectedLoc"),s=d.getProperty("/SelectedProd"),r=e.getSource().getParent().getCells()[0].getText(),o=e.getSource().getParent().getCells()[1].getText();l.getModel("BModel").callFunction("/genCompSN",{method:"GET",urlParameters:{LOCATION_ID:t,PRODUCT_ID:s,ITEM_NUM:r,COMPONENT:o,STRUC_NODE:"D"},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Structure Node deleted");l.onAfterRendering()},error:function(e){sap.m.MessageToast.show(JSON.stringify(e))}})}})});