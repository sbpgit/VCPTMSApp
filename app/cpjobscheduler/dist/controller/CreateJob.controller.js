sap.ui.define(["cpapp/cpjobscheduler/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,i,l,o,s,a){"use strict";var r;return e.extend("cpapp.cpjobscheduler.controller.CreateJob",{onInit:function(){r=this;this.locModel=new t;this.prodModel=new t;this.odModel=new t;this.ppfModel=new t;this.verModel=new t;this.scenModel=new t;this.prodModel.setSizeLimit(2e3);this.odModel.setSizeLimit(2e3);this.ppfModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogOD){this._valueHelpDialogOD=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.ObjDepDialog",this);this.getView().addDependent(this._valueHelpDialogOD)}if(!this._valueHelpDialogPPF){this._valueHelpDialogPPF=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.PredDialog",this);this.getView().addDependent(this._valueHelpDialogPPF)}if(!this._valueHelpDialogVer){this._valueHelpDialogVer=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.VersionDialog",this);this.getView().addDependent(this._valueHelpDialogVer)}if(!this._valueHelpDialogScen){this._valueHelpDialogScen=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.ScenarioDialog",this);this.getView().addDependent(this._valueHelpDialogScen)}if(!this._valueHelpDialogJobDetail){this._valueHelpDialogJobDetail=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.CreateJobDetails",this);this.getView().addDependent(this._valueHelpDialogJobDetail)}},onAfterRendering:function(){sap.ui.core.BusyIndicator.show();this.i18n=this.getResourceBundle();this.oGModel=this.getModel("oGModel");r._valueHelpDialogProd.setTitleAlignment("Center");r._valueHelpDialogLoc.setTitleAlignment("Center");r._valueHelpDialogOD.setTitleAlignment("Center");r._valueHelpDialogPPF.setTitleAlignment("Center");r._valueHelpDialogVer.setTitleAlignment("Center");r._valueHelpDialogScen.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oODList=this._oCore.byId(this._valueHelpDialogOD.getId()+"-list");this.oPPFList=this._oCore.byId(this._valueHelpDialogPPF.getId()+"-list");this.oVerList=this._oCore.byId(this._valueHelpDialogVer.getId()+"-list");this.oScenList=this._oCore.byId(this._valueHelpDialogScen.getId()+"-list");r.onJobSelect();this.getModel("BModel").read("/getLocation",{success:function(e){sap.ui.core.BusyIndicator.hide();r.locModel.setData(e);r.oLocList.setModel(r.locModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();l.show("error")}});this.getModel("BModel").read("/getProfiles",{success:function(e){sap.ui.core.BusyIndicator.hide();r.ppfModel.setData(e);r.oPPFList.setModel(r.ppfModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();l.show("error")}});r.byId("modelGenPanel").setVisible(true);r.byId("PredPanel").setVisible(false);r.byId("timeSeriesPanel").setVisible(false);r.byId("IbpPanel").setVisible(false);r.byId("idJobType").setSelectedKey("M")},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(r);e.navTo("Home",{},true)},onJobSelect:function(e){var t=r.byId("idJobType").getSelectedKey();if(t==="M"){r.byId("modelGenPanel").setVisible(true);r.byId("PredPanel").setVisible(false);r.byId("timeSeriesPanel").setVisible(false);r.byId("IbpPanel").setVisible(false)}else if(t==="P"){r.byId("modelGenPanel").setVisible(false);r.byId("PredPanel").setVisible(true);r.byId("timeSeriesPanel").setVisible(false);r.byId("IbpPanel").setVisible(false)}else if(t==="T"){r.byId("modelGenPanel").setVisible(false);r.byId("PredPanel").setVisible(false);r.byId("timeSeriesPanel").setVisible(true);r.byId("IbpPanel").setVisible(false)}else if(t==="I"){r.byId("modelGenPanel").setVisible(false);r.byId("PredPanel").setVisible(false);r.byId("timeSeriesPanel").setVisible(false);r.byId("IbpPanel").setVisible(true)}this.oGModel.setProperty("/JobDdesc",r.byId("idJobType").getSelectedItem().getText());r.byId("MlocInput").setValue("");r.byId("MprodInput").setValue("");r.byId("MpmInput").setValue("");r.byId("PlocInput").setValue("");r.byId("PprodInput").setValue("");r.byId("Pidver").setValue("");r.byId("Pidscen").setValue("");r.byId("TprodInput").setValue("");r.byId("TlocInput").setValue("");r.byId("IlocInput").setValue("");r.JobType()},handleValueHelp:function(e){var t=e.getParameter("id");var i=r.byId("idJobType").getSelectedKey();if(t.includes("loc")){this._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(r.oLoc.getValue()){if(i==="M"||i==="P"){sap.ui.getCore().byId("prodSlctList").setMultiSelect(true);sap.ui.getCore().byId("prodSlctList").setRememberSelections(true)}else if(i==="T"||i==="I"){sap.ui.getCore().byId("prodSlctList").setMultiSelect(false);sap.ui.getCore().byId("prodSlctList").setRememberSelections(false)}this._valueHelpDialogProd.open()}else{l.show(r.i18n.getText("Select Location"))}}else if(t.includes("ver")){if(r.oLoc.getValue()&&r.oProd.getTokens().length!==0){r._valueHelpDialogVer.open()}else{l.show(r.i18n.getText("noLocProd"))}}else if(t.includes("scen")){if(r.oLoc.getValue()&&r.oProd.getTokens().length&&r.oVer.getValue()){r._valueHelpDialogScen.open()}else{l.show("Select Location, Product and Version")}}else if(t.includes("MpmInput")){r._valueHelpDialogPPF.open()}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("loc")){r._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(r.oLocList.getBinding("items")){r.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){r._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(r.oProdList.getBinding("items")){r.oProdList.getBinding("items").filter([])}}else if(t.includes("Ver")){r._oCore.byId(this._valueHelpDialogVer.getId()+"-searchField").setValue("");if(r.oVerList.getBinding("items")){r.oVerList.getBinding("items").filter([])}}else if(t.includes("scen")){r._oCore.byId(this._valueHelpDialogScen.getId()+"-searchField").setValue("");if(r.oScenList.getBinding("items")){r.oScenList.getBinding("items").filter([])}}else if(t.includes("ppfSlctList")){r._oCore.byId(this._valueHelpDialogPPF.getId()+"-searchField").setValue("");if(r.oPPFList.getBinding("items")){r.oPPFList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=e.getParameter("id"),l=[];t=t?t.trim():"";if(i.includes("loc")){if(t!==""){l.push(new s({filters:[new s("LOCATION_ID",a.Contains,t),new s("LOCATION_DESC",a.Contains,t)],and:false}))}r.oLocList.getBinding("items").filter(l)}else if(i.includes("prod")){if(t!==""){l.push(new s({filters:[new s("PRODUCT_ID",a.Contains,t),new s("PROD_DESC",a.Contains,t)],and:false}))}r.oProdList.getBinding("items").filter(l)}else if(i.includes("ver")){if(t!==""){l.push(new s({filters:[new s("VERSION",a.Contains,t)],and:false}))}r.oVerList.getBinding("items").filter(l)}else if(i.includes("scen")){if(t!==""){l.push(new s({filters:[new s("SCENARIO",a.Contains,t)],and:false}))}r.oScenList.getBinding("items").filter(l)}else if(i.includes("ppfSlctList")){if(t!==""){l.push(new s({filters:[new s("PROFILE",a.Contains,t),new s("PRF_DESC",a.Contains,t),new s("METHOD",a.Contains,t)],and:false}))}r.oPPFList.getBinding("items").filter(l)}},JobType:function(){var e=r.byId("idJobType").getSelectedKey();if(e==="M"){r.oLoc=this.byId("MlocInput");r.oProd=this.byId("MprodInput");r.oPredProfile=this.byId("MpmInput");r.oProd.removeAllTokens()}else if(e==="P"){r.oLoc=this.byId("PlocInput");r.oProd=this.byId("PprodInput");r.oVer=this.byId("Pidver");r.oScen=this.byId("Pidscen");r.oProd.removeAllTokens()}else if(e==="T"){r.oLoc=this.byId("TlocInput");r.oProd=this.byId("TprodInput")}else if(e==="I"){r.oLoc=this.byId("IlocInput")}},handleSelection:function(e){var t=e.getParameter("id"),i=e.getParameter("selectedItems"),o,d,n=[];var u=r.byId("idJobType").getSelectedKey();if(t.includes("Loc")){var g=e.getParameter("selectedItems");r.oLoc.setValue(g[0].getTitle());if(u==="M"||u==="P"){r.oProd.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections()}if(u==="P"){r.oVer.setValue("");r.oScen.setValue("")}if(u==="T"||u==="I"){var c=sap.ui.getCore().byId("prodSlctList").getItems();for(var p=0;p<c.length;p++){if(c[p].getSelected()===true){c[p].setSelected(false)}}}this.getModel("BModel").read("/getLocProdDet",{filters:[new s("LOCATION_ID",a.EQ,g[0].getTitle())],success:function(e){if(u==="M"||u==="P"){if(e.results.length>0){e.results.unshift({PRODUCT_ID:"All",PROD_DESC:"All"})}}r.prodModel.setData(e);r.oProdList.setModel(r.prodModel)},error:function(e,t){l.show("error")}})}else if(t.includes("prod")){var h;r.oProdList.getBinding("items").filter([]);h=e.getParameter("selectedItems");if(h&&h.length>0){var f=[];var I=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:r.oLoc.getValue()});f.push(I);for(var p=0;p<h.length;p++){if(h[p].getTitle()!=="All"){I=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:h[p].getTitle()});f.push(I)}}if(u==="T"||u==="I"){r.oProd.setValue(h[0].getTitle())}if(u==="M"||u==="P"){r.oProd.removeAllTokens();h.forEach(function(e){r.oProd.addToken(new sap.m.Token({key:e.getTitle(),text:e.getTitle()}))})}if(u==="P"){this.getModel("BModel").read("/getIbpVerScn",{filters:f,success:function(e){r.verModel.setData(e);r.oVerList.setModel(r.verModel)},error:function(e,t){l.show("error")}})}}else{if(u==="M"||u==="P"){r.oProd.removeAllTokens()}}}else if(t.includes("Ver")){d=e.getParameter("selectedItems");r.oVer.setValue(d[0].getTitle());r.oScen.setValue("");var h=r.oProdList.getSelectedItems();var f=[];var I=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:r.oLoc.getValue()});f.push(I);var I=new sap.ui.model.Filter({path:"VERSION",operator:sap.ui.model.FilterOperator.EQ,value1:d[0].getTitle()});f.push(I);for(var p=0;p<h.length;p++){if(h[p].getTitle()!=="All"){I=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:h[p].getTitle()});f.push(I)}}this.getModel("BModel").read("/getIbpVerScn",{filters:f,success:function(e){r.scenModel.setData(e);r.oScenList.setModel(r.scenModel)},error:function(e,t){l.show("error")}})}else if(t.includes("scen")){var m=e.getParameter("selectedItems");r.oScen.setValue(m[0].getTitle())}else if(t.includes("ppfSlctList")){var P=e.getParameter("selectedItems");r.oPredProfile.setValue(P[0].getTitle())}r.handleClose(e)},handleProdChange:function(e){var t=e.getParameter("listItem").getTitle();var i=sap.ui.getCore().byId("prodSlctList").getItems();var l=this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].getSelectedItems();if(t==="All"&&e.getParameter("selected")&&i.length!==1){this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].selectAll()}else if(t==="All"&&!e.getParameter("selected")){this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections()}else if(t==="All"&&i.length===1){sap.ui.getCore().byId("prodSlctList").getItems()[0].setSelected(false)}else if(t!=="All"&&!e.getParameter("selected")&&i.length-1===l.length){sap.ui.getCore().byId("prodSlctList").getItems()[0].setSelected(false)}else if(t!=="All"&&e.getParameter("selected")&&i.length-1===l.length){sap.ui.getCore().byId("prodSlctList").getItems()[0].setSelected(true)}},onModelGen:function(){var e=r.byId("MidCheck").getSelected();r.oGModel.setProperty("/runText","Generate Model");this.oModel=this.getModel("PModel");var t,i,o,e,s,a,o,d,n,u=[],g;var c={vcRulesList:[]},p,h={};var f=r.byId("Midmdlver").getSelectedKey(),I;t=this.oODList.getSelectedItems();d=r.oLoc.getValue();i=this.oProdList.getSelectedItems(),o=r.oPredProfile.getValue(),e=r.byId("MidCheck").getSelected();if(f==="act"){I="Active"}else{I="Simulation"}if(this.oProd.getTokens().length>0&&this.oPredProfile.getValue()){for(n=0;n<i.length;n++){p={profile:o,override:e,Location:d,Product:i[n].getTitle(),GroupID:"All",Type:"OD",modelVersion:I};c.vcRulesList.push(p)}this.oGModel.setProperty("/vcrulesData",c.vcRulesList);var m="Do you want to override assignments?";if(e===true){sap.m.MessageBox.show(m,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){r._valueHelpDialogJobDetail.open()}}})}else{r._valueHelpDialogJobDetail.open()}}else{l.show("Please select all fields")}},onPrediction:function(){var e=r.byId("PidCheck").getSelected();r.oGModel.setProperty("/runText","Run Prediction");this.oModel=this.getModel("PModel");var t,i,o,e,s,a,d,n,u,g,c=[],p;var h={vcRulesList:[]},f,I={};t=this.oODList.getSelectedItems();n=r.oLoc.getValue();i=this.oProdList.getSelectedItems();e=r.byId("PidCheck").getSelected();s=this.byId("PidModelVer").getSelectedKey();d=this.oVer.getValue();u=this.oScen.getValue();if(this.oProd.getTokens().length>0&&this.oVer.getValue()&&this.oScen.getValue()){for(g=0;g<i.length;g++){f={override:e,Location:n,Product:i[g].getTitle(),GroupID:"All",Type:"OD",modelVersion:s,version:d,scenario:u};h.vcRulesList.push(f)}this.oGModel.setProperty("/vcrulesData",h.vcRulesList);var m="Do you want to override assignments?";if(e===true){sap.m.MessageBox.show(m,{title:"Confirmation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){r._valueHelpDialogJobDetail.open()}}})}else{r._valueHelpDialogJobDetail.open()}}else{l.show("Please select all fields")}},onCreateJobClose:function(){this._oCore.byId("idname").setValue();this._oCore.byId("idDesc").setValue();this._oCore.byId("idSTime").setValue();this._oCore.byId("idETime").setValue();this._oCore.byId("idcron").setValue();this._oCore.byId("idSSTime").setValue();this._oCore.byId("idSETime").setValue();r.oGModel.setProperty("/runText","");r._valueHelpDialogJobDetail.close()},onCronChange:function(e){sap.ui.getCore().byId("idCrontype").setSelectedKey("Mi")},handleChange:function(e){var t=e.getParameter("id");if(t.includes("idSTime")||t.includes("idSSTime")){var i=this._oCore.byId("idSTime").getDateValue();sap.ui.getCore().byId("idSTime").setDateValue(i);sap.ui.getCore().byId("idSSTime").setDateValue(i)}else if(t.includes("idETime")||t.includes("idSETime")){var l=this._oCore.byId("idETime").getDateValue();sap.ui.getCore().byId("idETime").setDateValue(l);sap.ui.getCore().byId("idSETime").setDateValue(l)}},onJobCreate:function(){var e=r.oGModel.getProperty("/runText"),t=sap.ui.getCore().byId("idname").getValue(),i=(new Date).getTimezoneOffset(),l=this._oCore.byId("idSTime").getDateValue(),o=this._oCore.byId("idETime").getDateValue(),s=this._oCore.byId("idSSTime").getDateValue(),a=this._oCore.byId("idSETime").getDateValue(),d,n,u,g;l=l.toISOString().split("T");d=l[1].split(":");o=o.toISOString().split("T");n=o[1].split(":");s=s.toISOString().split("T");u=s[1].split(":");a=a.toISOString().split("T");g=a[1].split(":");var c=sap.ui.getCore().byId("idcron").getValue(),p=(new Date).toLocaleString().split(" "),h=t+(new Date).getTime(),f;c="* * * * * *%2F"+c+" "+"0";l=l[0]+" "+d[0]+":"+d[1]+" "+"+0000";o=o[0]+" "+n[0]+":"+n[1]+" "+"+0000";s=s[0]+" "+u[0]+":"+u[1]+" "+"+0000";a=a[0]+" "+g[0]+":"+g[1]+" "+"+0000";if(e.includes("Prediction")){f="%2Fpal%2FgenPredictions"}else if(e.includes("Model")){f="%2Fpal%2FgenerateModels"}var I=this.oGModel.getProperty("/vcrulesData");var m={name:h,description:sap.ui.getCore().byId("idDesc").getValue(),action:f,active:true,httpMethod:"POST",startTime:l,endTime:o,schedules:[{data:I,cron:c,active:true,startTime:s,endTime:a}]};r.getModel("JModel").callFunction("/laddMLJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(m)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.laddMLJob.value+": Job Created");r.onCreateJobClose();r.onBack()},error:function(e){sap.ui.core.BusyIndicator.hide();r.onCreateJobClose();sap.m.MessageToast.show(r.i18n.getText("genPredErr"))}})}})});