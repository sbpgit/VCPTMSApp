sap.ui.define(["cpapp/cpjobscheduler/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","sap/ui/core/routing/HashChanger","sap/m/MessageToast","sap/ui/Device"],function(e,t,o,a,s,i){"use strict";var l,d;return e.extend("cpapp.cpjobscheduler.controller.Prediction",{onInit:function(){l=this;this.listModel=new t;this.JobLogsModel=new t;this.JobDataModel=new t;this.listModel.setSizeLimit(2e3);this.JobLogsModel.setSizeLimit(1e3);this.JobDataModel.setSizeLimit(1e3);if(!this._valueHelpDialogJobData){this._valueHelpDialogJobData=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.JobData",this);this.getView().addDependent(this._valueHelpDialogJobData)}if(!this._valueHelpDialogUpdateJob){this._valueHelpDialogUpdateJob=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.UpdateJobDialog",this);this.getView().addDependent(this._valueHelpDialogUpdateJob)}},onAfterRendering:function(){d=this.getModel("oGModel");l.oList=l.byId("jobList");l.oList.removeSelections(true);var e=new Date;var t=new Date(e.getFullYear(),e.getMonth(),e.getDate()-15);this.byId("idDateRange").setDateValue(t);this.byId("idDateRange").setSecondDateValue(e);l.byId("JobPanel").setExpanded(true);l.byId("jobDetailsPanel").setExpanded(false);sap.ui.core.BusyIndicator.show();l.getModel("JModel").callFunction("/lreadJobs",{method:"GET",success:function(e){sap.ui.core.BusyIndicator.hide();l.listModel.setData({results:e.lreadJobs.value});l.oList.setModel(l.listModel)},error:function(e){sap.ui.core.BusyIndicator.hide();s.show("Failed to get data")}})},onPanelExpand:function(){var e=l.byId("JobPanel").getExpanded();if(e===true){l.byId("jobList").removeSelections(true)}},onCreateJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(l);t.navTo("CreateJob",{},true)},onOpenJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(l);t.navTo("OpenJob",{},true)},handleDateChange:function(e){var t=e.getParameters().newValue;t=t.split(" To ");var o=t[0],a=t[0];l.getModel("JModel").callFunction("/lreadJobs",{method:"GET",urlParameters:{startTime:o,endTime:a},success:function(e){l.listModel.setData({results:e.results});l.oList.setModel(l.listModel)},error:function(e){sap.ui.core.BusyIndicator.hide();s.show("Failed to get data")}})},onJobLogs:function(e){d=this.getModel("oGModel");var t=e.getSource().getParent().getCells()[0].getTitle();d.setProperty("/SelJob",t);l.getModel("JModel").callFunction("/lreadJobSchedules",{method:"GET",urlParameters:{jobId:t},success:function(e){d.setProperty("/scheduleId",e.lreadJobSchedules.value[0].scheduleId);l.JobDetails()},error:function(e){sap.ui.core.BusyIndicator.hide();s.show("Failed to get data")}})},onhandlePress:function(e){d=this.getModel("oGModel");var t=e.getParameter("listItem").getCells()[0].getTitle();d.setProperty("/newSch","");d.setProperty("/Jobdata",e.getParameter("listItem").getBindingContext().getObject());l.getModel("JModel").callFunction("/lreadJobDetails",{method:"GET",urlParameters:{jobId:t,displaySchedules:true},success:function(e){var t=e.lreadJobDetails.value.schedules;l.JobLogsModel.setData({results:t});l.byId("idJobLogs").setModel(l.JobLogsModel);var o=e.lreadJobDetails.value.schedules[0].data;o=$.parseJSON(o);d.setProperty("/aJobDetails",e.lreadJobDetails.value.schedules);if(o[0].profile!==undefined){d.setProperty("/JobType","M")}else if(o[0].version!==undefined){d.setProperty("/JobType","P")}l.byId("JobPanel").setExpanded(false);l.byId("jobDetailsPanel").setExpanded(true)},error:function(e){sap.ui.core.BusyIndicator.hide();s.show("Failed to get data")}})},onScheData:function(e){var t=d.getProperty("/aJobDetails"),o;var a=e.getSource().getParent().getBindingContext().getObject().scheduleId;for(var s=0;s<t.length;s++){if(a===t[s].scheduleId){o=t[s].data}}o=$.parseJSON(o);l.JobDataModel.setData({results:o});sap.ui.getCore().byId("idJobData").setModel(l.JobDataModel);l._valueHelpDialogJobData.open()},onjobClose:function(){l._valueHelpDialogJobData.close()},onAddSchedule:function(){d.setProperty("/newSch","X");l.onCreateJob()},onJobDelete:function(e){var t=e.getSource().getParent().getBindingContext().getObject().jobId;d.setProperty("/DeleteJob",t);l.getModel("JModel").callFunction("/ldeleteJob",{method:"GET",urlParameters:{jobId:t},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.ldeleteJob.value.includes("true")){sap.m.MessageToast.show(d.getProperty("/DeleteJob")+": Job Deleted")}l.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onUpdateJob:function(e){var t=e.getSource().getParent().getBindingContext().getObject(),o,a,s;d.setProperty("/JobDetailstoUpdate",t);d.setProperty("/updatejob",t.jobId);d.setProperty("/updatejobDesc",t.description);if(t.active===true){o="T"}else if(t.active===false){o="F"}sap.ui.getCore().byId("idUJActive").setSelectedKey(o);a=new Date(t.startTime);s=new Date(t.endTime);sap.ui.getCore().byId("idUJSTime").setDateValue(a);sap.ui.getCore().byId("idUJETime").setDateValue(s);this._valueHelpDialogUpdateJob.open()},onUpdateJobClose:function(){this._valueHelpDialogUpdateJob.close()},onJobUpdateSave:function(){var e=d.getProperty("/JobDetailstoUpdate");var t=sap.ui.getCore().byId("idUJActive").getSelectedKey(),o=sap.ui.getCore().byId("idUJSTime").getDateValue(),a=sap.ui.getCore().byId("idUJETime").getDateValue(),s,i,r=sap.ui.getCore().byId("idUJob").getValue(),n=sap.ui.getCore().byId("idUJDesc").getValue(),u=e.action,c=e.name;o=o.toISOString().split("T");s=o[1].split(":");a=a.toISOString().split("T");i=a[1].split(":");o=o[0]+" "+s[0]+":"+s[1]+" "+"+0000";a=a[0]+" "+i[0]+":"+i[1]+" "+"+0000";if(t==="T"){t=true}else if(t==="F"){t=false}var p={jobId:r,name:c,description:n,action:u,httpMethod:"POST",active:t,startTime:o,endTime:a};l.getModel("JModel").callFunction("/lupdateJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(p)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.lupdateJob.value.includes("true")){sap.m.MessageToast.show(d.getProperty("/JobDetailstoUpdate").jobId+": Job Updated")}l._valueHelpDialogUpdateJob.close();l.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();l.onCreateJobClose();sap.m.MessageToast.show("Failed to update job details")}})},onScheDelete:function(e){var t=d.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId;d.setProperty("/DeleteSchJob",t);d.setProperty("/DeleteSch",o);var a={jobId:t,scheduleId:o};l.getModel("JModel").callFunction("/ldeleteMLJobSchedule",{method:"GET",urlParameters:{scheduleDetails:JSON.stringify(a)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.ldeleteMLJobSchedule.value.includes("true")){sap.m.MessageToast.show(d.getProperty("/DeleteSch")+": Schedule Deleted")}l.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})}})});