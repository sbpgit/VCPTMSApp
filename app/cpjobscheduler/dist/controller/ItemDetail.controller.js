sap.ui.define(["cpapp/cpjobscheduler/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,o,s,a,i,r,l){"use strict";var d,u;return e.extend("cpapp.cpjobscheduler.controller.ItemDetail",{onInit:function(){d=this;this.bus=sap.ui.getCore().getEventBus();this.JobLogsModel=new s;this.JobDataModel=new s;this.ScheLogModel=new s;this.ScheRunLogModel=new s;this.JobLogsModel.setSizeLimit(1e3);this.JobDataModel.setSizeLimit(1e3);this.ScheLogModel.setSizeLimit(1e3);this.ScheRunLogModel.setSizeLimit(1e3);u=d.getOwnerComponent().getModel("oGModel")},onAfterRendering:function(){u=d.getOwnerComponent().getModel("oGModel");var e=u.getProperty("/jobId");u.setProperty("/newSch","");u.setProperty("/UpdateSch","");u.setProperty("/flagcron","");u.setProperty("/flagonetime","");d.getModel("JModel").callFunction("/readJobDetails",{method:"GET",urlParameters:{jobId:e,displaySchedules:true},success:function(e){e.readJobDetails.schedules.forEach(function(t){if(!e.readJobDetails.action.includes("DemandQty")){if(t.time){var o=t.time.split("T"),s=o[1].split(".")[0];t.time=o[0]+" "+s}}else{if(t.time){var o=t.time.split("+");t.time=o[0]}}},d);var t=e.readJobDetails.schedules;if(t.length){if(t[0].type==="recurring"){u.setProperty("/flagcron","X")}else if(t[0].type==="one-time"){u.setProperty("/flagonetime","X")}}if(t.length){d.JobLogsModel.setData({results:t})}else{d.JobLogsModel.setData({results:[]});d.ScheLogModel.setData({statusresults:[]});d.byId("idScheLogData").setModel(d.ScheLogModel);d.ScheRunLogModel.setData({results:[]});d.byId("idScheRunLogData").setModel(d.ScheRunLogModel)}d.byId("idJobLogs").setModel(d.JobLogsModel);var o=e.readJobDetails.schedules;u.setProperty("/aJobDetails",o);if(e.readJobDetails.action.includes("Models")){u.setProperty("/JobType","M")}else if(e.readJobDetails.action.includes("Predictions")){u.setProperty("/JobType","P")}else if(e.readJobDetails.action.includes("/catalog/")&&e.readJobDetails.action.split("catalog/")[1]==="generateTimeseries"){u.setProperty("/JobType","T")}else if(e.readJobDetails.action.includes("/catalog/")&&e.readJobDetails.action.split("catalog/")[1]==="generateTimeseriesF"){u.setProperty("/JobType","F")}else if(e.readJobDetails.action.includes("sdi")){u.setProperty("/JobType","S");var s=u.getProperty("/Jobdata").action.split("/");var a=s.length-1;s=s[a];u.setProperty("/IBPService",s)}else if(e.readJobDetails.action.includes("genFullConfigDemand")){u.setProperty("/JobType","D")}else if(e.readJobDetails.action.includes("exportIBPAsmreq")){u.setProperty("/JobType","A")}else if(e.readJobDetails.action.includes("genUniqueID")){u.setProperty("/JobType","O")}else if(e.readJobDetails.action.includes("ibpimport-srv")){if(e.readJobDetails.action.includes("generateFDemandQty")){u.setProperty("/JobType","I")}else{u.setProperty("/JobType","E")}var s=u.getProperty("/Jobdata").action.split("/");var a=s.length-1;s=s[a];u.setProperty("/IBPService",s)}d.getView().byId("idJobLogs").setSelectedItem(d.getView().byId("idJobLogs").getItems()[0],true);if(t.length){d.onScheduleData()}},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})},onScheData:function(e){if(!this._valueHelpDialogJobData){this._valueHelpDialogJobData=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.JobData",this);this.getView().addDependent(this._valueHelpDialogJobData)}var o=u.getProperty("/aJobDetails"),s=[];var a=e.getSource().getParent().getBindingContext().getObject().scheduleId;var i=u.getProperty("/JobType");for(var r=0;r<o.length;r++){if(a===o[r].scheduleId){if(i==="I"||i==="E"||i==="S"){var l=$.parseJSON(o[r].data);var n={Location:l.LOCATION_ID,Product:l.PRODUCT_ID,scenario:l.SCENARIO,version:l.VERSION,fromdate:l.FROMDATE,todate:l.TODATE,CUSTOMER_GROUP:l.CUSTOMER_GROUP};s.push(n)}else if(i==="A"||i==="O"){var l=$.parseJSON(o[r].data);var n={Location:l.LOCATION_ID,Product:l.PRODUCT_ID};s.push(n)}else if(i==="D"||i==="T"||i==="F"){var l=$.parseJSON(o[r].data);var n=$.parseJSON(l.LocProdData);n.forEach(function(e){e.Location=e.LOCATION_ID;e.Product=e.PRODUCT_ID},d);s=n}else{s=o[r].data;s=$.parseJSON(s);s=s.vcRulesList}}}d.JobDataModel.setData({results:s});sap.ui.getCore().byId("idJobData").setModel(d.JobDataModel);var i=u.getProperty("/JobType");sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false);if(u.getProperty("/JobType")==="M"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true)}else if(u.getProperty("/JobType")==="P"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(true)}if(u.getProperty("/JobType")!=="I"&&u.getProperty("/JobType")!=="S"){d._valueHelpDialogJobData.open()}else{var g=u.getProperty("/IBPService");var b=0;if(g==="generateFDemandQty"||g==="generateFCharPlan"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false)}else if(g==="exportIBPLocation"||g==="exportIBPCustomer"||g.includes("ImportECC")||g.includes("ImportCuvtabInd")){t.show("There is no schedule data to display for the selected job type");b=1}else if(g==="exportIBPMasterProd"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true)}else if(g==="exportIBPClass"){sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(true)}else if(g==="exportIBPSalesTrans"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(true)}else if(g==="exportIBPSalesConfig"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(true)}else if(g==="exportComponentReq"||g==="exportActCompDemand"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(true)}else if(g==="exportIBPCIR"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true)}if(b===0){d._valueHelpDialogJobData.open()}}},onScheduleData:function(e){var o=u.getProperty("/Jobdata").jobId,s=this.byId("idJobLogs").getSelectedItems()[0].getBindingContext().getObject().scheduleId;sap.ui.core.BusyIndicator.show();d.getModel("JModel").callFunction("/readJobRunLogs",{method:"GET",urlParameters:{jobId:o,scheduleId:s,page_size:50,offset:0},success:function(e){sap.ui.core.BusyIndicator.hide();d.ScheLogModel.setData({statusresults:e.results});d.byId("idScheLogData").setModel(d.ScheLogModel);d.getView().byId("idScheLogData").setSelectedItem(d.getView().byId("idScheLogData").getItems()[0],true);d.LogData=e.results;if(e.results.length){d.onRunlogs()}},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get Schedule data")}})},onScheduleClick:function(e){var o=u.getProperty("/Jobdata").jobId,s=this.byId("idJobLogs").getSelectedItems()[0].getBindingContext().getObject().scheduleId;sap.ui.core.BusyIndicator.show();d.getModel("JModel").callFunction("/readJobRunLogs",{method:"GET",urlParameters:{jobId:o,scheduleId:s,page_size:50,offset:0},success:function(e){sap.ui.core.BusyIndicator.hide();d.ScheLogModel.setData({statusresults:e.results});d.byId("idScheLogData").setModel(d.ScheLogModel);d.getView().byId("idScheLogData").setSelectedItem(d.getView().byId("idScheLogData").getItems()[0],true);d.LogData=e.results;if(e.results.length){d.onRunlogs()}},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get Schedule data")}})},onCreateJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(d);t.navTo("CreateJob",{},true)},onjobClose:function(){d._valueHelpDialogJobData.close()},onAddSchedule:function(){u.setProperty("/newSch","X");d.onCreateJob()},onScheDelete:function(e){var t=u.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId;u.setProperty("/DeleteSchJob",t);u.setProperty("/DeleteSch",o);var s={jobId:t,scheduleId:o};d.getModel("JModel").callFunction("/deleteMLJobSchedule",{method:"GET",urlParameters:{scheduleDetails:JSON.stringify(s)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.deleteMLJobSchedule.includes("true")){sap.m.MessageToast.show(u.getProperty("/DeleteSch")+": Schedule Deleted")}d.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onScheUpdate:function(e){var t=u.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId,s=u.getProperty("/aJobDetails");for(var a=0;a<s.length;a++){if(o===s[a].scheduleId){u.setProperty("/aScheUpdate",s[a])}}u.setProperty("/UpdateSch","X");d.onCreateJob()},onRunlogs:function(e){var t=u.getProperty("/Jobdata").jobId,o=this.byId("idScheLogData").getSelectedItems()[0].getBindingContext().getObject();var a=d.LogData;this.ScheRunLogModel=new s;d.runLog=$.parseJSON(o.runText);d.ScheRunLogModel.setData({results:d.runLog});d.byId("idScheRunLogData").setModel(d.ScheRunLogModel)},onScheRunLogClose:function(){d._valueHelpDialogScheRunLog.close()}})});