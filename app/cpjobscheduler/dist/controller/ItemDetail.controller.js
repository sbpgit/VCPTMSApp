sap.ui.define(["cpapp/cpjobscheduler/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,t,o,s,a,i,r,l){"use strict";var d,u;return e.extend("cpapp.cpjobscheduler.controller.ItemDetail",{onInit:function(){d=this;this.bus=sap.ui.getCore().getEventBus();this.JobLogsModel=new s;this.JobDataModel=new s;this.ScheLogModel=new s;this.ScheRunLogModel=new s;this.JobLogsModel.setSizeLimit(1e3);this.JobDataModel.setSizeLimit(1e3);this.ScheLogModel.setSizeLimit(1e3);this.ScheRunLogModel.setSizeLimit(1e3);u=d.getOwnerComponent().getModel("oGModel")},onAfterRendering:function(){if(!r.system.desktop){this.byId("orient").setOrientation("Horizontal")}else{this.byId("orient").setOrientation("Vertical")}u=d.getOwnerComponent().getModel("oGModel");var e=u.getProperty("/jobId");u.setProperty("/newSch","");u.setProperty("/UpdateSch","");u.setProperty("/flagcron","");u.setProperty("/flagonetime","");if(u.getProperty("/dataFlag")==="X"){d.getModel("JModel").callFunction("/readJobDetails",{method:"GET",urlParameters:{jobId:e,displaySchedules:true},success:function(e){e.readJobDetails.schedules.forEach(function(t){if(!e.readJobDetails.action.includes("DemandQty")){if(t.time){var o=t.time.split("T"),s=o[1].split(".")[0];t.time=o[0]+" "+s}}else{if(t.time){var o=t.time.split("+");t.time=o[0]}}},d);var t=e.readJobDetails.schedules;if(t.length){if(t[0].type==="recurring"){u.setProperty("/flagcron","X")}else if(t[0].type==="one-time"){u.setProperty("/flagonetime","X")}}if(t.length){d.JobLogsModel.setData({results:t})}else{d.JobLogsModel.setData({results:[]});d.ScheLogModel.setData({statusresults:[]});d.byId("idScheLogData").setModel(d.ScheLogModel);d.ScheRunLogModel.setData({results:[]});d.byId("idScheRunLogData").setModel(d.ScheRunLogModel)}d.byId("idJobLogs").setModel(d.JobLogsModel);var o=e.readJobDetails.schedules;u.setProperty("/aJobDetails",o);u.setProperty("/JobType","");if(e.readJobDetails.action.includes("Models")){u.setProperty("/JobType","M")}else if(e.readJobDetails.action.includes("Predictions")){u.setProperty("/JobType","P")}else if(e.readJobDetails.action.includes("/catalog/")&&e.readJobDetails.action.split("catalog/")[1]==="generateTimeseries"){u.setProperty("/JobType","T")}else if(e.readJobDetails.action.includes("/catalog/")&&e.readJobDetails.action.split("catalog/")[1]==="generateTimeseriesF"){u.setProperty("/JobType","F")}else if(e.readJobDetails.action.includes("sdi")){u.setProperty("/JobType","S");var s=u.getProperty("/Jobdata").action.split("/");var a=s.length-1;s=s[a];u.setProperty("/SDIService",s)}else if(e.readJobDetails.action.includes("genFullConfigDemand")){u.setProperty("/JobType","D")}else if(e.readJobDetails.action.includes("exportIBPAsmreq")){u.setProperty("/JobType","A")}else if(e.readJobDetails.action.includes("genUniqueID")){u.setProperty("/JobType","O")}else if(e.readJobDetails.action.includes("ibpimport-srv")){if(e.readJobDetails.action.includes("generateFDemandQty")){u.setProperty("/JobType","I")}else{u.setProperty("/JobType","E")}var s=u.getProperty("/Jobdata").action.split("/");var a=s.length-1;s=s[a];u.setProperty("/IBPService",s)}d.getView().byId("idJobLogs").setSelectedItem(d.getView().byId("idJobLogs").getItems()[0],true);if(t.length){d.onScheduleData()}},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})}},onScheData:function(e){if(!this._valueHelpDialogJobData){this._valueHelpDialogJobData=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.JobData",this);this.getView().addDependent(this._valueHelpDialogJobData)}var o=u.getProperty("/aJobDetails"),s=[];var a=e.getSource().getParent().getBindingContext().getObject().scheduleId;var i=u.getProperty("/JobType");var r=u.getProperty("/IBPService");for(var l=0;l<o.length;l++){if(a===o[l].scheduleId){if(i==="S"){s=[]}else if(i==="A"||i==="O"){var b=$.parseJSON(o[l].data);var n={Location:b.LOCATION_ID,Product:b.PRODUCT_ID};s.push(n)}else if(i==="D"||i==="T"||i==="F"){var n=$.parseJSON(o[l].data);if(n.LocProdData){var n=$.parseJSON(n.LocProdData);n.forEach(function(e){e.Location=e.LOCATION_ID;e.Product=e.PRODUCT_ID},d)}else{var n={Location:b.LOCATION_ID,Product:b.PRODUCT_ID}}s=n}else if(i==="I"||i==="E"){if(o[l].data!=="{}"){var b=$.parseJSON(o[l].data);switch(r){case"exportComponentReq":var n=b;var n={Location:b.LOCATION_ID,Product:b.PRODUCT_ID,fromdate:b.FROMDATE,todate:b.TODATE};s.push(n);break;case"exportIBPClass":var n={CLASS_NUM:b.CLASS_NUM};s.push(n);break;case"exportIBPMasterProd":var n={Location:b.LOCATION_ID};s.push(n);break;case"exportRestrDetails":var n={Location:b.LOCATION_ID};s.push(n);break;default:var n=b.LocProdData;n=$.parseJSON(n);n.forEach(function(e){e.Location=e.LOCATION_ID;e.Product=e.PRODUCT_ID},d);s=n;break}}}else if(i===""&&u.getProperty("/wFlag")==="X"){var b=$.parseJSON(o[l].data);var n={Location:b.LOCATION_ID,Product:b.PRODUCT_ID,scenario:b.SCENARIO,version:b.VERSION,fromdate:b.FROMDATE,todate:b.TODATE,modelVersion:b.MODEL_VERSION};s.push(n)}else{s=o[l].data;s=$.parseJSON(s);s=s.vcRulesList}}}d.JobDataModel.setData({results:s});sap.ui.getCore().byId("idJobData").setModel(d.JobDataModel);var i=u.getProperty("/JobType");var g=0;sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[12].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[13].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[14].setVisible(false);switch(i){case"M":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[12].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[13].setVisible(true);break;case"P":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[13].setVisible(true);break;case"T":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"F":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"I":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"E":var c=u.getProperty("/IBPService");if(c==="exportIBPLocation"||c==="exportIBPCustomer"){t.show("There is no schedule data to display for the selected job type");g=1}else if(c==="exportIBPMasterProd"||c==="exportRestrDetails"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true)}else if(c==="exportIBPClass"){sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(true)}else if(c==="exportActCompDemand"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[14].setVisible(true)}else if(c==="exportComponentReq"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(true)}else{sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true)}break;case"S":t.show("There is no schedule data to display for the selected job type");g=1;break;case"D":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"A":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"O":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);break;case"":sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(true);default:break}if(g===0){d._valueHelpDialogJobData.open()}},onScheduleData:function(e){var t=u.getProperty("/Jobdata").jobId,o=this.byId("idJobLogs").getSelectedItems()[0].getBindingContext().getObject().scheduleId;d.byId("idScheLogData").setBusy(true);d.getModel("JModel").callFunction("/readJobRunLogs",{method:"GET",urlParameters:{jobId:t,scheduleId:o,page_size:50,offset:0},success:function(e){d.byId("idScheLogData").setBusy(false);d.ScheLogModel.setData({statusresults:e.results});d.byId("idScheLogData").setModel(d.ScheLogModel);d.getView().byId("idScheLogData").setSelectedItem(d.getView().byId("idScheLogData").getItems()[0],true);d.LogData=e.results;if(e.results.length){d.onRunlogs()}},error:function(e){}})},onScheduleClick:function(e){var o=u.getProperty("/Jobdata").jobId,s=this.byId("idJobLogs").getSelectedItems()[0].getBindingContext().getObject().scheduleId;sap.ui.core.BusyIndicator.show();d.getModel("JModel").callFunction("/readJobRunLogs",{method:"GET",urlParameters:{jobId:o,scheduleId:s,page_size:50,offset:0},success:function(e){sap.ui.core.BusyIndicator.hide();d.ScheLogModel.setData({statusresults:e.results});d.byId("idScheLogData").setModel(d.ScheLogModel);d.getView().byId("idScheLogData").setSelectedItem(d.getView().byId("idScheLogData").getItems()[0],true);d.LogData=e.results;if(e.results.length){d.onRunlogs()}},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get Schedule data")}})},onCreateJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(d);t.navTo("CreateJob",{},true)},onjobClose:function(){d._valueHelpDialogJobData.close()},onAddSchedule:function(){u.setProperty("/newSch","X");d.onCreateJob()},onScheDelete:function(e){var t=u.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId;u.setProperty("/DeleteSchJob",t);u.setProperty("/DeleteSch",o);var s={jobId:t,scheduleId:o};d.getModel("JModel").callFunction("/deleteMLJobSchedule",{method:"GET",urlParameters:{scheduleDetails:JSON.stringify(s)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.deleteMLJobSchedule.includes("true")){sap.m.MessageToast.show(u.getProperty("/DeleteSch")+": Schedule Deleted")}d.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onScheUpdate:function(e){var t=u.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId,s=u.getProperty("/aJobDetails");for(var a=0;a<s.length;a++){if(o===s[a].scheduleId){u.setProperty("/aScheUpdate",s[a])}}u.setProperty("/UpdateSch","X");d.onCreateJob()},onRunlogs:function(e){var t=u.getProperty("/Jobdata").jobId,o=this.byId("idScheLogData").getSelectedItems()[0].getBindingContext().getObject();var a=d.LogData;this.ScheRunLogModel=new s;d.runLog=$.parseJSON(o.runText);d.ScheRunLogModel.setData({results:d.runLog});d.byId("idScheRunLogData").setModel(d.ScheRunLogModel)},onScheRunLogClose:function(){d._valueHelpDialogScheRunLog.close()}})});