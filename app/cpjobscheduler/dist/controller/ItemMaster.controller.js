sap.ui.define(["cpapp/cpjobscheduler/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,o,i,a,s,r){"use strict";var n,l;return e.extend("cpapp.cpjobscheduler.controller.ItemMaster",{onInit:function(){n=this;this.listModel=new o;this.JobLogsModel=new o;this.JobDataModel=new o;this.ScheLogModel=new o;this.ScheRunLogModel=new o;this.listModel.setSizeLimit(2e3);this.JobLogsModel.setSizeLimit(1e3);this.JobDataModel.setSizeLimit(1e3);this.ScheLogModel.setSizeLimit(1e3);if(!this._valueHelpDialogUpdateJob){this._valueHelpDialogUpdateJob=sap.ui.xmlfragment("cpapp.cpjobscheduler.view.UpdateJobDialog",this);this.getView().addDependent(this._valueHelpDialogUpdateJob)}this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")});this.bus.subscribe("data","dateRange",this.handleDateChange,this)},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){l=this.getModel("oGModel");n.oList=n.byId("jobList");n.oList.removeSelections(true);n.getView().byId("headSearch").setValue();sap.ui.core.BusyIndicator.show();n.getModel("JModel").callFunction("/readJobs",{method:"GET",success:function(e){sap.ui.core.BusyIndicator.hide();e.results.forEach(function(e){e.jobId=e.jobId.toString()},n);l.setProperty("/tableData",e.results);var t=[];var o=l.getProperty("/DateRange").split(" To ");var i=o[0]+" "+"00:00:00",a=o[1]+" "+"23:59:59";for(var s=0;s<e.results.length;s++){var r=e.results[s].startTime;if(i<r&&a>r){t.push(e.results[s])}}n.listModel.setData({results:t});n.oList.setModel(n.listModel);n.onSearch()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})},onSearch:function(e){var t=n.getView().byId("headSearch").getValue(),o=[];var s=[];if(t!==""){var o=new i({filters:[new i("jobId",a.Contains,t),new i("name",a.Contains,t)],and:false});s.push(o)}n.byId("jobList").getBinding("items").filter(s)},handleDateChange:function(e){var t=l.getProperty("/tableData");var o=[];var i=l.getProperty("/DateRange").split(" To ");var a=i[0]+" "+"00:00:00",s=i[1]+" "+"23:59:59";for(var r=0;r<t.length;r++){var d=t[r].startTime;if(a<d&&s>d){o.push(t[r])}}n.listModel.setData({results:o});n.oList.setModel(n.listModel);n.onSearch()},onhandlePress:function(e){l=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();l.setProperty("/Jobdata",e.getParameter("listItem").getBindingContext().getObject());l.setProperty("/jobId",t.jobId);l.setProperty("/description",t.description);l.setProperty("/startTime",t.startTime);l.setProperty("/endTime",t.endTime);l.setProperty("/createdAt",t.createdAt)}n.getOwnerComponent().runAsOwner(function(){if(!n.oDetailView){try{n.oDetailView=sap.ui.view({viewName:"cpapp.cpjobscheduler.view.ItemDetail",type:"XML"});n.bus.publish("flexible","addDetailPage",n.oDetailView);n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}catch(e){n.oDetailView.onAfterRendering()}}else{n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}})},onJobDelete:function(e){var t=e.getSource().getParent().getBindingContext().getObject().jobId;l.setProperty("/DeleteJob",t);n.getModel("JModel").callFunction("/deleteMLJob",{method:"GET",urlParameters:{jobId:t},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.deleteMLJob.includes("true")){sap.m.MessageToast.show(l.getProperty("/DeleteJob")+": Job Deleted")}n.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onUpdateJob:function(e){var t=e.getSource().getParent().getBindingContext().getObject(),o,i,a;l.setProperty("/JobDetailstoUpdate",t);l.setProperty("/updatejob",t.jobId);l.setProperty("/updatejobDesc",t.description);if(t.active===true){o="T"}else if(t.active===false){o="F"}sap.ui.getCore().byId("idUJActive").setSelectedKey(o);i=new Date(t.startTime);a=new Date(t.endTime);sap.ui.getCore().byId("idUJSTime").setDateValue(i);sap.ui.getCore().byId("idUJETime").setDateValue(a);this._valueHelpDialogUpdateJob.open()},onUpdateJobClose:function(){this._valueHelpDialogUpdateJob.close()},onJobUpdateSave:function(){var e=l.getProperty("/JobDetailstoUpdate");var t=sap.ui.getCore().byId("idUJActive").getSelectedKey(),o=sap.ui.getCore().byId("idUJSTime").getDateValue(),i=sap.ui.getCore().byId("idUJETime").getDateValue(),a,s,r=sap.ui.getCore().byId("idUJob").getValue(),d=sap.ui.getCore().byId("idUJDesc").getValue(),u=e.action,p=e.name;o=o.toISOString().split("T");a=o[1].split(":");i=i.toISOString().split("T");s=i[1].split(":");o=o[0]+" "+a[0]+":"+a[1]+" "+"+0000";i=i[0]+" "+s[0]+":"+s[1]+" "+"+0000";if(t==="T"){t=true}else if(t==="F"){t=false}var c={jobId:r,name:p,description:d,action:encodeURIComponent(u),httpMethod:"POST",active:t,startTime:o,endTime:i};n.getModel("JModel").callFunction("/updateMLJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(c)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.updateMLJob.includes("true")){sap.m.MessageToast.show(l.getProperty("/JobDetailstoUpdate").jobId+": Job Updated")}n._valueHelpDialogUpdateJob.close();n.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();n.onCreateJobClose();sap.m.MessageToast.show("Failed to update job details")}})},onCreateJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(n);t.navTo("CreateJob",{},true)}})});