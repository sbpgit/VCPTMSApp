sap.ui.define(["cpapp/cpjobschedulernew/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,a,o,s){"use strict";var i,l;return e.extend("cpapp.cpjobschedulernew.controller.Home",{onInit:function(){i=this;this.listModel=new t;this.JobLogsModel=new t;this.JobDataModel=new t;this.ScheLogModel=new t;this.ScheRunLogModel=new t;this.listModel.setSizeLimit(2e3);this.JobLogsModel.setSizeLimit(1e3);this.JobDataModel.setSizeLimit(1e3);this.ScheLogModel.setSizeLimit(1e3);if(!this._valueHelpDialogJobData){this._valueHelpDialogJobData=sap.ui.xmlfragment("cpapp.cpjobschedulernew.view.JobData",this);this.getView().addDependent(this._valueHelpDialogJobData)}if(!this._valueHelpDialogUpdateJob){this._valueHelpDialogUpdateJob=sap.ui.xmlfragment("cpapp.cpjobschedulernew.view.UpdateJobDialog",this);this.getView().addDependent(this._valueHelpDialogUpdateJob)}if(!this._valueHelpDialogScheLog){this._valueHelpDialogScheLog=sap.ui.xmlfragment("cpapp.cpjobschedulernew.view.ScheLog",this);this.getView().addDependent(this._valueHelpDialogScheLog)}if(!this._valueHelpDialogScheRunLog){this._valueHelpDialogScheRunLog=sap.ui.xmlfragment("cpapp.cpjobschedulernew.view.RunLogData",this);this.getView().addDependent(this._valueHelpDialogScheRunLog)}},onAfterRendering:function(){l=this.getModel("oGModel");i.oList=i.byId("jobList");i.oList.removeSelections(true);i.getView().byId("headSearch").setValue();var e=new Date;var t=new Date(e.getFullYear(),e.getMonth(),e.getDate()-15);this.byId("idDateRange").setDateValue(t);this.byId("idDateRange").setSecondDateValue(e);i.byId("JobPanel").setExpanded(true);i.byId("jobDetailsPanel").setExpanded(false);sap.ui.core.BusyIndicator.show();i.getModel("JModel").callFunction("/lreadJobs",{method:"GET",success:function(e){sap.ui.core.BusyIndicator.hide();e.lreadJobs.value.forEach(function(e){e.jobId=e.jobId.toString()},i);l.setProperty("/tableData",e.lreadJobs.value);var t=[];var a=i.byId("idDateRange").getValue().split("To");var o=new Date(a[0]),s=new Date(a[1]+" "+"23:59:59");for(var r=0;r<e.lreadJobs.value.length;r++){var d=new Date(e.lreadJobs.value[r].startTime);if(o<d&&s>d){t.push(e.lreadJobs.value[r])}}i.listModel.setData({results:t});i.oList.setModel(i.listModel);i.onSearch()},error:function(e){sap.ui.core.BusyIndicator.hide();a.show("Failed to get data")}})},onSearch:function(e){var t=i.getView().byId("headSearch").getValue(),a=[];var l=[];if(t!==""){var a=new o({filters:[new o("jobId",s.Contains,t),new o("name",s.Contains,t),new o("description",s.Contains,t)],and:false});l.push(a)}i.byId("jobList").getBinding("items").filter(l)},onPanelExpand:function(){var e=i.byId("JobPanel").getExpanded();var t=i.byId("jobList").getItems();for(var a=0;a<t.length;a++){if(i.oJobId===t[a].getCells()[0].getTitle()){t[a].focus()}}},onCreateJob:function(e){var t=sap.ui.core.UIComponent.getRouterFor(i);t.navTo("CreateJob",{},true)},handleDateChange:function(e){var t=l.getProperty("/tableData");var a=[];var o=i.byId("idDateRange").getValue().split("To");var s=new Date(o[0]),r=new Date(o[1]+" "+"23:59:59");for(var d=0;d<t.length;d++){var u=new Date(t[d].startTime);if(s<u&&r>u){a.push(t[d])}}i.listModel.setData({results:a});i.oList.setModel(i.listModel);i.onSearch();i.byId("JobPanel").setExpanded(true);i.byId("jobDetailsPanel").setExpanded(false)},onhandlePress:function(e){l=this.getModel("oGModel");var t=e.getParameter("listItem").getCells()[0].getTitle();i.oJobId=t;l.setProperty("/newSch","");l.setProperty("/UpdateSch","");l.setProperty("/Jobdata",e.getParameter("listItem").getBindingContext().getObject());i.getModel("JModel").callFunction("/lreadJobDetails",{method:"GET",urlParameters:{jobId:t,displaySchedules:true},success:function(e){e.lreadJobDetails.value.schedules.forEach(function(t){if(!e.lreadJobDetails.value.action.includes("DemandQty")){if(t.time){var a=t.time.split("T"),o=a[1].split(".")[0];t.time=a[0]+" "+o}}else{if(t.time){var a=t.time.split("+");t.time=a[0]}}},i);var t=e.lreadJobDetails.value.schedules;i.JobLogsModel.setData({results:t});i.byId("idJobLogs").setModel(i.JobLogsModel);var a=e.lreadJobDetails.value.schedules;l.setProperty("/aJobDetails",a);if(e.lreadJobDetails.value.action.includes("Models")){l.setProperty("/JobType","M")}else if(e.lreadJobDetails.value.action.includes("Predictions")){l.setProperty("/JobType","P")}else if(e.lreadJobDetails.value.action.split("catalog/")[1]==="generateTimeseries"){l.setProperty("/JobType","T")}else if(e.lreadJobDetails.value.action.split("catalog/")[1]==="generateTimeseriesF"){l.setProperty("/JobType","F")}else if(e.lreadJobDetails.value.action.includes("sdi")){l.setProperty("/JobType","S");var o=l.getProperty("/Jobdata").action.split("/");var s=o.length-1;o=o[s];l.setProperty("/IBPService",o)}else if(e.lreadJobDetails.value.action.includes("genFullConfigDemand")){l.setProperty("/JobType","D")}else if(e.lreadJobDetails.value.action.includes("exportIBPAsmreq")){l.setProperty("/JobType","A")}else if(e.lreadJobDetails.value.action.includes("genUniqueID")){l.setProperty("/JobType","O")}else if(e.lreadJobDetails.value.action.includes("ibpimport-srv")){l.setProperty("/JobType","I");var o=l.getProperty("/Jobdata").action.split("/");var s=o.length-1;o=o[s];l.setProperty("/IBPService",o)}i.byId("JobPanel").setExpanded(false);i.byId("jobDetailsPanel").setExpanded(true)},error:function(e){sap.ui.core.BusyIndicator.hide();a.show("Failed to get data")}})},onScheData:function(e){var t=l.getProperty("/aJobDetails"),o=[];var s=e.getSource().getParent().getBindingContext().getObject().scheduleId;var r=l.getProperty("/JobType");for(var d=0;d<t.length;d++){if(s===t[d].scheduleId){if(l.getProperty("/JobType")==="I"||l.getProperty("/JobType")==="S"){var u=$.parseJSON(t[d].data);var n={Location:u.LOCATION_ID,Product:u.PRODUCT_ID,scenario:u.SCENARIO,version:u.VERSION,fromdate:u.FROMDATE,todate:u.TODATE,CUSTOMER_GROUP:u.CUSTOMER_GROUP};o.push(n)}if(r==="D"||r==="A"||r==="O"){var u=$.parseJSON(t[d].data);var n={Location:u.LOCATION_ID,Product:u.PRODUCT_ID};o.push(n)}else{o=t[d].data;o=$.parseJSON(o);o=o.vcRulesList}}}i.JobDataModel.setData({results:o});sap.ui.getCore().byId("idJobData").setModel(i.JobDataModel);var r=l.getProperty("/JobType");if(l.getProperty("/JobType")==="M"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false)}else if(l.getProperty("/JobType")==="P"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false)}else if(l.getProperty("/JobType")==="T"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(true)}else if(l.getProperty("/JobType")==="F"){sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false)}else if(l.getProperty("/JobType")==="I"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false)}else if(r==="D"||r==="A"||r==="O"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[2].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[3].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[4].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[6].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(false);sap.ui.getCore().byId("idJobData").getColumns()[11].setVisible(false)}if(l.getProperty("/JobType")!=="I"&&l.getProperty("/JobType")!=="S"){i._valueHelpDialogJobData.open()}else{var b=l.getProperty("/IBPService");var g=0;if(b==="generateFDemandQty"||b==="generateFCharPlan"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[5].setVisible(false)}else if(b==="exportIBPLocation"||b==="exportIBPCustomer"||b.includes("ImportECC")||b.includes("ImportCuvtabInd")){a.show("There is no schedule data to display for the selected job type");g=1}else if(b==="exportIBPMasterProd"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true)}else if(b==="exportIBPClass"){sap.ui.getCore().byId("idJobData").getColumns()[7].setVisible(true)}else if(b==="exportIBPSalesTrans"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(true)}else if(b==="exportIBPSalesConfig"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[8].setVisible(true)}else if(b==="exportComponentReq"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(true)}else if(b==="exportActCompDemand"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[9].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[10].setVisible(true)}else if(b==="exportIBPCIR"){sap.ui.getCore().byId("idJobData").getColumns()[0].setVisible(true);sap.ui.getCore().byId("idJobData").getColumns()[1].setVisible(true)}if(g===0){i._valueHelpDialogJobData.open()}}},onSchestatus:function(e){var t=l.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId;sap.ui.core.BusyIndicator.show();i.getModel("JModel").callFunction("/lreadJobRunLogs",{method:"GET",urlParameters:{jobId:t,scheduleId:o,page_size:50,offset:0},success:function(e){sap.ui.core.BusyIndicator.hide();i.ScheLogModel.setData({results:e.lreadJobRunLogs.value});sap.ui.getCore().byId("idScheLogData").setModel(i.ScheLogModel);i._valueHelpDialogScheLog.open()},error:function(e){sap.ui.core.BusyIndicator.hide();a.show("Failed to get data")}})},onScheLogClose:function(){i._valueHelpDialogScheLog.close()},onjobClose:function(){i._valueHelpDialogJobData.close()},onAddSchedule:function(){l.setProperty("/newSch","X");i.onCreateJob()},onJobDelete:function(e){var t=e.getSource().getParent().getBindingContext().getObject().jobId;l.setProperty("/DeleteJob",t);i.getModel("JModel").callFunction("/ldeleteJob",{method:"GET",urlParameters:{jobId:t},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.ldeleteJob.value.includes("true")){sap.m.MessageToast.show(l.getProperty("/DeleteJob")+": Job Deleted")}i.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onUpdateJob:function(e){var t=e.getSource().getParent().getBindingContext().getObject(),a,o,s;l.setProperty("/JobDetailstoUpdate",t);l.setProperty("/updatejob",t.jobId);l.setProperty("/updatejobDesc",t.description);if(t.active===true){a="T"}else if(t.active===false){a="F"}sap.ui.getCore().byId("idUJActive").setSelectedKey(a);o=new Date(t.startTime);s=new Date(t.endTime);sap.ui.getCore().byId("idUJSTime").setDateValue(o);sap.ui.getCore().byId("idUJETime").setDateValue(s);this._valueHelpDialogUpdateJob.open()},onUpdateJobClose:function(){this._valueHelpDialogUpdateJob.close()},onJobUpdateSave:function(){var e=l.getProperty("/JobDetailstoUpdate");var t=sap.ui.getCore().byId("idUJActive").getSelectedKey(),a=sap.ui.getCore().byId("idUJSTime").getDateValue(),o=sap.ui.getCore().byId("idUJETime").getDateValue(),s,r,d=sap.ui.getCore().byId("idUJob").getValue(),u=sap.ui.getCore().byId("idUJDesc").getValue(),n=e.action,b=e.name;a=a.toISOString().split("T");s=a[1].split(":");o=o.toISOString().split("T");r=o[1].split(":");a=a[0]+" "+s[0]+":"+s[1]+" "+"+0000";o=o[0]+" "+r[0]+":"+r[1]+" "+"+0000";if(t==="T"){t=true}else if(t==="F"){t=false}var g={jobId:d,name:b,description:u,action:encodeURIComponent(n),httpMethod:"POST",active:t,startTime:a,endTime:o};i.getModel("JModel").callFunction("/lupdateJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(g)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.lupdateJob.value.includes("true")){sap.m.MessageToast.show(l.getProperty("/JobDetailstoUpdate").jobId+": Job Updated")}i._valueHelpDialogUpdateJob.close();i.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();i.onCreateJobClose();sap.m.MessageToast.show("Failed to update job details")}})},onScheDelete:function(e){var t=l.getProperty("/Jobdata").jobId,a=e.getSource().getParent().getBindingContext().getObject().scheduleId;l.setProperty("/DeleteSchJob",t);l.setProperty("/DeleteSch",a);var o={jobId:t,scheduleId:a};i.getModel("JModel").callFunction("/ldeleteMLJobSchedule",{method:"GET",urlParameters:{scheduleDetails:JSON.stringify(o)},success:function(e){sap.ui.core.BusyIndicator.hide();if(e.ldeleteMLJobSchedule.value.includes("true")){sap.m.MessageToast.show(l.getProperty("/DeleteSch")+": Schedule Deleted")}i.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Deletion failed")}})},onScheUpdate:function(e){var t=l.getProperty("/Jobdata").jobId,a=e.getSource().getParent().getBindingContext().getObject().scheduleId,o=l.getProperty("/aJobDetails");for(var s=0;s<o.length;s++){if(a===o[s].scheduleId){l.setProperty("/aScheUpdate",o[s])}}l.setProperty("/UpdateSch","X");i.onCreateJob()},onRunlogs:function(e){var t=l.getProperty("/Jobdata").jobId,o=e.getSource().getParent().getBindingContext().getObject().scheduleId;i.getModel("JModel").callFunction("/lreadJobRunLogs",{method:"GET",urlParameters:{jobId:t,scheduleId:o,page_size:50,offset:0},success:function(e){i.runLog=$.parseJSON(e.lreadJobRunLogs.value[0].runText);i.ScheRunLogModel.setData({results:i.runLog});sap.ui.getCore().byId("idScheRunLogData").setModel(i.ScheRunLogModel);i._valueHelpDialogScheRunLog.open()},error:function(e){sap.ui.core.BusyIndicator.hide();a.show("Failed to get data")}})},onScheRunLogClose:function(){i._valueHelpDialogScheRunLog.close()}})});