sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/m/Dialog","sap/m/library","sap/m/Text","sap/m/Button"],function(e,t,o,i,a,s,r,l,n,d){"use strict";var c;var u=l.DialogType;var p=l.ButtonType;return e.extend("cpapp.cpmarketauthorization.controller.Home",{onInit:function(){c=this;c.TableModel=new t;c.locModel=new t;c.prodModel=new t;c.verModel=new t;c.scenModel=new t;c.TableModel.setSizeLimit(1e3);c.locModel.setSizeLimit(1e3);c.prodModel.setSizeLimit(1e3);c.verModel.setSizeLimit(1e3);c.scenModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogVer){this._valueHelpDialogVer=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.VersionDialog",this);this.getView().addDependent(this._valueHelpDialogVer)}if(!this._valueHelpDialogScen){this._valueHelpDialogScen=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ScenarioDialog",this);this.getView().addDependent(this._valueHelpDialogScen)}},onAfterRendering:function(){c.aOrder=[];c.bOrder=[];this.oLoc=this.byId("idloc");this.oProd=this.byId("idprod");this.oVer=this.byId("idver");this.oScen=this.byId("idscen");c._valueHelpDialogProd.setTitleAlignment("Center");c._valueHelpDialogLoc.setTitleAlignment("Center");c._valueHelpDialogVer.setTitleAlignment("Center");c._valueHelpDialogScen.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oVerList=this._oCore.byId(this._valueHelpDialogVer.getId()+"-list");this.oScenList=this._oCore.byId(this._valueHelpDialogScen.getId()+"-list");sap.ui.core.BusyIndicator.show();this.getView().getModel("oModel").read("/getLocation",{success:function(e){c.locModel.setData(e);c.oLocList.setModel(c.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){c._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(c.byId("idloc").getValue()){c._valueHelpDialogProd.open()}else{a.show("Select Location")}}else if(t.includes("ver")){if(c.byId("idloc").getValue()&&c.byId("idprod").getValue()){c._valueHelpDialogVer.open()}else{a.show("Select Location and Product")}}else if(t.includes("scen")){if(c.byId("idloc").getValue()&&c.byId("idprod").getValue()&&c.byId("idver").getValue()){c._valueHelpDialogScen.open()}else{a.show("Select Location/Product/Version")}}},handleSelection:function(e){c.oGModel=c.getOwnerComponent().getModel("oGModel");var t=e.getParameter("id"),o=e.getParameter("selectedItems"),i,s=[];if(t.includes("Loc")){c.oLoc=c.byId("idloc");c.oProd=c.byId("idprod");i=e.getParameter("selectedItems");c.oLoc.setValue(i[0].getTitle());c.oGModel.setProperty("/SelectedLoc",i[0].getTitle());c.oProd.setValue("");c.oVer.setValue("");c.oScen.setValue("");c.byId("fromDate").setValue("");c.oGModel.setProperty("/SelectedProd","");this.getView().getModel("oModel").callFunction("/getAllProd",{method:"GET",urlParameters:{LOCATION_ID:c.oLoc.getValue()},success:function(e){c.prodModel.setData(e);c.oProdList.setModel(c.prodModel)},error:function(e,t){a.show("error")}})}else if(t.includes("prod")){var r=[];var l=[];var n=[];c.oProd=c.byId("idprod");var d=[];i=e.getParameters("selectedItems").selectedItems;for(var u in i){d[u]=i[u].getTitle();r.push(l)}c.oGModel.setProperty("/SelectedProd",d);c.oProd.setValue(d);c.byId("fromDate").setValue("");c.oVer.setValue("");c.oScen.setValue("");this.getView().getModel("oModel").read("/getVerScnmaster",{method:"GET",urlParameters:{},success:function(e){if(e.results.length===0){sap.m.MessageToast.show("No versions available for choosen Location/Product. Please choose another.");c.verModel.setData([]);c.oVerList.setModel(c.verModel)}else{var t=[];var o=[];for(var i=0;i<e.results.length;i++){if(c.aOrder.indexOf(e.results[i].VERSION)===-1){c.aOrder.push(e.results[i].VERSION);if(e.results[i].VERSION!==""){c.oOrdData={VERSION:e.results[i].VERSION};t.push(c.oOrdData)}}}}c.oGModel.setProperty("/scenarios",e.results);if(t.length>0){c.verModel.setData({results:t});c.oVerList.setModel(c.verModel)}},error:function(e,t){a.show("error")}})}else if(t.includes("Ver")){var p=[];this.oVer=c.byId("idver");i=e.getParameter("selectedItems");c.oVer.setValue(i[0].getTitle());c.oScen.setValue("");c.byId("fromDate").setValue("");c.oGModel.setProperty("/SelectedVer",i[0].getTitle());var g=c.oGModel.getProperty("/scenarios");for(var u in g){if(i[0].getTitle()===g[u].VERSION&&g[u].SCENARIO!==""){p.push(g[u])}}c.scenModel.setData({results:p});c.oScenList.setModel(c.scenModel)}else if(t.includes("scen")){sap.ui.core.BusyIndicator.show();this.oScen=c.byId("idscen");c.byId("fromDate").setValue("");i=e.getParameter("selectedItems");c.oScen.setValue(i[0].getTitle());c.oGModel.setProperty("/SelectedScen",i[0].getTitle());sap.ui.core.BusyIndicator.hide()}c.handleClose(e)},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){c._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(c.oLocList.getBinding("items")){c.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){c._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(c.oProdList.getBinding("items")){c.oProdList.getBinding("items").filter([])}}else if(t.includes("Ver")){c._oCore.byId(this._valueHelpDialogVer.getId()+"-searchField").setValue("");if(c.oVerList.getBinding("items")){c.oVerList.getBinding("items").filter([])}}else if(t.includes("scen")){c._oCore.byId(this._valueHelpDialogScen.getId()+"-searchField").setValue("");if(c.oScenList.getBinding("items")){c.oScenList.getBinding("items").filter([])}}},onNavPress:function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var e=sap.ushell.Container.getService("CrossApplicationNavigation");var t=e&&e.hrefForExternal({target:{semanticObject:"vcpdocdisplay",action:"Display"}})||"";var o=window.location.href.split("#")[0]+t;sap.m.URLHelper.redirect(o,true)}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),a=e.getParameter("id"),s=[];t=t?t.trim():"";if(a.includes("Loc")){if(t!==""){s.push(new o({filters:[new o("LOCATION_ID",i.Contains,t),new o("LOCATION_DESC",i.Contains,t)],and:false}))}c.oLocList.getBinding("items").filter(s)}else if(a.includes("prod")){if(t!==""){s.push(new o({filters:[new o("PRODUCT_ID",i.Contains,t),new o("PROD_DESC",i.Contains,t)],and:false}))}c.oProdList.getBinding("items").filter(s)}else if(a.includes("Ver")){if(t!==""){s.push(new o({filters:[new o("VERSION",i.Contains,t)],and:false}))}c.oVerList.getBinding("items").filter(s)}else if(a.includes("scen")){if(t!==""){s.push(new o({filters:[new o("SCENARIO",i.Contains,t)],and:false}))}c.oScenList.getBinding("items").filter(s)}},onResetDate:function(){c.oLoc.setValue("");c.oProd.setValue("");c.oVer.setValue("");c.oScen.setValue("");c.byId("fromDate").setValue("")},onGetData:function(){var e=c.byId("idloc").getValue(),t=c.byId("idprod").getValue(),o=c.byId("idver").getValue(),i=c.byId("idscen").getValue();var a=c.byId("fromDate").getFrom();var s=c.byId("fromDate").getTo();var r={MARKETDATA:[]};var l={};if(e&&t&&o&&a&&s){var n=c.oGModel.getProperty("/SelectedProd");var d=c.getDateFn(a);var u=c.getDateFn(s);for(var p in n){l={LOCATION_ID:e,PRODUCT_ID:n[p],VERSION:o,SCENARIO:i,FROMDATE:d,TODATE:u};r.MARKETDATA.push(l)}var g={};g=c.getScheduleSEDT();var h=(new Date).getTime();var v="/ibpimport-srv/generateMarketAuth";var f="Market Auth"+h;sap.ui.core.BusyIndicator.show();var m={name:f,description:"Market Authorization",action:encodeURIComponent(v),active:true,httpMethod:"POST",startTime:g.djSdate,endTime:g.djEdate,createdAt:g.djSdate,schedules:[{data:{MARKETDATA:JSON.stringify(r.MARKETDATA)},cron:"",time:g.oneTime,active:true,startTime:g.dsSDate,endTime:g.dsEDate}]};this.getView().getModel("JModel").callFunction("/addMLJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(m)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.addMLJob+": Job Created");c.onResetDate()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error While publishing data!")}})}else{sap.m.MessageToast.show("Select Location/Product/Version/Date")}},getDateFn:function(e){var t,o,i;var a=e.getMonth()+1;if(a<10){t="0"+a}else{t=a}if(e.getDate()<10){o="0"+e.getDate()}else{o=e.getDate()}return e=e.getFullYear()+"-"+t+"-"+o},getScheduleSEDT:function(){var e={};var t=new Date;var o=t.setSeconds(t.getSeconds()+20);var i=t.setHours(t.getHours()+2);o=new Date(o);i=new Date(i);var a=new Date,s=i,r=new Date,l=i,n,d,c,u;a=a.toISOString().split("T");n=a[1].split(":");s=s.toISOString().split("T");d=s[1].split(":");r=r.toISOString().split("T");c=r[1].split(":");l=l.toISOString().split("T");u=l[1].split(":");var t=(new Date).toLocaleString().split(" ");e.djSdate=a[0]+" "+n[0]+":"+n[1]+" "+"+0000";e.djEdate=s[0]+" "+d[0]+":"+d[1]+" "+"+0000";e.dsSDate=r[0]+" "+c[0]+":"+c[1]+" "+"+0000";e.dsEDate=l[0]+" "+u[0]+":"+u[1]+" "+"+0000";e.oneTime=o;return e},onSubmitPress:function(){var e=c.byId("idloc").getValue(),t=c.oGModel.getProperty("/SelectedProd"),o=c.byId("idver").getValue(),i=c.byId("idscen").getValue();var s=[];var l=[];l=new sap.ui.model.Filter({path:"LOCATION_ID",operator:sap.ui.model.FilterOperator.EQ,value1:e});s.push(l);l=new sap.ui.model.Filter({path:"VERSION",operator:sap.ui.model.FilterOperator.EQ,value1:o});s.push(l);if(i!==""){l=new sap.ui.model.Filter({path:"SCENARIO",operator:sap.ui.model.FilterOperator.EQ,value1:i});s.push(l)}for(var g in t){l=new sap.ui.model.Filter({path:"PRODUCT_ID",operator:sap.ui.model.FilterOperator.EQ,value1:t[g]});s.push(l)}this.getView().getModel("oModel").read("/getIbpVerScn",{filters:s,success:function(e){if(e.results.length===0){if(!c.oApproveDialog){c.oApproveDialog=new r({type:u.Message,title:"Confirmation",content:new n({text:"Selected Version/ Scenario does not exist in previous IBP requests. Do you want to continue?"}),beginButton:new d({type:p.Emphasized,text:"Create",press:function(){c.onGetData();c.oApproveDialog.close()}.bind(this)}),endButton:new d({text:"Cancel",press:function(){c.oApproveDialog.close()}.bind(this)})})}c.oApproveDialog.open()}else{c.onGetData()}},error:function(e){a.show("Hi")}})}})});