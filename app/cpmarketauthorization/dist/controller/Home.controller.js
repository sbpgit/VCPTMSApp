sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,o,s,l){"use strict";var a;return e.extend("cpapp.cpmarketauthorization.controller.Home",{onInit:function(){a=this;a.TableModel=new t;a.locModel=new t;a.prodModel=new t;a.verModel=new t;a.scenModel=new t;a.TableModel.setSizeLimit(1e3);a.locModel.setSizeLimit(1e3);a.prodModel.setSizeLimit(1e3);a.verModel.setSizeLimit(1e3);a.scenModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogVer){this._valueHelpDialogVer=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.VersionDialog",this);this.getView().addDependent(this._valueHelpDialogVer)}if(!this._valueHelpDialogScen){this._valueHelpDialogScen=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ScenarioDialog",this);this.getView().addDependent(this._valueHelpDialogScen)}},onAfterRendering:function(){a.aOrder=[];a.bOrder=[];this.oLoc=this.byId("idloc");this.oProd=this.byId("idprod");this.oVer=this.byId("idver");this.oScen=this.byId("idscen");a._valueHelpDialogProd.setTitleAlignment("Center");a._valueHelpDialogLoc.setTitleAlignment("Center");a._valueHelpDialogVer.setTitleAlignment("Center");a._valueHelpDialogScen.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oVerList=this._oCore.byId(this._valueHelpDialogVer.getId()+"-list");this.oScenList=this._oCore.byId(this._valueHelpDialogScen.getId()+"-list");sap.ui.core.BusyIndicator.show();this.getView().getModel("oModel").read("/getLocation",{success:function(e){a.locModel.setData(e);a.oLocList.setModel(a.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){sap.ui.core.BusyIndicator.hide();s.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){a._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(a.byId("idloc").getValue()){a._valueHelpDialogProd.open()}else{s.show("Select Location")}}else if(t.includes("ver")){if(a.byId("idloc").getValue()&&a.byId("idprod").getValue()){a._valueHelpDialogVer.open()}else{s.show("Select Location and Product")}}else if(t.includes("scen")){if(a.byId("idloc").getValue()&&a.byId("idprod").getValue()&&a.byId("idver").getValue()){a._valueHelpDialogScen.open()}else{s.show("Select Location/Product/Version")}}},handleSelection:function(e){a.oGModel=a.getOwnerComponent().getModel("oGModel");var t=e.getParameter("id"),i=e.getParameter("selectedItems"),o,l=[];if(t.includes("Loc")){a.oLoc=a.byId("idloc");a.oProd=a.byId("idprod");o=e.getParameter("selectedItems");a.oLoc.setValue(o[0].getTitle());a.oGModel.setProperty("/SelectedLoc",o[0].getTitle());a.oProd.setValue("");a.byId("fromDate").setValue("");a.oGModel.setProperty("/SelectedProd","");this.getView().getModel("oModel").callFunction("/getAllProd",{method:"GET",urlParameters:{LOCATION_ID:a.oLoc.getValue()},success:function(e){a.prodModel.setData(e);a.oProdList.setModel(a.prodModel)},error:function(e,t){s.show("error")}})}else if(t.includes("prod")){var r=[];var n=[];var d=[];a.oProd=a.byId("idprod");var c=[];o=e.getParameters("selectedItems").selectedItems;for(var u in o){c[u]=o[u].getTitle();r.push(n)}a.oGModel.setProperty("/SelectedProd",c);a.oProd.setValue(c);a.byId("fromDate").setValue("");a.oVer.setValue("");a.oScen.setValue("");this.getView().getModel("oModel").callFunction("/getAllVerScen",{method:"GET",urlParameters:{LOCATION_ID:a.oGModel.getProperty("/SelectedLoc")},success:function(e){if(e.results.length===0){sap.m.MessageToast.show("No versions available for choosen Location/Product. Please choose another.");a.verModel.setData([]);a.oVerList.setModel(a.verModel)}else{var t=[];for(var i=0;i<e.results.length;i++){for(var s=0;s<o.length;s++){if(e.results[i].PRODUCT_ID===o[s].getTitle()){if(a.aOrder.indexOf(e.results[i].VERSION)===-1){a.aOrder.push(e.results[i].VERSION);if(e.results[i].VERSION!==""){a.oOrdData={VERSION:e.results[i].VERSION};t.push(a.oOrdData)}}}}}if(t.length>0){a.verModel.setData({results:t});a.oVerList.setModel(a.verModel)}}},error:function(e,t){s.show("error")}})}else if(t.includes("Ver")){this.oVer=a.byId("idver");o=e.getParameter("selectedItems");a.oVer.setValue(o[0].getTitle());a.oScen.setValue("");a.oGModel.setProperty("/SelectedVer",o[0].getTitle());var g=a.oGModel.getProperty("/SelectedProd");this.getView().getModel("oModel").callFunction("/getAllVerScen",{method:"GET",urlParameters:{LOCATION_ID:a.oGModel.getProperty("/SelectedLoc")},success:function(e){var t=[];for(var i=0;i<e.results.length;i++){for(var s=0;s<g.length;s++){if(e.results[i].PRODUCT_ID===g[s]&&e.results[i].VERSION===o[0].getTitle()){if(a.bOrder.indexOf(e.results[i].SCENARIO)===-1){a.bOrder.push(e.results[i].SCENARIO);if(e.results[i].SCENARIO!==""){a.bOrdData={SCENARIO:e.results[i].SCENARIO};t.push(a.bOrdData)}}}}}if(t.length>0){a.scenModel.setData({results:t});a.oScenList.setModel(a.scenModel)}},error:function(e,t){s.show("error")}})}else if(t.includes("scen")){sap.ui.core.BusyIndicator.show();this.oScen=a.byId("idscen");o=e.getParameter("selectedItems");a.oScen.setValue(o[0].getTitle());a.oGModel.setProperty("/SelectedScen",o[0].getTitle());sap.ui.core.BusyIndicator.hide()}a.handleClose(e)},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){a._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(a.oLocList.getBinding("items")){a.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){a._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(a.oProdList.getBinding("items")){a.oProdList.getBinding("items").filter([])}}else if(t.includes("Ver")){a._oCore.byId(this._valueHelpDialogVer.getId()+"-searchField").setValue("");if(a.oVerList.getBinding("items")){a.oVerList.getBinding("items").filter([])}}else if(t.includes("scen")){a._oCore.byId(this._valueHelpDialogScen.getId()+"-searchField").setValue("");if(a.oScenList.getBinding("items")){a.oScenList.getBinding("items").filter([])}}},onNavPress:function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var e=sap.ushell.Container.getService("CrossApplicationNavigation");var t=e&&e.hrefForExternal({target:{semanticObject:"vcpdocdisplay",action:"Display"}})||"";var i=window.location.href.split("#")[0]+t;sap.m.URLHelper.redirect(i,true)}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=e.getParameter("id"),l=[];t=t?t.trim():"";if(s.includes("Loc")){if(t!==""){l.push(new i({filters:[new i("LOCATION_ID",o.Contains,t),new i("LOCATION_DESC",o.Contains,t)],and:false}))}a.oLocList.getBinding("items").filter(l)}else if(s.includes("prod")){if(t!==""){l.push(new i({filters:[new i("PRODUCT_ID",o.Contains,t),new i("PROD_DESC",o.Contains,t)],and:false}))}a.oProdList.getBinding("items").filter(l)}else if(s.includes("Ver")){if(t!==""){l.push(new i({filters:[new i("VERSION",o.Contains,t)],and:false}))}a.oVerList.getBinding("items").filter(l)}else if(s.includes("scen")){if(t!==""){l.push(new i({filters:[new i("SCENARIO",o.Contains,t)],and:false}))}a.oScenList.getBinding("items").filter(l)}},onResetDate:function(){a.oLoc.setValue("");a.oProd.setValue("");a.oVer.setValue("");a.oScen.setValue("");a.byId("fromDate").setValue("")},onGetData:function(){var e=a.byId("idloc").getValue(),t=a.byId("idprod").getValue(),i=a.byId("idver").getValue(),o=a.byId("idscen").getValue();var s=a.byId("fromDate").getFrom();var l=a.byId("fromDate").getTo();var r=a.getDateFn(s);var n=a.getDateFn(l);var d={MARKETDATA:[]};var c={};if(e&&t&&i&&o&&s&&l){var u=a.oGModel.getProperty("/SelectedProd");for(var g in u){c={LOCATION_ID:e,PRODUCT_ID:u[g],VERSION:i,SCENARIO:o,FROMDATE:r,TODATE:n};d.MARKETDATA.push(c)}var p={};p=a.getScheduleSEDT();var h=(new Date).getTime();var f="/catalog/generateMarketAuth";var v="CIRQtys"+h;sap.ui.core.BusyIndicator.show();var D={name:v,description:"Market Authorization",action:encodeURIComponent(f),active:true,httpMethod:"POST",startTime:p.djSdate,endTime:p.djEdate,createdAt:p.djSdate,schedules:[{data:JSON.stringify(d.MARKETDATA),cron:"",time:p.oneTime,active:true,startTime:p.dsSDate,endTime:p.dsEDate}]};this.getView().getModel("JModel").callFunction("/addMLJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(D)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.addMLJob+": Job Created")},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error While publishing data!")}})}else{sap.m.MessageToast.show("Select Location/Product/Version/Scenario/Date")}},getDateFn:function(e){var t,i,o;var s=e.getMonth()+1;if(s<10){t="0"+s}else{t=s}if(e.getDate()<10){i="0"+e.getDate()}else{i=e.getDate()}return e=e.getFullYear()+"-"+t+"-"+i},getScheduleSEDT:function(){var e={};var t=new Date;var i=t.setSeconds(t.getSeconds()+20);var o=t.setHours(t.getHours()+2);i=new Date(i);o=new Date(o);var s=new Date,l=o,a=new Date,r=o,n,d,c,u;s=s.toISOString().split("T");n=s[1].split(":");l=l.toISOString().split("T");d=l[1].split(":");a=a.toISOString().split("T");c=a[1].split(":");r=r.toISOString().split("T");u=r[1].split(":");var t=(new Date).toLocaleString().split(" ");e.djSdate=s[0]+" "+n[0]+":"+n[1]+" "+"+0000";e.djEdate=l[0]+" "+d[0]+":"+d[1]+" "+"+0000";e.dsSDate=a[0]+" "+c[0]+":"+c[1]+" "+"+0000";e.dsEDate=r[0]+" "+u[0]+":"+u[1]+" "+"+0000";e.oneTime=i;return e}})});