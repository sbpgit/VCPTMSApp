sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,i,o,s,a){"use strict";var l;return e.extend("cpapp.cpmarketauthorization.controller.Home",{onInit:function(){l=this;l.TableModel=new t;l.locModel=new t;l.prodModel=new t;l.verModel=new t;l.scenModel=new t;l.TableModel.setSizeLimit(1e3);l.locModel.setSizeLimit(1e3);l.prodModel.setSizeLimit(1e3);l.verModel.setSizeLimit(1e3);l.scenModel.setSizeLimit(1e3);this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogVer){this._valueHelpDialogVer=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.VersionDialog",this);this.getView().addDependent(this._valueHelpDialogVer)}if(!this._valueHelpDialogScen){this._valueHelpDialogScen=sap.ui.xmlfragment("cpapp.cpmarketauthorization.view.ScenarioDialog",this);this.getView().addDependent(this._valueHelpDialogScen)}},onAfterRendering:function(){l.aOrder=[];l.bOrder=[];this.oLoc=this.byId("idloc");this.oProd=this.byId("idprod");this.oVer=this.byId("idver");this.oScen=this.byId("idscen");l._valueHelpDialogProd.setTitleAlignment("Center");l._valueHelpDialogLoc.setTitleAlignment("Center");l._valueHelpDialogVer.setTitleAlignment("Center");l._valueHelpDialogScen.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oVerList=this._oCore.byId(this._valueHelpDialogVer.getId()+"-list");this.oScenList=this._oCore.byId(this._valueHelpDialogScen.getId()+"-list");sap.ui.core.BusyIndicator.show();this.getView().getModel("oModel").read("/getLocation",{success:function(e){l.locModel.setData(e);l.oLocList.setModel(l.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,t){sap.ui.core.BusyIndicator.hide();s.show("error")}})},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("loc")){l._valueHelpDialogLoc.open()}else if(t.includes("prod")){if(l.byId("idloc").getValue()){l._valueHelpDialogProd.open()}else{s.show("Select Location")}}else if(t.includes("ver")){if(l.byId("idloc").getValue()&&l.byId("idprod").getValue()){l._valueHelpDialogVer.open()}else{s.show("Select Location and Product")}}else if(t.includes("scen")){if(l.byId("idloc").getValue()&&l.byId("idprod").getValue()&&l.byId("idver").getValue()){l._valueHelpDialogScen.open()}else{s.show("Select Location/Product/Version")}}},handleSelection:function(e){l.oGModel=l.getOwnerComponent().getModel("oGModel");var t=e.getParameter("id"),i=e.getParameter("selectedItems"),o,a=[];if(t.includes("Loc")){l.oLoc=l.byId("idloc");l.oProd=l.byId("idprod");o=e.getParameter("selectedItems");l.oLoc.setValue(o[0].getTitle());l.oGModel.setProperty("/SelectedLoc",o[0].getTitle());l.oProd.setValue("");l.byId("fromDate").setValue("");l.oGModel.setProperty("/SelectedProd","");this.getView().getModel("oModel").callFunction("/getAllProd",{method:"GET",urlParameters:{LOCATION_ID:l.oLoc.getValue()},success:function(e){l.prodModel.setData(e);l.oProdList.setModel(l.prodModel)},error:function(e,t){s.show("error")}})}else if(t.includes("prod")){var r=[];var n=[];var d=[];l.oProd=l.byId("idprod");var c=[];o=e.getParameters("selectedItems").selectedItems;for(var u in o){c[u]=o[u].getTitle();r.push(n)}l.oGModel.setProperty("/SelectedProd",c);l.oProd.setValue(c);l.byId("fromDate").setValue("");l.oVer.setValue("");l.oScen.setValue("");this.getView().getModel("oModel").callFunction("/getAllVerScen",{method:"GET",urlParameters:{LOCATION_ID:l.oGModel.getProperty("/SelectedLoc")},success:function(e){if(e.results.length===0){sap.m.MessageToast.show("No versions available for choosen Location/Product. Please choose another.");l.verModel.setData([]);l.oVerList.setModel(l.verModel)}else{var t=[];for(var i=0;i<e.results.length;i++){for(var s=0;s<o.length;s++){if(e.results[i].PRODUCT_ID===o[s].getTitle()){if(l.aOrder.indexOf(e.results[i].VERSION)===-1){l.aOrder.push(e.results[i].VERSION);if(e.results[i].VERSION!==""){l.oOrdData={VERSION:e.results[i].VERSION};t.push(l.oOrdData)}}}}}if(t.length>0){l.verModel.setData({results:t});l.oVerList.setModel(l.verModel)}}},error:function(e,t){s.show("error")}})}else if(t.includes("Ver")){this.oVer=l.byId("idver");o=e.getParameter("selectedItems");l.oVer.setValue(o[0].getTitle());l.oScen.setValue("");l.oGModel.setProperty("/SelectedVer",o[0].getTitle());var g=l.oGModel.getProperty("/SelectedProd");this.getView().getModel("oModel").callFunction("/getAllVerScen",{method:"GET",urlParameters:{LOCATION_ID:l.oGModel.getProperty("/SelectedLoc")},success:function(e){var t=[];for(var i=0;i<e.results.length;i++){for(var s=0;s<g.length;s++){if(e.results[i].PRODUCT_ID===g[s]&&e.results[i].VERSION===o[0].getTitle()){if(l.bOrder.indexOf(e.results[i].SCENARIO)===-1){l.bOrder.push(e.results[i].SCENARIO);if(e.results[i].SCENARIO!==""){l.bOrdData={SCENARIO:e.results[i].SCENARIO};t.push(l.bOrdData)}}}}}if(t.length>0){l.scenModel.setData({results:t});l.oScenList.setModel(l.scenModel)}},error:function(e,t){s.show("error")}})}else if(t.includes("scen")){sap.ui.core.BusyIndicator.show();this.oScen=l.byId("idscen");o=e.getParameter("selectedItems");l.oScen.setValue(o[0].getTitle());l.oGModel.setProperty("/SelectedScen",o[0].getTitle());sap.ui.core.BusyIndicator.hide()}l.handleClose(e)},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){l._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(l.oLocList.getBinding("items")){l.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){l._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(l.oProdList.getBinding("items")){l.oProdList.getBinding("items").filter([])}}else if(t.includes("Ver")){l._oCore.byId(this._valueHelpDialogVer.getId()+"-searchField").setValue("");if(l.oVerList.getBinding("items")){l.oVerList.getBinding("items").filter([])}}else if(t.includes("scen")){l._oCore.byId(this._valueHelpDialogScen.getId()+"-searchField").setValue("");if(l.oScenList.getBinding("items")){l.oScenList.getBinding("items").filter([])}}},onNavPress:function(){if(sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService){var e=sap.ushell.Container.getService("CrossApplicationNavigation");var t=e&&e.hrefForExternal({target:{semanticObject:"vcpdocdisplay",action:"Display"}})||"";var i=window.location.href.split("#")[0]+t;sap.m.URLHelper.redirect(i,true)}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),s=e.getParameter("id"),a=[];t=t?t.trim():"";if(s.includes("Loc")){if(t!==""){a.push(new i({filters:[new i("LOCATION_ID",o.Contains,t),new i("LOCATION_DESC",o.Contains,t)],and:false}))}l.oLocList.getBinding("items").filter(a)}else if(s.includes("prod")){if(t!==""){a.push(new i({filters:[new i("PRODUCT_ID",o.Contains,t),new i("PROD_DESC",o.Contains,t)],and:false}))}l.oProdList.getBinding("items").filter(a)}else if(s.includes("Ver")){if(t!==""){a.push(new i({filters:[new i("VERSION",o.Contains,t)],and:false}))}l.oVerList.getBinding("items").filter(a)}else if(s.includes("scen")){if(t!==""){a.push(new i({filters:[new i("SCENARIO",o.Contains,t)],and:false}))}l.oScenList.getBinding("items").filter(a)}},onResetDate:function(){l.oLoc.setValue("");l.oProd.setValue("");l.oVer.setValue("");l.oScen.setValue("");l.byId("fromDate").setValue("")},onGetData:function(){var e=l.byId("idloc").getValue(),t=l.byId("idprod").getValue(),i=l.byId("idver").getValue(),o=l.byId("idscen").getValue();var s=l.byId("fromDate").getFrom();var a=l.byId("fromDate").getTo();var r=l.getDateFn(s);var n=l.getDateFn(a);var d={MARKETDATA:[]};var c={};if(e&&t&&i&&o&&s&&a){var u=l.oGModel.getProperty("/SelectedProd");for(var g in u){c={LOCATION_ID:e,PRODUCT_ID:u[g],VERSION:i,SCENARIO:o,FROMDATE:r,TODATE:n};d.MARKETDATA.push(c)}var p={};p=l.getScheduleSEDT();var h=(new Date).getTime();var f="/catalog/generateMarketAuth";var v="Market Auth."+h;sap.ui.core.BusyIndicator.show();var D={name:v,description:"Market Authorization",action:encodeURIComponent(f),active:true,httpMethod:"POST",startTime:p.djSdate,endTime:p.djEdate,createdAt:p.djSdate,schedules:[{data:{MARKETDATA:JSON.stringify(d.MARKETDATA)},cron:"",time:p.oneTime,active:true,startTime:p.dsSDate,endTime:p.dsEDate}]};this.getView().getModel("JModel").callFunction("/addMLJob",{method:"GET",urlParameters:{jobDetails:JSON.stringify(D)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.addMLJob+": Job Created")},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error While publishing data!")}})}else{sap.m.MessageToast.show("Select Location/Product/Version/Scenario/Date")}},getDateFn:function(e){var t,i,o;var s=e.getMonth()+1;if(s<10){t="0"+s}else{t=s}if(e.getDate()<10){i="0"+e.getDate()}else{i=e.getDate()}return e=e.getFullYear()+"-"+t+"-"+i},getScheduleSEDT:function(){var e={};var t=new Date;var i=t.setSeconds(t.getSeconds()+20);var o=t.setHours(t.getHours()+2);i=new Date(i);o=new Date(o);var s=new Date,a=o,l=new Date,r=o,n,d,c,u;s=s.toISOString().split("T");n=s[1].split(":");a=a.toISOString().split("T");d=a[1].split(":");l=l.toISOString().split("T");c=l[1].split(":");r=r.toISOString().split("T");u=r[1].split(":");var t=(new Date).toLocaleString().split(" ");e.djSdate=s[0]+" "+n[0]+":"+n[1]+" "+"+0000";e.djEdate=a[0]+" "+d[0]+":"+d[1]+" "+"+0000";e.dsSDate=l[0]+" "+c[0]+":"+c[1]+" "+"+0000";e.dsEDate=r[0]+" "+u[0]+":"+u[1]+" "+"+0000";e.oneTime=i;return e}})});