sap.ui.define(["cpapp/cpmatvariant/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,i,o,a,s,r){"use strict";var n,l;return e.extend("cpapp.cpmatvariant.controller.ItemMaster",{onInit:function(){n=this;n.oModel=new i;this.locModel=new i;this.prodModel=new i;n.locModel.setSizeLimit(1e3);n.prodModel.setSizeLimit(1e3);this.oModel.setSizeLimit(1e3);this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")});this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpmatvariant.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpmatvariant.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogDescUpdate){this._valueHelpDialogDescUpdate=sap.ui.xmlfragment("cpapp.cpmatvariant.view.UniqueDescUpdate",this);this.getView().addDependent(this._valueHelpDialogDescUpdate)}if(!this._createCharacterstics){this._createCharacterstics=sap.ui.xmlfragment("cpapp.cpmatvariant.view.CreateChar",this);this.getView().addDependent(this._createCharacterstics)}if(!this._copyCharacterstics){this._copyCharacterstics=sap.ui.xmlfragment("cpapp.cpmatvariant.view.CopyChar",this);this.getView().addDependent(this._copyCharacterstics)}},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){n=this;n.oLoc=this.byId("idloc");this.oProd=this.byId("prodInput");n._valueHelpDialogLoc.setTitleAlignment("Center");n._valueHelpDialogProd.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");l=this.getModel("oGModel");sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocation",{success:function(e){sap.ui.core.BusyIndicator.hide();n.locModel.setData(e);n.oLocList.setModel(n.locModel)},error:function(e,i){sap.ui.core.BusyIndicator.hide();t.show("error")}})},handleValueHelp:function(e){var i=e.getParameter("id");if(i.includes("loc")){n._valueHelpDialogLoc.open()}else if(i.includes("prod")){if(n.byId("idloc").getValue()!==""){n._valueHelpDialogProd.open()}else{t.show("Select Location")}}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("loc")){n._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(n.oLocList.getBinding("items")){n.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){n._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(n.oProdList.getBinding("items")){n.oProdList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=e.getParameter("id"),s=[];t=t?t.trim():"";if(i.includes("loc")){if(t!==""){s.push(new o({filters:[new o("LOCATION_ID",a.Contains,t),new o("LOCATION_DESC",a.Contains,t)],and:false}))}n.oLocList.getBinding("items").filter(s)}else if(i.includes("prod")){if(t!==""){s.push(new o({filters:[new o("PRODUCT_ID",a.Contains,t),new o("PROD_DESC",a.Contains,t)],and:false}))}n.oProdList.getBinding("items").filter(s)}},handleSelection:function(e){var i=e.getParameter("id"),s=e.getParameter("selectedItems"),r,l=[];if(i.includes("Loc")){this.oLoc=n.byId("idloc");r=e.getParameter("selectedItems");n.oLoc.setValue(r[0].getTitle());n.oProd.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new o("LOCATION_ID",a.EQ,r[0].getTitle())],success:function(e){n.prodModel.setData(e);n.oProdList.setModel(n.prodModel)},error:function(e,i){t.show("error")}})}else if(i.includes("prod")){this.oProd=n.byId("prodInput");r=e.getParameter("selectedItems");n.oProd.setValue(r[0].getTitle())}n.handleClose(e)},onGetData:function(e){var i=n.oLoc.getValue(),s=n.oProd.getValue(),r=n.byId("idUnique").getSelectedKey();this.byId("idCreateBtn").setVisible(true);this.byId("idCopyBtn").setVisible(true);var d=[];d.push(new o({filters:[new o("LOCATION_ID",a.EQ,i),new o("PRODUCT_ID",a.EQ,s)],and:true}));if(r!=="A"){d.push(new o({filters:[new o("UID_TYPE",a.EQ,r)],and:true}))}sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getUniqueHeader",{filters:[d],success:function(e){sap.ui.core.BusyIndicator.hide();if(e.results.length){n.oModel.setData({results:e.results});n.byId("idMatVHead").setModel(n.oModel);l.setProperty("/locId",e.results[0].LOCATION_ID);l.setProperty("/prdId",e.results[0].PRODUCT_ID);l.setProperty("/uniqId",e.results[0].UNIQUE_ID);n.byId("idMatVHead").setSelectedItem(n.byId("idMatVHead").getItems()[0],true);n.onhandlePress()}else{t.show("No data foe the selected Location Product")}},error:function(){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})},onhandlePress:function(e){l=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();l.setProperty("/prdId",t.PRODUCT_ID);l.setProperty("/locId",t.LOCATION_ID);l.setProperty("/uniqId",t.UNIQUE_ID)}n.getOwnerComponent().runAsOwner(function(){if(!n.oDetailView){try{n.oDetailView=sap.ui.view({viewName:"cpapp.cpmatvariant.view.ItemDetail",type:"XML"});n.bus.publish("flexible","addDetailPage",n.oDetailView);n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}catch(e){n.oDetailView.onAfterRendering()}}else{n.bus.publish("nav","toDetailPage",{viewName:n.oDetailView.getViewName()})}})},onSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=[];if(t!==""){i.push(new o({filters:[new o("UNIQUE_RDESC",a.Contains,t),new o("UNIQUE_ID",a.Contains,t)],and:false}))}n.byId("idMatVHead").getBinding("items").filter(i)},onEditDesc:function(e){var t=e.getSource().getParent().getBindingContext().getObject();l.setProperty("/SelectedData",t);l.setProperty("/SelectedId",t.UNIQUE_ID);l.setProperty("/SelectedDesc",t.UNIQUE_DESC);this._valueHelpDialogDescUpdate.open()},onCloseDesc:function(){this._valueHelpDialogDescUpdate.close()},onUpdateUniqueDesc:function(){var e=l.getProperty("/SelectedData");var i=sap.ui.getCore().byId("idUniqDesc").getValue();var o;if(e.ACTIVE===true){o=""}else{o="X"}n.getModel("BModel").callFunction("/changeUnique",{method:"GET",urlParameters:{LOCATION_ID:e.LOCATION_ID,PRODUCT_ID:e.PRODUCT_ID,UNIQUE_ID:e.UNIQUE_ID,UID_TYPE:e.UID_TYPE,UNIQUE_DESC:i,ACTIVE:o},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.changeUnique);n.onCloseDesc();n.onGetData()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to changes the status")}})},onChange:function(e){var i=e.getSource().getBindingContext().getObject();var o;if(i.ACTIVE===true){o="X"}else{o=""}n.getModel("BModel").callFunction("/changeUnique",{method:"GET",urlParameters:{LOCATION_ID:i.LOCATION_ID,PRODUCT_ID:i.PRODUCT_ID,UNIQUE_ID:i.UNIQUE_ID,UID_TYPE:i.UID_TYPE,UNIQUE_DESC:i.UNIQUE_DESC,ACTIVE:o},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.changeUnique);n.onGetData()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to changes the status")}})},onCreateBtn:function(){n._createCharacterstics.open()},onCopyBtn:function(){n._copyCharacterstics.open()},onCloseCreate:function(){this._createCharacterstics.close()},onCloseCopy:function(){this._copyCharacterstics.close()}})});