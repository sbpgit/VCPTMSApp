sap.ui.define(["cpapp/cpmatvariant/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,a,i,s,o,r){"use strict";var l,d;return e.extend("cpapp.cpmatvariant.controller.ItemMaster",{onInit:function(){l=this;l.oModel=new a;this.locModel=new a;this.prodModel=new a;l.oCharModel=new a;l.charnameModel=new a;l.charvalueModel=new a;l.locModel.setSizeLimit(1e3);l.prodModel.setSizeLimit(1e3);this.oModel.setSizeLimit(1e3);this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")});this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cpmatvariant.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cpmatvariant.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogDescUpdate){this._valueHelpDialogDescUpdate=sap.ui.xmlfragment("cpapp.cpmatvariant.view.UniqueDescUpdate",this);this.getView().addDependent(this._valueHelpDialogDescUpdate)}if(!this._addCharacteristic){this._addCharacteristic=sap.ui.xmlfragment("cpapp.cpmatvariant.view.AddCharacterstics",this);this.getView().addDependent(this._addCharacteristic)}if(!this._createCharacterstics){this._createCharacterstics=sap.ui.xmlfragment("cpapp.cpmatvariant.view.CreateChar",this);this.getView().addDependent(this._createCharacterstics)}if(!this._copyCharacterstics){this._copyCharacterstics=sap.ui.xmlfragment("cpapp.cpmatvariant.view.CopyChar",this);this.getView().addDependent(this._copyCharacterstics)}},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){l=this;l.oLoc=this.byId("idloc");this.oProd=this.byId("prodInput");l._valueHelpDialogLoc.setTitleAlignment("Center");l._valueHelpDialogProd.setTitleAlignment("Center");l.oTableData=[];sap.ui.getCore().byId("idUniqDesc1").setValue("");l.ListModel=new a;l.ListModel.setData({results:l.oTableData});sap.ui.getCore().byId("idCharItem").setModel(l.ListModel);this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");d=this.getModel("oGModel");d.setProperty("/New","");sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocation",{success:function(e){sap.ui.core.BusyIndicator.hide();l.locModel.setData(e);l.oLocList.setModel(l.locModel)},error:function(e,a){sap.ui.core.BusyIndicator.hide();t.show("error")}})},handleValueHelp:function(e){var a=e.getParameter("id");d.setProperty("/mainSID",a);if(a.includes("loc")){l._valueHelpDialogLoc.open()}else if(a.includes("prod")){if(l.byId("idloc").getValue()!==""){l._valueHelpDialogProd.open()}else{t.show("Select Location")}}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("loc")){l._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(l.oLocList.getBinding("items")){l.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){l._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(l.oProdList.getBinding("items")){l.oProdList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),a=e.getParameter("id"),o=[];t=t?t.trim():"";if(a.includes("loc")){if(t!==""){o.push(new i({filters:[new i("LOCATION_ID",s.Contains,t),new i("LOCATION_DESC",s.Contains,t)],and:false}))}l.oLocList.getBinding("items").filter(o)}else if(a.includes("prod")){if(t!==""){o.push(new i({filters:[new i("PRODUCT_ID",s.Contains,t),new i("PROD_DESC",s.Contains,t)],and:false}))}l.oProdList.getBinding("items").filter(o)}},handleSelection:function(e){var a=e.getParameter("id"),o=d.getProperty("/mainSID"),r=e.getParameter("selectedItems"),n,u=[];if(a.includes("Loc")){this.oLoc=l.byId("idloc");n=e.getParameter("selectedItems");if(o==="__xmlview1--idloc"){l.oLoc.setValue(n[0].getTitle())}else if(o==="locId1"){sap.ui.getCore().byId("locId1").setValue(n[0].getTitle())}else if(o==="locIdCC"){sap.ui.getCore().byId("locIdCC").setValue(n[0].getTitle())}l.oProd.removeAllTokens();this._valueHelpDialogProd.getAggregation("_dialog").getContent()[1].removeSelections();this.getModel("BModel").read("/getLocProdDet",{filters:[new i("LOCATION_ID",s.EQ,n[0].getTitle())],success:function(e){l.prodModel.setData(e);l.oProdList.setModel(l.prodModel)},error:function(e,a){t.show("error")}})}else if(a.includes("prod")){this.oProd=l.byId("prodInput");n=e.getParameter("selectedItems");if(o==="__xmlview1--prodInput"){l.oProd.setValue(n[0].getTitle())}else if(o==="prodId1"){sap.ui.getCore().byId("prodId1").setValue(n[0].getTitle())}else if(o==="prodIdCC"){sap.ui.getCore().byId("prodIdCC").setValue(n[0].getTitle())}}l.handleClose(e)},onGetData:function(e){var a=l.oLoc.getValue(),o=l.oProd.getValue(),r=l.byId("idUnique").getSelectedKey();var n=[];n.push(new i({filters:[new i("LOCATION_ID",s.EQ,a),new i("PRODUCT_ID",s.EQ,o)],and:true}));if(r!=="A"){n.push(new i({filters:[new i("UID_TYPE",s.EQ,r)],and:true}))}sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getUniqueHeader",{filters:[n],success:function(e){sap.ui.core.BusyIndicator.hide();if(e.results.length){l.oModel.setData({results:e.results});d.setProperty("/uniqueData",e.results);l.byId("idMatVHead").setModel(l.oModel);d.setProperty("/locId",e.results[0].LOCATION_ID);d.setProperty("/prdId",e.results[0].PRODUCT_ID);d.setProperty("/uniqId",e.results[0].UNIQUE_ID);d.setProperty("/uid_rate",e.results[0].UID_RATE);l.byId("idMatVHead").setSelectedItem(l.byId("idMatVHead").getItems()[0],true);l.byId("idCreateBtn").setVisible(true);l.byId("idCopyBtn").setVisible(true);l.onhandlePress()}else{t.show("No data for the selected Location Product")}},error:function(){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}})},onhandlePress:function(e){d=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();d.setProperty("/prdId",t.PRODUCT_ID);d.setProperty("/locId",t.LOCATION_ID);d.setProperty("/uniqId",t.UNIQUE_ID);d.setProperty("/uid_rate",t.UID_RATE);d.setProperty("/uid_active",t.ACTIVE)}l.getOwnerComponent().runAsOwner(function(){if(!l.oDetailView){try{l.oDetailView=sap.ui.view({viewName:"cpapp.cpmatvariant.view.ItemDetail",type:"XML"});l.bus.publish("flexible","addDetailPage",l.oDetailView);l.bus.publish("nav","toDetailPage",{viewName:l.oDetailView.getViewName()})}catch(e){l.oDetailView.onAfterRendering()}}else{l.bus.publish("nav","toDetailPage",{viewName:l.oDetailView.getViewName()})}})},onSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),a=[];if(t!==""){a.push(new i({filters:[new i("UNIQUE_RDESC",s.Contains,t),new i("UNIQUE_ID",s.Contains,t)],and:false}))}l.byId("idMatVHead").getBinding("items").filter(a)},onEditDesc:function(e){var t=e.getSource().getParent().getBindingContext().getObject();d.setProperty("/SelectedData",t);d.setProperty("/SelectedId",t.UNIQUE_ID);d.setProperty("/SelectedDesc",t.UNIQUE_DESC);d.setProperty("/SelectedURate",t.UID_RATE);this._valueHelpDialogDescUpdate.open()},onCloseDesc:function(){this._valueHelpDialogDescUpdate.close()},onUpdateUniqueDesc:function(){var e=d.getProperty("/SelectedData");var a=sap.ui.getCore().byId("idUniqDesc").getValue();var i=sap.ui.getCore().byId("idUniqRate").getValue();var s;if(e.ACTIVE===true){s=""}else{s="X"}l.getModel("BModel").callFunction("/changeUnique",{method:"GET",urlParameters:{LOCATION_ID:e.LOCATION_ID,PRODUCT_ID:e.PRODUCT_ID,UNIQUE_ID:e.UNIQUE_ID,UID_TYPE:e.UID_TYPE,UNIQUE_DESC:a,ACTIVE:s,FLAG:"E"},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.changeUnique);l.onCloseDesc();l.onGetData()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to changes the status")}})},onChange:function(e){var a=e.getSource().getBindingContext().getObject();var i;if(a.ACTIVE===true){i="X"}else{i=""}l.getModel("BModel").callFunction("/changeUnique",{method:"GET",urlParameters:{LOCATION_ID:a.LOCATION_ID,PRODUCT_ID:a.PRODUCT_ID,UNIQUE_ID:a.UNIQUE_ID,UID_TYPE:a.UID_TYPE,UNIQUE_DESC:a.UNIQUE_DESC,ACTIVE:i},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.changeUnique);l.onGetData()},error:function(e){sap.ui.core.BusyIndicator.hide();t.show("Failed to changes the status")}})},onCreateBtn:function(){l.oTableData=[];sap.ui.getCore().byId("idUniqDesc1").setValue("");l.ListModel=new a;l.ListModel.setData({results:l.oTableData});sap.ui.getCore().byId("idCharItem").setModel(l.ListModel);l._createCharacterstics.open();var e=this.byId("idloc").getValue(),t=this.byId("prodInput").getValue(),i=this.byId("idUnique").getSelectedKey();sap.ui.getCore().byId("locId1").setValue(e);sap.ui.getCore().byId("prodId1").setValue(t);d.setProperty("/New","N")},onCopyBtn:function(e){var t=l.byId("idMatVHead").getSelectedItem().getBindingContext().getProperty();var i="Please Confirm to copy characteristics of Unique ID"+" - "+t.UNIQUE_ID;sap.m.MessageBox.show(i,{title:"Conformation",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:function(e){if(e===sap.m.MessageBox.Action.YES){sap.ui.getCore().byId("locId1").setValue(t.LOCATION_ID);sap.ui.getCore().byId("prodId1").setValue(t.PRODUCT_ID);sap.ui.getCore().byId("idUniqDesc1").setValue(t.UNIQUE_DESC);d.setProperty("/New","C");l.oTableData=d.getProperty("/CharData");l.ListModel=new a;l.ListModel.setData({results:l.oTableData});sap.ui.getCore().byId("idCharItem").setModel(l.ListModel);l._createCharacterstics.open()}}})},onCloseCreate:function(){this._createCharacterstics.close()},onCloseCopy:function(){this._copyCharacterstics.close()},onAddChar:function(){sap.ui.getCore().byId("idClassname2").setValue("");sap.ui.getCore().byId("idCharname2").setValue("");sap.ui.getCore().byId("idCharval2").setValue("");l._addCharacteristic.open()},handleCharValueHelp:function(e){if(!this._valueHelpDialogcharName){this._valueHelpDialogcharName=sap.ui.xmlfragment("cpapp.cpmatvariant.view.charName",this);this.getView().addDependent(this._valueHelpDialogcharName)}if(!this._valueHelpDialogcharValue){this._valueHelpDialogcharValue=sap.ui.xmlfragment("cpapp.cpmatvariant.view.charValue",this);this.getView().addDependent(this._valueHelpDialogcharValue)}if(!this._valueHelpDialogclassName){this._valueHelpDialogclassName=sap.ui.xmlfragment("cpapp.cpmatvariant.view.className",this);this.getView().addDependent(this._valueHelpDialogclassName)}var o=e.getParameter("id");var r=d.getProperty("/prdId");var n=d.getProperty("/locId");if(o.includes("Classname")){l.getModel("BModel").read("/getProdClass",{filters:[new i("PRODUCT_ID",s.Contains,r),new i("LOCATION_ID",s.Contains,n)],success:function(e){sap.ui.core.BusyIndicator.hide();l.classNameData=e.results;var t=new a;t.setData({results:l.classNameData});sap.ui.getCore().byId("classNameList").setModel(t);l._valueHelpDialogclassName.open()},error:function(){sap.ui.core.BusyIndicator.hide();t.show("Failed to get class name data")}})}else if(o.includes("Charname")){if(sap.ui.getCore().byId("idClassname2").getValue()){l._valueHelpDialogcharName.open()}else{t.show("Select Class Name")}}else if(o.includes("Charval")){if(sap.ui.getCore().byId("idCharname2").getValue()){l._valueHelpDialogcharValue.open()}else{t.show("Select Class Name and Characteristic Name")}}},handleCharSelection:function(e){l.oGModel=l.getModel("oGModel");var a=e.getParameter("id"),o=e.getParameter("selectedItems"),r,n=[];if(a.includes("className")){l.oClassName=sap.ui.getCore().byId("idClassname2");r=e.getParameter("selectedItems");l.oClassName.setValue(r[0].getTitle());d.setProperty("/UID_Rate",r[0].getBindingContext().getProperty().CLASS_NUM);sap.ui.getCore().byId("idCharname2").setValue("");sap.ui.getCore().byId("idCharval2").setValue("");this.getModel("BModel").read("/getClassChar",{filters:[new i("CLASS_NUM",s.EQ,r[0].getBindingContext().getProperty().CLASS_NUM)],success:function(e){sap.ui.core.BusyIndicator.hide();function t(e,t){var a=new Set;return e.filter(e=>!a.has(e[t])&&a.add(e[t]))}l.charnameModel.setData({results:t(e.results,"CHAR_NAME")});sap.ui.getCore().byId("charNameList").setModel(l.charnameModel)},error:function(e,a){sap.ui.core.BusyIndicator.hide();t.show("error")}})}else if(a.includes("charName")){l.oCharName=sap.ui.getCore().byId("idCharname2");r=e.getParameter("selectedItems");l.oCharName.setValue(r[0].getTitle());d.setProperty("/Char_Num",r[0].getDescription());sap.ui.getCore().byId("idCharval2").setValue("");this.getModel("BModel").read("/getClassChar",{filters:[new i("CLASS_NUM",s.EQ,r[0].getBindingContext().getProperty().CLASS_NUM),new i("CHAR_NAME",s.EQ,sap.ui.getCore().byId("idCharname2").getValue())],success:function(e){sap.ui.core.BusyIndicator.hide();function t(e,t){var a=new Set;return e.filter(e=>!a.has(e[t])&&a.add(e[t]))}l.charvalueModel.setData({results:t(e.results,"CHAR_VALUE")});sap.ui.getCore().byId("charValList").setModel(l.charvalueModel)},error:function(e,a){sap.ui.core.BusyIndicator.hide();t.show("error")}})}else if(a.includes("charVal")){l.oCharVal=sap.ui.getCore().byId("idCharval2");r=e.getParameter("selectedItems");l.oCharVal.setValue(r[0].getTitle());d.setProperty("/CharVal_Num",r[0].getDescription())}},handleCharSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),a=e.getParameter("id"),o=[];t=t?t.trim():"";if(a.includes("className")){if(t!==""){o.push(new i({filters:[new i("CLASS_NAME",s.Contains,t)],and:false}))}l.oClassnameList=sap.ui.getCore().byId("classNameList");l.oClassnameList.getBinding("items").filter(o)}else if(a.includes("charName")){if(t!==""){o.push(new i({filters:[new i("CHAR_NAME",s.Contains,t)],and:false}))}l.oCharnameList=sap.ui.getCore().byId("charNameList");l.oCharnameList.getBinding("items").filter(o)}else if(a.includes("charVal")){if(t!==""){o.push(new i({filters:[new i("CHAR_VALUE",s.Contains,t)],and:false}))}l.oCharvalueList=sap.ui.getCore().byId("charValList");l.oCharvalueList.getBinding("items").filter(o)}},handleCharClose:function(e){var t=e.getParameter("id");if(t.includes("className")){l._oCore.byId(this._valueHelpDialogclassName.getId()+"-searchField").setValue("");if(l.oClassnameList.getBinding("items")){l.oClassnameList.getBinding("items").filter([])}}else if(t.includes("charName")){l._oCore.byId(this._valueHelpDialogcharName.getId()+"-searchField").setValue("");if(l.oCharnameList.getBinding("items")){l.oCharnameList.getBinding("items").filter([])}}else if(t.includes("charVal")){l._oCore.byId(this._valueHelpDialogcharValue.getId()+"-searchField").setValue("");if(l.oCharvalueList.getBinding("items")){l.oCharvalueList.getBinding("items").filter([])}}},onCloseRestItem:function(){sap.ui.getCore().byId("idClassname2").setValue("");sap.ui.getCore().byId("idCharname2").setValue("");sap.ui.getCore().byId("idCharval2").setValue("");l._addCharacteristic.close()},onAdd:function(){var e=sap.ui.getCore().byId("idCharname2").getValue(),i=d.getProperty("/Char_Num"),s=sap.ui.getCore().byId("idCharval2").getValue(),o=d.getProperty("/CharVal_Num"),r=sap.ui.getCore().byId("idClassname2").getValue();if(e!==""&&s!==""&&r!==""){this.oData={CLASS_NAME:r,CHAR_NAME:e,CHAR_NUM:i,CHAR_VALUE:s,CHARVAL_NUM:o,OFLAG:"X"};var n=sap.ui.getCore().byId("idCharItem").getItems();var u=0;for(var c=0;c<n.length;c++){if(n[c].getCells()[1].getText()===i&&n[c].getCells()[3].getText()===o){u=u+1}}if(u===0){l.oTableData.push(l.oData);l.ListModel=new a;l.ListModel.setData({results:l.oTableData});sap.ui.getCore().byId("idCharItem").setModel(l.ListModel);l._addCharacteristic.close()}else{sap.m.MessageToast.show("Characterstic is already maintained")}}else{t.show("Please fill all inputs")}},onTabDel:function(e){var t=e.getSource().getParent().getBindingContext().getObject();var a=e.getParameters("listItem").id.split("idCharItem-")[1];var i=l.ListModel.getData().results;i.splice(a,1);l.ListModel.refresh()},onCreateUniq:function(){var e;var t={RTRCHAR:[]};var a=sap.ui.getCore().byId("locId1").getValue(),i=sap.ui.getCore().byId("prodId1").getValue(),s=1,o=sap.ui.getCore().byId("idUniqDesc1").getValue(),r=sap.ui.getCore().byId("idComboBox1").getValue(),n=sap.ui.getCore().byId("uidRId1").getValue(),u=sap.ui.getCore().byId("idComboBox").getValue(),c="C",g=0;if(u==="True"){u=""}else{u="X"}var p=sap.ui.getCore().byId("idCharItem").getItems();var C=d.getProperty("/New");for(var h=0;h<p.length;h++){var I=p[h].getBindingContext().getObject();e={LOCATION_ID:a,PRODUCT_ID:i,UNIQUE_ID:s,UNIQUE_DESC:o,CHAR_NUM:I.CHAR_NUM,CHARVAL_NUM:I.CHARVAL_NUM};t.RTRCHAR.push(e)}sap.ui.core.BusyIndicator.show();l.getModel("BModel").callFunction("/maintainUniqueChar",{method:"GET",urlParameters:{FLAG:C,UNIQUECHAR:JSON.stringify(t.RTRCHAR)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.maintainUniqueChar);l.onAfterRendering();l.onCloseCreate()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error")}})},onCopyUniqueDesc:function(){var e=d.getProperty("/uniqueData");var t=sap.ui.getCore().byId("locIdCC").getValue(),a=sap.ui.getCore().byId("prodIdCC").getValue(),i=1,s=sap.ui.getCore().byId("idUniqDescCC").getValue(),o=sap.ui.getCore().byId("idComboBoxCC").getSelectedKey(),r=sap.ui.getCore().byId("uidRIdCC").getValue(),n=sap.ui.getCore().byId("idComboBoxAC").getValue(),u="C",c=0;if(n==="True"){n=""}else{n="X"}if(t===""||a===""||r===""){sap.m.MessageToast.show("Please select Location/Product/Unique Rate")}else{sap.ui.core.BusyIndicator.show();var g=l.getView().getModel("BModel");g.callFunction("/changeUnique",{method:"GET",urlParameters:{UNIQUE_ID:i,LOCATION_ID:t,PRODUCT_ID:a,UID_TYPE:o,UNIQUE_DESC:s,ACTIVE:n,FLAG:"C"},success:function(e){sap.m.MessageToast.show(e.changeUnique);l.onAfterRendering();l._copyCharacterstics.close();l.onGetData();sap.ui.core.BusyIndicator.hide()},error(e){sap.m.MessageToast.show("Failed to Create");sap.ui.core.BusyIndicator.hide()}})}}})});