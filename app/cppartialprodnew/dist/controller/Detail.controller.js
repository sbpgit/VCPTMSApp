sap.ui.define(["sap/ui/core/mvc/Controller","cpapp/cppartialprodnew/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,a,o,i,s,r){"use strict";var d,l;return t.extend("cpapp.cppartialprodnew.controller.Detail",{onInit:function(){l=this;l.ListModel=new a;l.locModel=new a;l.prodModel=new a;l.classnameModel=new a;l.ListModel.setSizeLimit(1e3);l.locModel.setSizeLimit(1e3);l.prodModel.setSizeLimit(1e3);l.classnameModel.setSizeLimit(1e3);l.oData={};this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cppartialprodnew.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogProd){this._valueHelpDialogProd=sap.ui.xmlfragment("cpapp.cppartialprodnew.view.ProdDialog",this);this.getView().addDependent(this._valueHelpDialogProd)}if(!this._valueHelpDialogclassName){this._valueHelpDialogclassName=sap.ui.xmlfragment("cpapp.cppartialprodnew.view.className",this);this.getView().addDependent(this._valueHelpDialogclassName)}l.aData=[]},onAfterRendering:function(){this.oResourceBundle=this.getView().getModel("i18n").getResourceBundle();d=this.getModel("oGModel");this.oLoc=l.byId("idloc");this.oProd=l.byId("idrefprod");l._valueHelpDialogProd.setTitleAlignment("Center");l._valueHelpDialogLoc.setTitleAlignment("Center");this.oProdList=this._oCore.byId(this._valueHelpDialogProd.getId()+"-list");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oClassnameList=this._oCore.byId(this._valueHelpDialogclassName.getId()+"-list");l.aData=[];if(d.getProperty("/sFlag")==="E"){l.byId("idClassChar").setTitle("Update Product");l.byId("idloc").setEditable(false);l.byId("idProd").setEditable(false);l.byId("idloc").setValue(d.getProperty("/Loc"));l.byId("idProd").setValue(d.getProperty("/Prod"));l.byId("idrefprod").setValue(d.getProperty("/refProd"));l.getCharData();l.byId("idprodPanel").setExpanded(false)}else if(d.getProperty("/sFlag")==="C"){l.byId("idClassChar").setTitle("New Product");l.byId("idloc").setEditable(true);l.byId("idProd").setEditable(true);l.byId("idloc").setValue("");l.byId("idProd").setValue("");l.byId("idrefprod").setValue("");l.ListModel.setData({results:l.aData});l.byId("idprodPanel").setExpanded(true)}this.getModel("BModel").read("/getLocation",{success:function(e){sap.ui.core.BusyIndicator.hide();l.locModel.setData(e);l.oLocList.setModel(l.locModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();s.show("error")}})},onBack:function(){var e=sap.ui.core.UIComponent.getRouterFor(l);e.navTo("Home",{},true)},getCharData:function(){var e=d.getProperty("/Prod"),t=d.getProperty("/refProd");this.getModel("BModel").read("/getPartialChar",{filters:[new o("PRODUCT_ID",i.EQ,e),new o("REF_PRODID",i.EQ,t)],success:function(e){l.ListModel.setData({results:e.results});l.byId("idCharList").setModel(l.ListModel);var t=e.results;if(t.length){for(var a=0;a<t.length;a++){l.oData={CLASS_NAME:t[a].CLASS_NAME,CLASS_NUM:t[a].CLASS_NUM,CHAR_NAME:t[a].CHAR_NAME,CHAR_NUM:t[a].CHAR_NUM,CHAR_VALUE:t[a].CHAR_VALUE,CHARVAL_NUM:t[a].CHARVAL_NUM};l.aData.push(l.oData)}}l.charData()},error:function(){s.show("Failed to get data")}})},handleValueHelp:function(e){var t=e.getParameter("id");d.setProperty("/OpenProdInut","");if(t.includes("loc")){l._valueHelpDialogLoc.open()}else if(t.includes("idrefprod")){l.ProdData();if(l.byId("idloc").getValue()){d.setProperty("/OpenProdInut","RP");l._valueHelpDialogProd.open()}else{s.show("Select Location")}}else if(t.includes("idProd")){l.ProdData();if(l.byId("idloc").getValue()){d.setProperty("/OpenProdInut","NP");l._valueHelpDialogProd.open()}else{s.show("Select Location")}}else if(t.includes("idAdd")){if(l.byId("idloc").getValue()&&l.byId("idProd").getValue()&&l.byId("idrefprod").getValue()){l._valueHelpDialogclassName.open()}else{s.show("Select Location/ Partial/ Ref Product")}}},ProdData:function(){sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/getLocProdDet",{filters:[new o("LOCATION_ID",i.EQ,l.byId("idloc").getValue())],success:function(e){sap.ui.core.BusyIndicator.hide();l.prodModel.setData(e);l.oProdList.setModel(l.prodModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();s.show("error")}})},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){l._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(l.oLocList.getBinding("items")){l.oLocList.getBinding("items").filter([])}}else if(t.includes("prod")){l._oCore.byId(this._valueHelpDialogProd.getId()+"-searchField").setValue("");if(l.oProdList.getBinding("items")){l.oProdList.getBinding("items").filter([])}}else if(t.includes("className")){l._oCore.byId(this._valueHelpDialogclassName.getId()+"-searchField").setValue("");if(l.oClassnameList.getBinding("items")){l.oClassnameList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),a=e.getParameter("id"),s=[];t=t?t.trim():"";if(a.includes("Loc")){if(t!==""){s.push(new o({filters:[new o("LOCATION_ID",i.Contains,t),new o("LOCATION_DESC",i.Contains,t)],and:false}))}l.oLocList.getBinding("items").filter(s)}else if(a.includes("prodSlctList")){if(t!==""){s.push(new o({filters:[new o("PRODUCT_ID",i.Contains,t),new o("PROD_DESC",i.Contains,t)],and:false}))}l.oProdList.getBinding("items").filter(s)}else if(a.includes("className")){if(t!==""){s.push(new o({filters:[new o("CLASS_NAME",i.Contains,t),new o("CHAR_NAME",i.Contains,t),new o("CHAR_VALUE",i.Contains,t)],and:false}))}l.oClassnameList.getBinding("items").filter(s)}},handleSelection:function(e){l.oGModel=l.getModel("oGModel");var t=e.getParameter("id"),a=e.getParameter("selectedItems"),o,i=[];var r=0;if(t.includes("Loc")){l.oLoc=l.byId("idloc");l.oProd=l.byId("idrefprod");o=e.getParameter("selectedItems");l.oLoc.setValue(o[0].getTitle());l.oGModel.setProperty("/SelectedLoc",o[0].getTitle());l.oProd.setValue("");l.byId("idProd").setValue("");l.oGModel.setProperty("/SelectedProd","")}else if(t.includes("prod")){if(d.getProperty("/OpenProdInut")==="RP"){l.oProd=l.byId("idrefprod");o=e.getParameter("selectedItems");l.oProd.setValue(o[0].getTitle());l.oGModel.setProperty("/SelectedProd",o[0].getTitle());l.aData=[];l.ListModel.setData({results:l.aData});l.byId("idCharList").setModel(l.ListModel);l.charData();if(l.byId("idProd").getValue()){l.byId("idprodPanel").setExpanded(false)}else{s.show("Please enter product")}}else if(d.getProperty("/OpenProdInut")==="NP"){l.oNewProd=l.byId("idProd");o=e.getParameter("selectedItems");l.oNewProd.setValue(o[0].getTitle());l.oGModel.setProperty("/SelectednewProd",o[0].getTitle())}}else if(t.includes("className")){o=e.getParameter("selectedItems")[0].getBindingContext().getProperty();var r=0;if(l.aData.length){for(var n=0;n<l.aData.length;n++){if(this.aData[n].CLASS_NAME===o.CLASS_NAME&&this.aData[n].CHAR_NAME===o.CHAR_NAME&&this.aData[n].CHAR_VALUE===o.CHAR_VALUE){r=r+1}}}if(r===0){this.oData={CLASS_NAME:o.CLASS_NAME,CLASS_NUM:o.CLASS_NUM,CHAR_NAME:o.CHAR_NAME,CHAR_NUM:o.CHAR_NUM,CHAR_VALUE:o.CHAR_VALUE,CHARVAL_NUM:o.CHARVAL_NUM};l.aData.push(l.oData);l.ListModel.setData({results:l.aData});l.byId("idCharList").setModel(l.ListModel)}else{s.show("Selected characteristics already added")}}l.handleClose(e)},charData:function(){this.getModel("BModel").read("/getProdClsChar",{filters:[new o("PRODUCT_ID",i.EQ,l.byId("idrefprod").getValue())],success:function(e){sap.ui.core.BusyIndicator.hide();l.classnameModel.setData({results:e.results});l.oClassnameList.setModel(l.classnameModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();s.show("error")}})},onCharDel:function(e){var t=e.getParameters("listItem").id.split("CharList-")[1];var a=l.ListModel.getData().results;a.splice(t,1);l.ListModel.refresh()},onProdSave:function(e){var t=this.byId("idloc").getValue(),a=this.byId("idrefprod").getValue(),o=this.byId("idProdDesc").getValue(),i=this.byId("idProd").getValue(),r=d.getProperty("/sFlag");if(a===i){s.show("Reference product and new product can not be same")}else{l.getModel("BModel").callFunction("/maintainPartialProd",{method:"GET",urlParameters:{LOCATION_ID:t,PRODUCT_ID:i,PROD_DESC:o,REF_PRODID:a,FLAG:r},success:function(e){sap.ui.core.BusyIndicator.hide();l.createChar();l.createIBPProd()},error:function(e){s.show("Failed to create /updaate the producr");sap.ui.core.BusyIndicator.hide()}})}},createChar:function(){var e={PRODCHAR:[]},t;var a=l.ListModel.getData().results;var o=d.getProperty("/sFlag");for(var i=0;i<a.length;i++){t={PRODUCT_ID:l.byId("idProd").getValue(),LOCATION_ID:l.byId("idloc").getValue(),CLASS_NUM:a[i].CLASS_NUM,CHAR_NUM:a[i].CHAR_NUM,CHARVAL_NUM:a[i].CHARVAL_NUM};e.PRODCHAR.push(t)}l.getModel("BModel").callFunction("/maintainPartialProdChar",{method:"GET",urlParameters:{FLAG:o,PRODCHAR:JSON.stringify(e.PRODCHAR)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Partial product created/updated successfully");l.onBack()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Error")}})},createIBPProd:function(){sap.ui.core.BusyIndicator.show();l.getModel("IModel").callFunction("/createIBPMasterProd",{method:"GET",urlParameters:{LOCATION_ID:l.byId("idloc").getValue()},success:function(e){sap.ui.core.BusyIndicator.hide()},error:function(e){sap.ui.core.BusyIndicator.hide();l.onBack()}})}})});