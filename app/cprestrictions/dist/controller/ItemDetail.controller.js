sap.ui.define(["cpapp/cprestrictions/controller/BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/Device","sap/ui/core/Fragment"],function(e,a,t,s,i,l,r,o){"use strict";var n,d;return e.extend("cpapp.cprestrictions.controller.ItemDetail",{onInit:function(){n=this;this.bus=sap.ui.getCore().getEventBus();n.oModel=new s;n.classnameModel=new s;n.charnameModel=new s;n.charvalueModel=new s;n.ListModel=new s;this.oModel.setSizeLimit(1e3);n.classnameModel.setSizeLimit(1e3);n.charnameModel.setSizeLimit(1e3);n.charvalueModel.setSizeLimit(1e3);d=n.getOwnerComponent().getModel("oGModel");this._oCore=sap.ui.getCore()},onAfterRendering:function(){d=n.getOwnerComponent().getModel("oGModel");sap.ui.core.BusyIndicator.show();var e=d.getProperty("/Restriction");if(e!==""){this.getModel("BModel").read("/getODHdrRstr",{filters:[new i("RESTRICTION",l.EQ,e)],success:function(e){sap.ui.core.BusyIndicator.hide();n.oTableData=e.results;e.results.map(function(e){e.bFlag=false;return e});n.oModel.setData({results:e.results});n.byId("idDetail").setModel(n.oModel);n.byId("idSearch").setValue("")},error:function(){sap.ui.core.BusyIndicator.hide();a.show("Failed to get data")}});this.getModel("BModel").read("/getClass",{success:function(e){sap.ui.core.BusyIndicator.hide();n.classNameData=e.results},error:function(){sap.ui.core.BusyIndicator.hide();a.show("Failed to get class name data")}})}},onItemSearch:function(e){var a="",t=[];if(e){a=e.getParameter("value")||e.getParameter("newValue")}if(a!==""){t.push(new i({filters:[new i("CLASS_NAME",l.Contains,a),new i("CHAR_NAME",l.Contains,a),new i("CHAR_VALUE",l.Contains,a)],and:false}))}n.byId("idDetail").getBinding("items").filter(t)},onCreateItem:function(){if(!this._valueHelpDialogRestItem){this._valueHelpDialogRestItem=sap.ui.xmlfragment("cpapp.cprestrictions.view.RestrictionItem",this);this.getView().addDependent(this._valueHelpDialogRestItem)}if(!this._valueHelpDialogclassName){this._valueHelpDialogclassName=sap.ui.xmlfragment("cpapp.cprestrictions.view.className",this);this.getView().addDependent(this._valueHelpDialogclassName)}if(!this._valueHelpDialogcharName){this._valueHelpDialogcharName=sap.ui.xmlfragment("cpapp.cprestrictions.view.charName",this);this.getView().addDependent(this._valueHelpDialogcharName)}if(!this._valueHelpDialogcharValue){this._valueHelpDialogcharValue=sap.ui.xmlfragment("cpapp.cprestrictions.view.charValue",this);this.getView().addDependent(this._valueHelpDialogcharValue)}this.oClassName=this._oCore.byId("idClassname");this.oCharName=this._oCore.byId("idCharname");this.oCharValue=this._oCore.byId("idCharval");n._valueHelpDialogclassName.setTitleAlignment("Center");n._valueHelpDialogcharName.setTitleAlignment("Center");n._valueHelpDialogcharValue.setTitleAlignment("Center");this.oClassnameList=this._oCore.byId(this._valueHelpDialogclassName.getId()+"-list");this.oCharnameList=this._oCore.byId(this._valueHelpDialogcharName.getId()+"-list");this.oCharvalueList=this._oCore.byId(this._valueHelpDialogcharValue.getId()+"-list");n.classnameModel.setData({results:n.classNameData});sap.ui.getCore().byId("classNameList").setModel(n.classnameModel);n._valueHelpDialogRestItem.open()},onCloseRestItem:function(){sap.ui.getCore().byId("idClassname").setValue("");sap.ui.getCore().byId("idCharname").setValue("");sap.ui.getCore().byId("idCharval").setValue("");sap.ui.getCore().byId("idClassno").setValue("");sap.ui.getCore().byId("idCharno").setValue("");sap.ui.getCore().byId("idCharvalno").setValue("");n._valueHelpDialogRestItem.close()},handleValueHelp:function(e){var t=e.getParameter("id");if(t.includes("Classname")){n._valueHelpDialogclassName.open()}else if(t.includes("Charname")){if(sap.ui.getCore().byId("idClassname").getValue()){n._valueHelpDialogcharName.open()}else{a.show("Select Class Name")}}else if(t.includes("Charval")){if(sap.ui.getCore().byId("idCharname").getValue()){n._valueHelpDialogcharValue.open()}else{a.show("Select Class Name and Characteristic Name")}}},handleClose:function(e){var a=e.getParameter("id");if(a.includes("className")){n._oCore.byId(this._valueHelpDialogclassName.getId()+"-searchField").setValue("");if(n.oClassnameList.getBinding("items")){n.oClassnameList.getBinding("items").filter([])}}else if(a.includes("charName")){n._oCore.byId(this._valueHelpDialogcharName.getId()+"-searchField").setValue("");if(n.oCharnameList.getBinding("items")){n.oCharnameList.getBinding("items").filter([])}}else if(a.includes("charVal")){n._oCore.byId(this._valueHelpDialogcharValue.getId()+"-searchField").setValue("");if(n.oCharvalueList.getBinding("items")){n.oCharvalueList.getBinding("items").filter([])}}},handleSearch:function(e){var a=e.getParameter("value")||e.getParameter("newValue"),t=e.getParameter("id"),s=[];a=a?a.trim():"";if(t.includes("className")){if(a!==""){s.push(new i({filters:[new i("CLASS_NAME",l.Contains,a),new i("CLASS_NUM",l.Contains,a)],and:false}))}n.oClassnameList.getBinding("items").filter(s)}else if(t.includes("charName")){if(a!==""){s.push(new i({filters:[new i("CHAR_NAME",l.Contains,a),new i("CHAR_NUM",l.Contains,a)],and:false}))}n.oCharnameList.getBinding("items").filter(s)}else if(t.includes("charVal")){if(a!==""){s.push(new i({filters:[new i("CHAR_VALUE",l.Contains,a),new i("CHARVAL_NUM",l.Contains,a)],and:false}))}n.oCharvalueList.getBinding("items").filter(s)}},handleSelection:function(e){n.oGModel=n.getModel("oGModel");var t=e.getParameter("id"),s=e.getParameter("selectedItems"),r,o=[];if(t.includes("className")){n.oClassName=sap.ui.getCore().byId("idClassname");r=e.getParameter("selectedItems");n.oClassName.setValue(r[0].getTitle());sap.ui.getCore().byId("idClassno").setValue(r[0].getDescription());sap.ui.getCore().byId("idCharname").setValue("");sap.ui.getCore().byId("idCharno").setValue("");sap.ui.getCore().byId("idCharval").setValue("");sap.ui.getCore().byId("idCharvalno").setValue("");this.getModel("BModel").read("/getClassChar",{filters:[new i("CLASS_NAME",l.EQ,sap.ui.getCore().byId("idClassname").getValue())],success:function(e){sap.ui.core.BusyIndicator.hide();function a(e,a){var t=new Set;return e.filter(e=>!t.has(e[a])&&t.add(e[a]))}n.charnameModel.setData({results:a(e.results,"CHAR_NAME")});n.oCharnameList.setModel(n.charnameModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("error")}})}else if(t.includes("charName")){n.oCharName=sap.ui.getCore().byId("idCharname");r=e.getParameter("selectedItems");n.oCharName.setValue(r[0].getTitle());sap.ui.getCore().byId("idCharno").setValue(r[0].getDescription());sap.ui.getCore().byId("idCharval").setValue("");sap.ui.getCore().byId("idCharvalno").setValue("");this.getModel("BModel").read("/getClassChar",{filters:[new i("CLASS_NAME",l.EQ,sap.ui.getCore().byId("idClassname").getValue()),new i("CHAR_NAME",l.EQ,sap.ui.getCore().byId("idCharname").getValue())],success:function(e){sap.ui.core.BusyIndicator.hide();function a(e,a){var t=new Set;return e.filter(e=>!t.has(e[a])&&t.add(e[a]))}n.charvalueModel.setData({results:a(e.results,"CHAR_VALUE")});n.oCharvalueList.setModel(n.charvalueModel)},error:function(e,t){sap.ui.core.BusyIndicator.hide();a.show("error")}})}else if(t.includes("charVal")){n.oCharValue=sap.ui.getCore().byId("idCharval");r=e.getParameter("selectedItems");n.oCharValue.setValue(r[0].getTitle());sap.ui.getCore().byId("idCharvalno").setValue(r[0].getDescription())}n.handleClose(e)},onAdd:function(e){var t={RTRCHAR:[]};var s="C";var i=sap.ui.getCore().byId("idClassname").getValue(),l=sap.ui.getCore().byId("idCharname").getValue(),r=sap.ui.getCore().byId("idCharval").getValue();n.aData=[];if(i!==""&&l!==""&&r!==""){n.oData={RESTRICTION:sap.ui.getCore().byId("idrest").getValue(),CLASS_NAME:i,CLASS_NUM:sap.ui.getCore().byId("idClassno").getValue(),CHAR_NAME:l,CHAR_NUM:sap.ui.getCore().byId("idCharno").getValue(),CHAR_VALUE:r,CHARVAL_NUM:sap.ui.getCore().byId("idCharvalno").getValue(),OD_CONDITION:sap.ui.getCore().byId("idODcond").getSelectedKey(),bFLAG:true};var o=this.byId("idDetail").getItems();var d=0;for(var u=0;u<o.length;u++){if(o[u].getCells()[0].getText()===i&&o[u].getCells()[1].getText()===l&&o[u].getCells()[3].getText()===r){d=d+1}}if(d===0){n.oTableData.push(n.oData);n.ListModel.setData({results:n.oTableData});n.byId("idDetail").setModel(n.ListModel);n.onCloseRestItem();n.byId("idUpdateSave").setVisible(true)}else{sap.m.MessageToast.show("Restriction rule is already maintained")}}else{a.show("Please fill all inputs")}},onUpdateItem:function(e){var a=this.byId("idDetail").getItems();var t={RTRCHAR:[]},s;var i="";var l="C";var r={};for(var o=0;o<a.length;o++){r=a[o].getBindingContext().getObject();if(r.bFLAG===true){s={RESTRICTION:r.RESTRICTION,CLASS_NUM:r.CLASS_NUM,CHAR_NUM:r.CHAR_NUM,CHARVAL_NUM:r.CHARVAL_NUM,OD_CONDITION:a[o].getCells()[2].getText(),FLAG:a[o].getCells()[4].getText()};t.RTRCHAR.push(s)}}if(t.RTRCHAR.length>0){n.getModel("BModel").callFunction("/maintainRestrDetail",{method:"GET",urlParameters:{FLAG:l,RTRCHAR:JSON.stringify(t.RTRCHAR)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.maintainRestrDetail);n.onAfterRendering();n.byId("idUpdateSave").setVisible(false)},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Failed to create restriction rule, please try later!")}})}},onDeleteItem:function(e){var a=e.getSource().getParent().getBindingContext().getObject();if(a.OFLAG==="X"){var t=e.getParameters("listItem").id.split("idDetail-")[1];var s=n.ListModel.getData().results;s.splice(t,1);n.ListModel.refresh()}else{var i={RTRCHAR:[]},l;var r="D";l={RESTRICTION:a.RESTRICTION,CLASS_NUM:a.CLASS_NUM,CHAR_NUM:a.CHAR_NUM,CHARVAL_NUM:a.CHARVAL_NUM,CHAR_COUNTER:a.CHAR_COUNTER};i.RTRCHAR.push(l);n.getModel("BModel").callFunction("/maintainRestrDetail",{method:"GET",urlParameters:{FLAG:r,RTRCHAR:JSON.stringify(i.RTRCHAR)},success:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show(e.maintainRestrDetail.message);n.onAfterRendering()},error:function(e){sap.ui.core.BusyIndicator.hide();sap.m.MessageToast.show("Failed to delete restriction rule, please try later!")}})}}})});