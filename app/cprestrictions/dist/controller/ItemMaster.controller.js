sap.ui.define(["cpapp/cprestrictions/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,i,s,o,a,r){"use strict";var l,n;return e.extend("cpapp.cprestrictions.controller.ItemMaster",{onInit:function(){l=this;l.oModel=new i;l.locModel=new i;l.lineModel=new i;this.oModel.setSizeLimit(1e3);this.locModel.setSizeLimit(1e3);this.lineModel.setSizeLimit(1e3);this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")});this._oCore=sap.ui.getCore();if(!this._valueHelpDialogCreateRest){this._valueHelpDialogCreateRest=sap.ui.xmlfragment("cpapp.cprestrictions.view.Restriction",this);this.getView().addDependent(this._valueHelpDialogCreateRest)}this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cprestrictions.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogLine){this._valueHelpDialogLine=sap.ui.xmlfragment("cpapp.cprestrictions.view.LineDialog",this);this.getView().addDependent(this._valueHelpDialogLine)}},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){l=this;n=this.getModel("oGModel");this.oLoc=this.byId("idloc");this.oLine=this.byId("idLine");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oLineList=this._oCore.byId(this._valueHelpDialogLine.getId()+"-list");l._valueHelpDialogLine.setTitleAlignment("Center");l._valueHelpDialogLoc.setTitleAlignment("Center");sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/genRtrHeader",{success:function(e){sap.ui.core.BusyIndicator.hide();l.oModel.setData({results:e.results});l.byId("resList").setModel(l.oModel);if(e.results.length){n.setProperty("/Restriction",e.results[0].RESTRICTION);n.setProperty("/locId",e.results[0].LOCATION_ID);l.byId("resList").setSelectedItem(l.byId("resList").getItems()[0],true);l.onhandlePress()}},error:function(){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}});this.getModel("BModel").read("/getLocation",{success:function(e){l.locModel.setData(e);l.oLocList.setModel(l.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,i){sap.ui.core.BusyIndicator.hide();t.show("error")}})},onhandlePress:function(e){n=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();n.setProperty("/Restriction",t.RESTRICTION);n.setProperty("/locId",t.LOCATION_ID);n.setProperty("/readClass","X")}l.getOwnerComponent().runAsOwner(function(){if(!l.oDetailView){try{l.oDetailView=sap.ui.view({viewName:"cpapp.cprestrictions.view.ItemDetail",type:"XML"});l.bus.publish("flexible","addDetailPage",l.oDetailView);l.bus.publish("nav","toDetailPage",{viewName:l.oDetailView.getViewName()})}catch(e){}}else{l.bus.publish("nav","toDetailPage",{viewName:l.oDetailView.getViewName()})}})},onSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=[];if(t!==""){i.push(new s({filters:[new s("RESTRICTION",o.Contains,t),new s("LOCATION_ID",o.Contains,t),new s("LINE_ID",o.Contains,t)],and:false}))}l.byId("resList").getBinding("items").filter(i)},handleValueHelp:function(e){var i=e.getParameter("id");if(i.includes("loc")){l._valueHelpDialogLoc.open()}else if(i.includes("Line")){if(sap.ui.getCore().byId("idloc").getValue()){l._valueHelpDialogLine.open()}else{t.show("Select Location")}}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){l._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(l.oLocList.getBinding("items")){l.oLocList.getBinding("items").filter([])}}else if(t.includes("Line")){l._oCore.byId(this._valueHelpDialogLine.getId()+"-searchField").setValue("");if(l.oLineList.getBinding("items")){l.oLineList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=e.getParameter("id"),a=[];t=t?t.trim():"";if(i.includes("Loc")){if(t!==""){a.push(new s({filters:[new s("LOCATION_ID",o.Contains,t),new s("LOCATION_DESC",o.Contains,t)],and:false}))}l.oLocList.getBinding("items").filter(a)}else if(i.includes("Line")){if(t!==""){a.push(new s({filters:[new s("LINE_ID",o.Contains,t),new s("LINE_DESC",o.Contains,t)],and:false}))}l.oLineList.getBinding("items").filter(a)}},handleSelection:function(e){l.oGModel=l.getModel("oGModel");var i=e.getParameter("id"),a=e.getParameter("selectedItems"),r,n=[];if(i.includes("Loc")){l.oLoc=sap.ui.getCore().byId("idloc");l.oLine=sap.ui.getCore().byId("idLine");r=e.getParameter("selectedItems");l.oLoc.setValue(r[0].getTitle());l.oLine.setValue("");this.getModel("BModel").read("/getLine",{filters:[new s("LOCATION_ID",o.EQ,r[0].getTitle())],success:function(e){l.lineModel.setData(e);l.oLineList.setModel(l.lineModel)},error:function(e,i){t.show("error")}})}else if(i.includes("Line")){l.oLine=sap.ui.getCore().byId("idLine");r=e.getParameter("selectedItems");l.oLine.setValue(r[0].getTitle())}},onCreateRest:function(e){n.setProperty("/RestFlag","");l._valueHelpDialogCreateRest.open();if(e.getSource().getIcon().includes("add")){sap.ui.getCore().byId("idRestriction").setTitle("Create Restriction");n.setProperty("/RestFlag","C");sap.ui.getCore().byId("idloc").setValue();sap.ui.getCore().byId("idLine").setValue();sap.ui.getCore().byId("idRest").setValue();sap.ui.getCore().byId("idRestDesc").setValue();sap.ui.getCore().byId("idDateRange").setValue();sap.ui.getCore().byId("idloc").setEditable(true);sap.ui.getCore().byId("idLine").setEditable(true);sap.ui.getCore().byId("idRest").setEditable(true);sap.ui.getCore().byId("idloc").setShowValueHelp(true);sap.ui.getCore().byId("idLine").setShowValueHelp(true)}else{sap.ui.getCore().byId("idRestriction").setTitle("Update Restriction");n.setProperty("/RestFlag","E");var t=e.getSource().getParent().getBindingContext().getObject();sap.ui.getCore().byId("idloc").setValue(t.LOCATION_ID);sap.ui.getCore().byId("idLine").setValue(t.LINE_ID);sap.ui.getCore().byId("idRest").setValue(t.RESTRICTION);sap.ui.getCore().byId("idRestDesc").setValue(t.RTR_DESC);var i=t.VALID_FROM;var s=t.VALID_TO;var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM-dd-YYYY"}).format(i);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM-dd-YYYY"}).format(s);var r=o+" "+"To"+" "+a;sap.ui.getCore().byId("idDateRange").setValue(r);sap.ui.getCore().byId("idloc").setEditable(false);sap.ui.getCore().byId("idLine").setEditable(false);sap.ui.getCore().byId("idRest").setEditable(false);sap.ui.getCore().byId("idloc").setShowValueHelp(false);sap.ui.getCore().byId("idLine").setShowValueHelp(false)}},onCloseRest:function(){l._valueHelpDialogCreateRest.close()},onSaveRest:function(e){this._oCore=sap.ui.getCore();var i=this._oCore.byId("idloc").getValue(),s=this._oCore.byId("idLine").getValue(),o=this._oCore.byId("idRest").getValue(),a=this._oCore.byId("idRestDesc").getValue(),r=n.getProperty("/RestFlag"),d=l.getDateFn(this._oCore.byId("idDateRange").getDateValue()),u=l.getDateFn(this._oCore.byId("idDateRange").getSecondDateValue());if(r!==""){l.getModel("BModel").callFunction("/maintainRestrHdr",{method:"GET",urlParameters:{LOCATION_ID:i,LINE_ID:s,RESTRICTION:o,RTR_DESC:a,VALID_FROM:d,VALID_TO:u,Flag:r},success:function(e){sap.ui.core.BusyIndicator.hide();if(r==="C"){t.show("Restriction created successfully")}else{t.show("Successfully updated the restriction")}l.onCloseRest();l.onAfterRendering()},error:function(e){t.show("Failed to create /updaate the Restrictions");sap.ui.core.BusyIndicator.hide()}})}},onDeleteRest:function(e){var i=e.getSource().getParent().getBindingContext().getObject();var s=i.LOCATION_ID,o=i.LINE_ID,a=i.RESTRICTION;l.getModel("BModel").callFunction("/maintainRestrHdr",{method:"GET",urlParameters:{LOCATION_ID:s,LINE_ID:o,RESTRICTION:a,RTR_DESC:"",VALID_FROM:"08/08/2022",VALID_TO:"08/08/2022",Flag:"D"},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.responce);l.onAfterRendering()},error:function(e){t.show("Failed to delete the restriction");sap.ui.core.BusyIndicator.hide()}})},getDateFn:function(e){var t,i;var s=e.getMonth()+1;if(s<10){t="0"+s}else{t=s}if(e.getDate()<10){i="0"+e.getDate()}else{i=e.getDate()}return e=t+"/"+i+"/"+e.getFullYear()}})});