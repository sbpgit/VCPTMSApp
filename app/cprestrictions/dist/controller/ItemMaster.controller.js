sap.ui.define(["cpapp/cprestrictions/controller/BaseController","sap/m/MessageToast","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","sap/ui/Device"],function(e,t,i,s,o,a,n){"use strict";var r,l;return e.extend("cpapp.cprestrictions.controller.ItemMaster",{onInit:function(){r=this;r.oModel=new i;r.locModel=new i;r.lineModel=new i;this.oModel.setSizeLimit(1e3);this.locModel.setSizeLimit(1e3);this.lineModel.setSizeLimit(1e3);this.bus=sap.ui.getCore().getEventBus();this.bus.subscribe("data","refreshMaster",this.refreshMaster,this);this.bus.publish("nav","toBeginPage",{viewName:this.getView().getProperty("viewName")});this._oCore=sap.ui.getCore();if(!this._valueHelpDialogCreateRest){this._valueHelpDialogCreateRest=sap.ui.xmlfragment("cpapp.cprestrictions.view.Restriction",this);this.getView().addDependent(this._valueHelpDialogCreateRest)}this._oCore=sap.ui.getCore();if(!this._valueHelpDialogLoc){this._valueHelpDialogLoc=sap.ui.xmlfragment("cpapp.cprestrictions.view.LocDialog",this);this.getView().addDependent(this._valueHelpDialogLoc)}if(!this._valueHelpDialogLine){this._valueHelpDialogLine=sap.ui.xmlfragment("cpapp.cprestrictions.view.LineDialog",this);this.getView().addDependent(this._valueHelpDialogLine)}},refreshMaster:function(){this.onAfterRendering()},onAfterRendering:function(){r=this;l=this.getModel("oGModel");this.oLoc=this.byId("idloc");this.oLine=this.byId("idLine");this.oLocList=this._oCore.byId(this._valueHelpDialogLoc.getId()+"-list");this.oLineList=this._oCore.byId(this._valueHelpDialogLine.getId()+"-list");r._valueHelpDialogLine.setTitleAlignment("Center");r._valueHelpDialogLoc.setTitleAlignment("Center");sap.ui.core.BusyIndicator.show();this.getModel("BModel").read("/genRtrHeader",{success:function(e){sap.ui.core.BusyIndicator.hide();r.oModel.setData({results:e.results});r.byId("resList").setModel(r.oModel);if(e.results.length){l.setProperty("/Restriction",e.results[0].RESTRICTION);l.setProperty("/locId",e.results[0].LOCATION_ID);r.byId("resList").setSelectedItem(r.byId("resList").getItems()[0],true);r.onhandlePress()}},error:function(){sap.ui.core.BusyIndicator.hide();t.show("Failed to get data")}});this.getModel("BModel").read("/getLocation",{success:function(e){r.locModel.setData(e);r.oLocList.setModel(r.locModel);sap.ui.core.BusyIndicator.hide()},error:function(e,i){sap.ui.core.BusyIndicator.hide();t.show("error")}})},onhandlePress:function(e){l=this.getModel("oGModel");if(e){var t=e.getSource().getSelectedItem().getBindingContext().getObject();l.setProperty("/Restriction",t.RESTRICTION);l.setProperty("/locId",t.LOCATION_ID)}r.getOwnerComponent().runAsOwner(function(){if(!r.oDetailView){try{r.oDetailView=sap.ui.view({viewName:"cpapp.cprestrictions.view.ItemDetail",type:"XML"});r.bus.publish("flexible","addDetailPage",r.oDetailView);r.bus.publish("nav","toDetailPage",{viewName:r.oDetailView.getViewName()})}catch(e){r.oDetailView.onAfterRendering()}}else{r.bus.publish("nav","toDetailPage",{viewName:r.oDetailView.getViewName()})}})},onSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=[];if(t!==""){i.push(new s({filters:[new s("RESTRICTION",o.Contains,t),new s("LOCATION_ID",o.Contains,t),new s("LINE_ID",o.Contains,t)],and:false}))}r.byId("resList").getBinding("items").filter(i)},handleValueHelp:function(e){var i=e.getParameter("id");if(i.includes("loc")){r._valueHelpDialogLoc.open()}else if(i.includes("Line")){if(sap.ui.getCore().byId("idloc").getValue()){r._valueHelpDialogLine.open()}else{t.show("Select Location")}}},handleClose:function(e){var t=e.getParameter("id");if(t.includes("Loc")){r._oCore.byId(this._valueHelpDialogLoc.getId()+"-searchField").setValue("");if(r.oLocList.getBinding("items")){r.oLocList.getBinding("items").filter([])}}else if(t.includes("Line")){r._oCore.byId(this._valueHelpDialogLine.getId()+"-searchField").setValue("");if(r.oLineList.getBinding("items")){r.oLineList.getBinding("items").filter([])}}},handleSearch:function(e){var t=e.getParameter("value")||e.getParameter("newValue"),i=e.getParameter("id"),a=[];t=t?t.trim():"";if(i.includes("Loc")){if(t!==""){a.push(new s({filters:[new s("LOCATION_ID",o.Contains,t),new s("LOCATION_DESC",o.Contains,t)],and:false}))}r.oLocList.getBinding("items").filter(a)}else if(i.includes("Line")){if(t!==""){a.push(new s({filters:[new s("LINE_ID",o.Contains,t),new s("PRODUCT_ID",o.Contains,t)],and:false}))}r.oLineList.getBinding("items").filter(a)}},handleSelection:function(e){r.oGModel=r.getModel("oGModel");var i=e.getParameter("id"),a=e.getParameter("selectedItems"),n,l=[];if(i.includes("Loc")){r.oLoc=sap.ui.getCore().byId("idloc");r.oLine=sap.ui.getCore().byId("idLine");n=e.getParameter("selectedItems");r.oLoc.setValue(n[0].getTitle());r.oLine.setValue("");this.getModel("BModel").read("/getProdlocline",{filters:[new s("LOCATION_ID",o.EQ,n[0].getTitle())],success:function(e){r.lineModel.setData(e);r.oLineList.setModel(r.lineModel)},error:function(e,i){t.show("error")}})}else if(i.includes("Line")){r.oLine=sap.ui.getCore().byId("idLine");n=e.getParameter("selectedItems");r.oLine.setValue(n[0].getTitle())}},onCreateRest:function(e){l.setProperty("/RestFlag","");r._valueHelpDialogCreateRest.open();if(e.getSource().getIcon().includes("add")){sap.ui.getCore().byId("idRestriction").setTitle("Create Restriction");l.setProperty("/RestFlag","C");sap.ui.getCore().byId("idloc").setValue();sap.ui.getCore().byId("idLine").setValue();sap.ui.getCore().byId("idRest").setValue();sap.ui.getCore().byId("idRestDesc").setValue();sap.ui.getCore().byId("idDateRange").setValue()}else{sap.ui.getCore().byId("idRestriction").setTitle("Update Restriction");l.setProperty("/RestFlag","E");var t=e.getSource().getParent().getBindingContext().getObject();sap.ui.getCore().byId("idloc").setValue(t.LOCATION_ID);sap.ui.getCore().byId("idLine").setValue(t.LINE_ID);sap.ui.getCore().byId("idRest").setValue(t.RESTRICTION);sap.ui.getCore().byId("idRestDesc").setValue(t.RTR_DESC);var i=t.VALID_FROM;var s=t.VALID_TO;var o=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM-dd-YYYY"}).format(i);var a=sap.ui.core.format.DateFormat.getDateInstance({pattern:"MM-dd-YYYY"}).format(s);var n=o+" "+"To"+" "+a;sap.ui.getCore().byId("idDateRange").setValue(n)}},onCloseRest:function(){r._valueHelpDialogCreateRest.close()},onSaveRest:function(e){this._oCore=sap.ui.getCore();var i=this._oCore.byId("idloc").getValue(),s=this._oCore.byId("idLine").getValue(),o=this._oCore.byId("idRest").getValue(),a=this._oCore.byId("idRestDesc").getValue(),n=l.getProperty("/RestFlag"),d=r.getDateFn(this._oCore.byId("idDateRange").getDateValue()),u=r.getDateFn(this._oCore.byId("idDateRange").getSecondDateValue());if(n!==""){r.getModel("BModel").callFunction("/maintainRestrHdr",{method:"GET",urlParameters:{LOCATION_ID:i,LINE_ID:s,RESTRICTION:o,RTR_DESC:a,VALID_FROM:d,VALID_TO:u,Flag:n},success:function(e){sap.ui.core.BusyIndicator.hide();if(n==="C"){t.show("Restriction created successfully")}else{t.show("Successfully updated the restriction")}r.onCloseRest();r.onAfterRendering()},error:function(e){t.show("Failed to create /updaate the producr");sap.ui.core.BusyIndicator.hide()}})}},onDeleteRest:function(e){var i=e.getSource().getParent().getBindingContext().getObject();var s=i.LOCATION_ID,o=i.LINE_ID,a=i.RESTRICTION;r.getModel("BModel").callFunction("/maintainRestrHdr",{method:"GET",urlParameters:{LOCATION_ID:s,LINE_ID:o,RESTRICTION:a,RTR_DESC:"",VALID_FROM:"08/08/2022",VALID_TO:"08/08/2022",Flag:"D"},success:function(e){sap.ui.core.BusyIndicator.hide();t.show(e.responce);r.onAfterRendering()},error:function(e){t.show("Failed to delete the restriction");sap.ui.core.BusyIndicator.hide()}})},getDateFn:function(e){var t,i;var s=e.getMonth()+1;if(s<10){t="0"+s}else{t=s}if(e.getDate()<10){i="0"+e.getDate()}else{i=e.getDate()}return e=t+"/"+i+"/"+e.getFullYear()}})});