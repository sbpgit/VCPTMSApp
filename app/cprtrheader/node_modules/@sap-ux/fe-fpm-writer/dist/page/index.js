"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateCustomPage = exports.validateCustomPageConfig = exports.getTemplateRoot = void 0;
const path_1 = require("path");
const mem_fs_1 = require("mem-fs");
const mem_fs_editor_1 = require("mem-fs-editor");
const ejs_1 = require("ejs");
const defaults_1 = require("./defaults");
const validate_1 = require("../common/validate");
/**
 * Validate the UI5 version and if valid return the root folder for the templates to be used.
 *
 * @param ui5Version - optional minimum required UI5 version
 * @returns root folder  containg the templates if the version is supported otherwise throws an error
 */
function getTemplateRoot(ui5Version) {
    if (ui5Version === undefined || ui5Version >= 1.94) {
        return (0, path_1.join)(__dirname, '../../templates/page/1.94');
    }
    else {
        return (0, path_1.join)(__dirname, '../../templates/page/1.84');
    }
}
exports.getTemplateRoot = getTemplateRoot;
/**
 * Add a new route to the provided route array, and update existing routes if necessary (e.g. if targets are defined as arrays for FCL).
 *
 * @param routes existing application routes (from the manifest)
 * @param config configuration object
 */
function updateRoutes(routes, config) {
    const newRoute = {
        name: `${config.entity}${config.name}`
    };
    if (config.navigation) {
        const sourceRoute = routes.find((route) => { var _a; return route.name === ((_a = config.navigation) === null || _a === void 0 ? void 0 : _a.sourcePage); });
        newRoute.pattern = `${sourceRoute === null || sourceRoute === void 0 ? void 0 : sourceRoute.pattern.replace(':?query:', '')}/${config.navigation.navEntity}({${config.navigation.navEntity}Key}):?query:`;
        if ((sourceRoute === null || sourceRoute === void 0 ? void 0 : sourceRoute.target.constructor) === Array) {
            const pages = sourceRoute.target;
            // FCL only supports 3 columns, therefore, show the page in fullscreen if it is the 4th level of navigation
            newRoute.target =
                pages.length > 2 ? [newRoute.name] : [...pages, newRoute.name];
        }
        else {
            newRoute.target = newRoute.name;
        }
    }
    else {
        newRoute.pattern = `${config.entity}({key}):?query:`;
        newRoute.target = newRoute.name;
    }
    routes.push(newRoute);
}
/**
 * Validate the input parameters for the execution of generateCustomAction.
 *
 * @param {string} basePath - the base path
 * @param {CustomPage} config - the custom page configuration
 * @param {Editor} [fs] - the memfs editor instance
 * @returns {Promise<Editor>} the updated memfs editor instance
 */
function validateCustomPageConfig(basePath, config, fs) {
    var _a, _b;
    // common validators
    (0, validate_1.validateVersion)(config.ui5Version);
    if (!fs) {
        fs = (0, mem_fs_editor_1.create)((0, mem_fs_1.create)());
    }
    (0, validate_1.validateBasePath)(basePath, fs);
    // validate config against the manifest
    const manifest = fs.readJSON((0, path_1.join)(basePath, 'webapp/manifest.json'));
    if (config.navigation) {
        if (!((_b = (_a = manifest['sap.ui5']) === null || _a === void 0 ? void 0 : _a.routing) === null || _b === void 0 ? void 0 : _b.targets[config.navigation.sourcePage])) {
            throw new Error(`Could not find navigation source ${config.navigation.sourcePage}!`);
        }
        const route = manifest['sap.ui5'].routing.routes.find((route) => { var _a; return route.name === ((_a = config.navigation) === null || _a === void 0 ? void 0 : _a.sourcePage); });
        if (!route || !route.pattern || !route.target) {
            throw new Error(`Missing or invalid routing configuration for navigation source ${config.navigation.sourcePage}!`);
        }
    }
    return fs;
}
exports.validateCustomPageConfig = validateCustomPageConfig;
/**
 * Add a custom page to an existing UI5 application.
 *
 * @param {string} basePath - the base path
 * @param {CustomPage} data - the custom page configuration
 * @param {Editor} [fs] - the memfs editor instance
 * @returns {Promise<Editor>} the updated memfs editor instance
 */
function generateCustomPage(basePath, data, fs) {
    fs = validateCustomPageConfig(basePath, data, fs);
    const manifestPath = (0, path_1.join)(basePath, 'webapp/manifest.json');
    const config = (0, defaults_1.enhanceData)(data, manifestPath, fs);
    // merge content into existing files
    const root = getTemplateRoot(data.ui5Version);
    // enhance manifest.json
    fs.extendJSON(manifestPath, JSON.parse((0, ejs_1.render)(fs.read((0, path_1.join)(root, `manifest.json`)), config)), (key, value) => {
        if (key === 'routes') {
            updateRoutes(value, config);
        }
        return value;
    });
    // add extension content
    const viewPath = (0, path_1.join)(config.path, `${config.name}.view.xml`);
    if (!fs.exists(viewPath)) {
        fs.copyTpl((0, path_1.join)(root, 'ext/View.xml'), viewPath, config);
    }
    const controllerPath = (0, path_1.join)(config.path, `${config.name}.controller.js`);
    if (!fs.exists(controllerPath)) {
        fs.copyTpl((0, path_1.join)(root, 'ext/Controller.js'), controllerPath, config);
    }
    return fs;
}
exports.generateCustomPage = generateCustomPage;
//# sourceMappingURL=index.js.map