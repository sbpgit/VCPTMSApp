const cds = require('../../../../cds')
const OData = require('../OData')

const { alias2ref } = require('../../../../common/utils/csn')
const { BASE_TENANT } = require('../../../../common/utils/extensibilityUtils')

const SYSTEM_SERVICES = ['cds_r.ExtensibilityService', 'cds_r.ModelProviderService']

function createOdataService(service) {
  const name = (service.definition && service.definition.name) || service.name
  const edm = cds.compile.to.edm(service.model, { service: name })
  alias2ref(service, edm)

  const odataService = new OData(edm, service.model, service.options)
  odataService.addCDSServiceToChannel(service)

  return odataService
}

const { Service } = require('../../../../../../lib/serve/factory')
async function createNewService(name, csn, defaultOptions) {
  const options = Object.assign({}, defaultOptions)
  const service = new Service(name, csn, options)
  if (!service.path) service.path = cds.service.path4(service)
  if (service.init) await service.prepend(service.init)
  if (options.impl) await service.prepend(options.impl)

  return createOdataService(service)
}

const getModelHash = (tenant, features) => {
  if (!features) features = []

  let hash
  if (cds.requires.multitenancy && tenant) {
    hash = tenant
  } else {
    hash = BASE_TENANT
  }

  hash += ':' + features.join(';')

  return hash
}

module.exports = {
  SYSTEM_SERVICES,
  createOdataService,
  createNewService,
  getModelHash
}
