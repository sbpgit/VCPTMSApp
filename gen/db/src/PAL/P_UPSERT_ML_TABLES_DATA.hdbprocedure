PROCEDURE P_UPSERT_CP_VC_HISTORY_TS() LANGUAGE SQLSCRIPT
AS
BEGIN
DELETE FROM "CP_VC_HISTORY_TS";
UPSERT  "CP_VC_HISTORY_TS"
SELECT CONCAT( YEAR (TO_DATE (CHARHDR.CAL_DATE, 'YYYY-MM-DD')), lpad(WEEK (TO_DATE(CHARHDR.CAL_DATE, 'YYYY-MM-DD')),'2','00') ) AS "PeriodOfYear",
	   CHARHDR."LOCATION_ID" AS "Location", CHARHDR."PRODUCT_ID" AS "Product",  CHARHDR."OBJ_TYPE" AS "Type", 
       CONCAT(CHARHDR."OBJ_DEP", CONCAT('_',CHARHDR."OBJ_COUNTER"))  AS "GroupID",
	   CHARHDR."ROW_ID" AS "Row",  CONCAT('att', CHARHDR."ROW_ID") AS "Attribute", 
	   CHARHDR."SUCCESS" AS "CharCount",  CHARHDR."SUCCESS_RATE" AS "CharCountPercent", HDR."SUCCESS" AS "Target", HDR."SUCCESS_RATE" AS "TargetPercent"
FROM "CP_TS_OBJDEP_CHARHDR" CHARHDR
INNER JOIN "CP_TS_OBJDEPHDR" AS HDR ON
CHARHDR."CAL_DATE" = HDR."CAL_DATE" AND CHARHDR."LOCATION_ID" = HDR."LOCATION_ID" 
AND CHARHDR."PRODUCT_ID" = HDR."PRODUCT_ID" AND CHARHDR."OBJ_TYPE" = HDR."OBJ_TYPE"  AND CHARHDR."OBJ_DEP" = HDR."OBJ_DEP"
AND CHARHDR."OBJ_COUNTER" = HDR."OBJ_COUNTER"
--AND CHARHDR.CAL_DATE <= '2022-03-06'
ORDER BY "PeriodOfYear", "Location", "Product","GroupID","Row";
END;