const GlobalConnections = require('../../helper/global_connections');
const HttpHelper = require('../../helper/http_helper');
const { SCOPES } = require('../../../config/constants');

module.exports = () => function () {
    this.on('jobs', async (context) => {
        HttpHelper.checkIfPaaSAuthenticated(context);
        HttpHelper.checkAnyScopeAndRespond(context, SCOPES.DIAGNOSE);
        return GlobalConnections.jobExecutor.diagnose();
    });

    this.on('memory', async (context) => {
        HttpHelper.checkIfPaaSAuthenticated(context);
        HttpHelper.checkAnyScopeAndRespond(context, SCOPES.DIAGNOSE);
        return process.memoryUsage();
    });

    this.on('READ', 'container', async (context) => {
        HttpHelper.checkIfPaaSAuthenticated(context);
        HttpHelper.checkAnyScopeAndRespond(context, SCOPES.DIAGNOSE);
        return GlobalConnections.applicationDataPersistence.getContainerData(context.data.tenantId);
    });

    this.on('READ', 'tables', async (context) => {
        HttpHelper.checkIfPaaSAuthenticated(context);
        HttpHelper.checkAnyScopeAndRespond(context, SCOPES.DIAGNOSE);
        return GlobalConnections.applicationDataPersistence.getTables(context.data.tenantId);
    });
};
