const SecurityHelper = require('../../helper/security_helper');
const Logger = require('../../helper/logger');
const logger = Logger('MODEL');

module.exports = async context => {

    const newTenant = `TENANT-${SecurityHelper.getTenant(context)}-META`;
    if (context.attr) {
        context.attr.identityZone = newTenant;
    } else {
        context.tenant = newTenant;
        context.user.tenant = newTenant; // Major-TODO: remove
    }

    const cds = require('../../cds');
    const db = cds.db;

    const timestamp = new Date().toISOString();
    const content = context.data.content;

    if (logger.hasLevel(logger.LOG_LEVELS.debug)) {
        logger.debug(`Write custom files \n`, content);
    }

    let values = [];
    if(Array.isArray(content)) {
        content.forEach(entry => {
            values.push([
                entry.name,
                entry.category,
                entry.content,
                timestamp,
                entry.name,
                entry.category,
            ])
        });

    } else {
        values = [
            content.name,
            content.category,
            content.content,
            timestamp,
            content.name,
            content.category,
        ];
    }

    const tx = db.transaction(context);

    await tx.run(
        'UPSERT CUSTOM_TENANT_CONTENT(NAME, CATEGORY, CONTENT, TIMESTAMP) VALUES (?, ?, ?, ?) WHERE NAME = ? AND CATEGORY = ?',
        values
    );
};
