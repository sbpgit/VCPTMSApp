const Tenant = require('../../../tenant/index');
const Logger = require('../../../helper/logger');
const logger = Logger('PROVISIONING');
const HttpHelper = require('../../../helper/http_helper');
const SecurityHelper = require('../../../helper/security_helper');


module.exports = () => function () {

    this.on('unsubscribe', async context => {
        logger.debug(`Unsubscribe tenant with:`, context.data);

        HttpHelper.checkAnyScopeAndRespond(context, 'SUBSCRIPTION');

        const subscribedTenantId = context.data.subscribedTenantId;
        if (!subscribedTenantId) {
            if (context._.res) {
                context._.res.status(400, 'No tenant');
            }
            return null;
        }

        const jobID = await Tenant.delete(subscribedTenantId, null,
            context,
            context.data.async ? { noCallback: true} : undefined);

        if (context.data.async) {
            // asynchronous call requires 'accepted'
            context._.res.status(202);
        }
        return jobID ? { jobID } : {};
    });

    this.on('subscribe', async context => {
        logger.debug(`Subscribe tenant with:`, context.data);

        HttpHelper.checkAnyScopeAndRespond(context, 'SUBSCRIPTION');

        logger.debug(`Request headers: `, context._.req ? context._.req.headers : ' None');

        const subscribedTenantId = context.data.subscribedTenantId;

        const jobID = await Tenant.create(subscribedTenantId,
            context,
            context.data.async ? { noCallback: true} : undefined);

        if (context.data.async) {
            // asynchronous call requires 'accepted'
            context._.res.status(202);
        }
        return { jobID };
    });

};
